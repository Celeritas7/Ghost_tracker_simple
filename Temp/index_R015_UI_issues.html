<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ghost Assembly Tracker</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
:root{--bg:#0a0b12;--card:#0d0e18;--inp:#12131e;--bd:#1e2130;--bd2:#2a2d3e;--t1:#e2e4ed;--t2:#8b8fa7;--t3:#6b7094;--t4:#4d5070;--t5:#3d4060;--t6:#2d3050;--ac:#5b6eea;--ac2:#7c5cf6;--grn:#34d399;--red:#f87171;--yel:#fbbf24;--blu:#38bdf8;--org:#fb923c;--pur:#a78bfa;--fm:'Courier New',monospace;--fb:'Segoe UI',system-ui,sans-serif}
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%}
body{background:var(--bg);color:var(--t1);font-family:var(--fb);-webkit-font-smoothing:antialiased;overflow-x:hidden}
.login-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.login-bg{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 30%,rgba(91,110,234,.1) 0%,transparent 70%)}
.login-card{position:relative;z-index:1;width:100%;max-width:380px;text-align:center}
.logo{width:80px;height:80px;border-radius:24px;margin:0 auto 24px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:42px;box-shadow:0 12px 48px rgba(91,110,234,.3)}
.login-title{font-size:26px;font-weight:700;letter-spacing:-.5px;margin-bottom:8px}
.login-sub{color:var(--t3);font-size:14px;margin-bottom:32px;line-height:1.5}
.g-btn{width:100%;padding:16px 24px;border-radius:14px;border:none;background:#4285f4;color:#fff;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;font-family:var(--fb)}
.g-btn:hover{background:#3367d6}
.g-btn svg{width:20px;height:20px}
.divider{display:flex;align-items:center;margin:20px 0;color:var(--t5);font-size:12px}.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bd);margin:0 12px}
.login-err{margin-top:16px;padding:12px 16px;border-radius:10px;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:13px;line-height:1.5;display:none;white-space:pre-line}
.ubar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:1px solid #14152a}
.uname{color:var(--t2);font-size:13px}
.ubadge{font-size:10px;padding:2px 8px;border-radius:10px;margin-left:8px;font-weight:600}
.ubadge-a{background:rgba(91,110,234,.15);color:var(--ac)}.ubadge-t{background:rgba(167,139,250,.15);color:var(--pur)}
.logout{background:none;border:1px solid var(--bd);color:var(--t3);padding:5px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-family:var(--fb)}
.logout:hover{border-color:var(--red);color:var(--red)}
.ld-screen{min-height:80vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px}
.ld-spin{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:28px;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.8}}
.ld-bar-w{width:200px;height:3px;border-radius:2px;background:var(--bd);overflow:hidden}.ld-bar{height:100%;background:var(--ac);border-radius:2px;transition:width .3s}
.sch-screen{min-height:100vh;display:flex;flex-direction:column}
.sch-bg{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 20%,rgba(91,110,234,.06) 0%,transparent 70%)}
.sch-c{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;position:relative;z-index:1}
.sch-in{width:100%;padding:15px 18px;border-radius:14px;border:1px solid var(--bd);background:var(--inp);color:var(--t1);font-size:16px;font-family:var(--fm);outline:none;transition:all .2s}
.sch-in:focus{border-color:var(--ac);box-shadow:0 0 0 3px rgba(91,110,234,.12)}
.sch-in::placeholder{color:var(--t4)}
.pp{width:100%;max-width:400px;padding:8px 14px;border-radius:10px;background:rgba(91,110,234,.06);border:1px solid rgba(91,110,234,.12);margin-bottom:16px;display:flex;align-items:center;gap:8px;font-size:12px}
.br{display:flex;gap:10px;width:100%;max-width:400px}
.btn{flex:1;padding:14px;border-radius:12px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--fb)}
.btn1{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 20px rgba(91,110,234,.25)}
.btn2{border:1px solid var(--bd);background:var(--inp);color:var(--t1)}
.btn2:hover{border-color:var(--ac)}
.ds{padding:4px 10px;border-radius:8px;font-size:10px;font-weight:600;display:inline-flex;align-items:center;gap:6px;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);color:var(--grn)}
.ds-dot{width:6px;height:6px;border-radius:50%;background:var(--grn);animation:bl 2s ease-in-out infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.fbox{margin-top:32px;width:100%;max-width:400px;padding:16px;border-radius:12px;background:var(--card);border:1px solid #14152a}
.fbox-t{font-size:11px;color:var(--t5);font-weight:600;margin-bottom:10px;letter-spacing:1px}
.frow{display:flex;align-items:center;gap:10px;padding:6px 0}
.ftag{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}
.ftag-q{background:rgba(91,110,234,.12);color:var(--ac)}.ftag-t{background:rgba(251,191,36,.12);color:var(--yel)}
.fcode{font-size:12px;color:var(--t2);font-family:var(--fm)}.fdesc{font-size:11px;color:var(--t5);margin-left:auto}
.demo-s{margin-top:20px;text-align:center}.demo-l{font-size:11px;color:var(--t6);margin-bottom:8px}
.demo-chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:400px}
.demo-c{padding:5px 10px;border-radius:6px;border:1px solid #14152a;background:var(--card);color:var(--t3);font-size:11px;font-family:var(--fm);cursor:pointer}.demo-c:hover{border-color:var(--ac);color:var(--ac)}
.rh{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #14152a;background:var(--card);position:sticky;top:0;z-index:100}
.rbk{background:none;border:none;color:var(--ac);font-size:13px;cursor:pointer;padding:6px 10px;font-family:var(--fb)}
.rid{flex:1;text-align:center;font-size:14px;font-weight:700;font-family:var(--fm)}
.rlive{padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;background:rgba(52,211,153,.1);color:var(--grn)}
.tbox{margin:12px 16px 8px;padding:12px 14px;border-radius:10px;background:rgba(91,110,234,.04);border:1px solid rgba(91,110,234,.1)}
.tbox-t{font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px}
.tsteps{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.tstep{padding:3px 8px;border-radius:5px;font-size:12px}
.tstep0{background:rgba(91,110,234,.15);color:var(--ac);font-weight:600}
.tstepN{background:rgba(255,255,255,.03);color:var(--t3)}
.tarr{color:var(--t6);font-size:10px}
.tsum{font-size:11px;color:var(--t4);margin-top:8px}.thl{color:var(--ac);font-family:var(--fm)}.thl2{color:var(--t2);font-family:var(--fm)}
.sw{padding:4px 16px 100px}
.sc{margin-bottom:6px}
.sh{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
.si{font-size:22px;line-height:1}
.sinfo{flex:1;min-width:0}.slbl{font-size:14px;font-weight:600}.ssn{font-size:11px;color:var(--t3);margin-top:2px;font-family:var(--fm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mbdg{padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600}
.schv{font-size:11px;color:var(--t5);transition:transform .2s}.schvO{transform:rotate(180deg)}
.fg{padding-top:4px;padding-bottom:4px}
.fgl{padding:6px 16px;font-size:11px;font-weight:600;opacity:.7;font-family:var(--fm)}
.fr{display:flex;justify-content:space-between;align-items:center;padding:11px 16px;cursor:pointer;border-radius:8px;border-left:3px solid transparent;margin:0 4px}
.fr:hover{background:rgba(255,255,255,.03)}
.frH{background:rgba(91,110,234,.08);border-left-color:var(--ac)}
.fl{display:flex;align-items:center;gap:8px;min-width:0;flex:1}
.flbl{font-size:13px;color:var(--t3);flex-shrink:0}
.frt{display:flex;align-items:center;gap:8px}
.fv{font-size:13px;color:var(--t2);text-align:right;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fvsn{color:var(--t1);font-family:var(--fm);font-weight:600}
.fei{font-size:10px;color:var(--t5)}
.ib{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:600;flex-shrink:0}
.ib-l{background:rgba(91,110,234,.12);color:var(--ac)}.ib-c{background:rgba(251,191,36,.12);color:var(--yel)}.ib-d{background:rgba(56,189,248,.12);color:var(--blu)}
.ckd{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px}
.ckP{background:rgba(52,211,153,.15);border:1.5px solid var(--grn);color:var(--grn)}
.ckF{background:rgba(248,113,113,.1);border:1.5px solid rgba(248,113,113,.35);color:var(--red)}
.escreen{min-height:100vh;display:flex;flex-direction:column}
.eh{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #14152a;background:var(--card)}
.ecn{background:none;border:none;color:var(--red);font-size:13px;cursor:pointer;padding:6px 10px;font-family:var(--fb)}
.esv{background:none;border:none;color:var(--ac);font-size:13px;cursor:pointer;padding:6px 10px;font-weight:600;font-family:var(--fb)}
.ebody{flex:1;display:flex;flex-direction:column;align-items:center;padding:24px 24px 24px}
.eold{padding:8px 16px;border-radius:8px;margin-bottom:24px;background:rgba(248,113,113,.04);border:1px solid rgba(248,113,113,.1);font-family:var(--fm);font-size:13px;color:var(--red);text-decoration:line-through;opacity:.5;width:100%;max-width:380px;text-align:center}
.etin{width:100%;padding:16px 18px;border-radius:12px;border:2px solid var(--ac);background:var(--inp);color:var(--t1);font-size:18px;font-family:var(--fm);font-weight:600;outline:none;text-align:center;box-shadow:0 0 0 4px rgba(91,110,234,.1)}
.edin{width:100%;padding:16px 18px;border-radius:12px;border:2px solid var(--blu);background:var(--inp);color:var(--t1);font-size:18px;font-family:var(--fm);font-weight:600;outline:none;text-align:center;box-shadow:0 0 0 4px rgba(56,189,248,.1);color-scheme:dark}
.dqb{display:flex;gap:8px;margin-top:12px}.dqbb{flex:1;padding:10px;border-radius:8px;border:1px solid var(--bd);background:var(--inp);color:var(--blu);font-size:13px;cursor:pointer;font-family:var(--fb)}
.do{padding:12px 16px;border-radius:10px;cursor:pointer;border:1px solid var(--bd);background:var(--inp);display:flex;align-items:center;justify-content:space-between}.doS{border:2px solid var(--ac);background:rgba(91,110,234,.1)}
.doi{display:flex;align-items:center;gap:10px}
.dor{width:20px;height:20px;border-radius:10px;border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center}.dorS{border-color:var(--ac)}
.dorD{width:10px;height:10px;border-radius:5px;background:var(--ac)}
.dot{font-size:14px;font-family:var(--fm);font-weight:500;color:var(--t2)}.dotS{color:var(--t1)}
.doCur{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(251,191,36,.1);color:var(--yel);font-weight:600}
.savb{margin-top:28px;padding:14px 40px;border-radius:12px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--fb)}
.savA{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 20px rgba(91,110,234,.2)}
.savI{background:var(--bd);color:var(--t4);cursor:default}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.toast-s{background:#121e16;border:1px solid rgba(52,211,153,.2);color:var(--grn)}
.toast-e{background:#1e1214;border:1px solid rgba(248,113,113,.2);color:var(--red)}
.rfb{position:fixed;bottom:20px;right:20px;z-index:100;width:48px;height:48px;border-radius:14px;border:1px solid var(--bd);background:var(--card);color:var(--t3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.rfb:hover{border-color:var(--ac);color:var(--ac)}
.rfS{animation:spin 1s linear infinite}@keyframes spin{100%{transform:rotate(360deg)}}
.dbg{margin:12px 16px;padding:14px;border-radius:10px;background:var(--inp);border:1px solid var(--bd);font-size:11px;line-height:1.7;max-height:400px;overflow-y:auto;font-family:var(--fm);color:var(--t3)}
.dbg b{color:var(--yel)}.dbg code{color:var(--ac);background:rgba(91,110,234,.08);padding:1px 4px;border-radius:3px}
.dbgbtn{padding:6px 14px;border-radius:8px;border:1px solid var(--yel);background:transparent;color:var(--yel);font-size:11px;cursor:pointer;font-family:var(--fb);margin-left:8px}
.err-b{margin:16px;padding:16px;border-radius:12px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);color:var(--red);font-size:13px;line-height:1.5}
.err-b code{display:block;margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(248,113,113,.05);font-family:var(--fm);font-size:11px;word-break:break-all;color:var(--t2)}
/* ECN Settings button */
.ecnbtn{padding:5px 12px;border-radius:6px;border:1px solid var(--ac);background:transparent;color:var(--ac);font-size:11px;cursor:pointer;font-family:var(--fb);font-weight:600;transition:all .15s}
.ecnbtn:active{background:var(--ac);color:#fff}
/* ECN Settings page */
.ecns-sec{margin-bottom:8px;border-radius:10px;overflow:hidden;border:1px solid var(--bd)}
.ecns-hdr{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--inp);cursor:pointer}
.ecns-body{background:var(--card);padding:4px 0}
.ecns-row{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .1s}
.ecns-row:active{background:rgba(91,110,234,.06)}
.ecns-tog{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;transition:all .15s}
.ecns-on{background:var(--ac);color:#fff;border:2px solid var(--ac)}
.ecns-off{background:transparent;border:2px solid var(--bd2);color:transparent}
.ecns-fname{font-size:12px;color:var(--t2);font-family:var(--fm);word-break:break-all;line-height:1.4}
/* ECN sub-section in result cards */
.ecn-sub{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;border-top:1px dashed rgba(91,110,234,.15)}
.ecn-sub-icon{font-size:14px}
.ecn-sub-label{font-size:11px;font-weight:700;letter-spacing:.5px;color:var(--ac)}
.ecn-sub-body{border-top:1px solid var(--bd)}
.ecn-flbl{font-size:11px!important;color:var(--t4)!important}
/* Chip grid */
.chipgrid{display:flex;flex-wrap:wrap;gap:6px}
.uchip{display:flex;align-items:center;gap:4px;padding:8px 10px;border-radius:10px;border:1.5px solid var(--bd);background:var(--inp);cursor:pointer;transition:all .12s;-webkit-tap-highlight-color:transparent}
.uchip:active{transform:scale(.95)}
.uchip-on{border-width:2px}
.uchip-i{font-size:14px}
.uchip-l{font-size:11px;font-weight:600;color:var(--t2);font-family:var(--fb)}
.uchip-on .uchip-l{color:inherit}
.btn3{flex:1;padding:14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;border:1px solid var(--bd);background:var(--inp);color:var(--t3);font-family:var(--fb);transition:all .15s}
.btn3:active{background:var(--bd)}
/* Compliance indicators */
.fr-warn{background:rgba(248,113,113,.04)!important;border-left:3px solid var(--red)!important}
.comp-tag{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(248,113,113,.1);color:var(--red);font-weight:600;letter-spacing:.3px;white-space:nowrap}
.comp-badge{padding:2px 8px;border-radius:6px;background:rgba(248,113,113,.12);color:var(--red);font-size:10px;font-weight:700;margin-left:auto;white-space:nowrap}
/* Compliance settings page */
.comp-sec{margin-bottom:8px;border-radius:10px;overflow:hidden;border:1px solid var(--bd)}
.comp-sec-hdr{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--inp);cursor:pointer}
.comp-sec-body{background:var(--card);padding:4px 0}
.comp-row{display:flex;align-items:center;gap:10px;padding:8px 14px}
.comp-fname{font-size:12px;color:var(--t2);font-family:var(--fm);min-width:120px;flex-shrink:0}
.comp-input{flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--bd);background:var(--inp);color:var(--t1);font-family:var(--fm);font-size:13px;outline:none}
.comp-input:focus{border-color:var(--ac)}
/* Bulk edit */
.bulk-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--grn);background:rgba(52,211,153,.06);color:var(--grn);font-size:11px;cursor:pointer;font-family:var(--fb);font-weight:600;transition:all .15s}
.bulk-btn:active{background:var(--grn);color:#fff}
.bulk-step{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:12px 16px;border-radius:10px;background:rgba(91,110,234,.06);border:1px solid rgba(91,110,234,.12)}
.bulk-step-n{width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.bulk-step-t{font-size:13px;color:var(--t2)}
.bulk-sec-hdr{display:flex;align-items:center;gap:8px;padding:10px 0 6px;border-top:1px solid var(--bd);margin-top:8px}
.bulk-sec-hdr:first-child{border-top:none;margin-top:0}
.bulk-field{display:flex;align-items:center;gap:8px;padding:10px 14px;margin:3px 0;border-radius:8px;border:1px solid var(--bd);background:var(--inp);cursor:pointer;transition:all .12s}
.bulk-field:active{background:rgba(91,110,234,.06);border-color:var(--ac)}
.bulk-field-type{font-size:14px}
.bulk-field-name{flex:1;font-size:12px;color:var(--t2);font-family:var(--fm)}
.bulk-units-hdr{font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin:12px 0 6px}
.bulk-unit{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;margin:2px 0;border-radius:6px;border:1px solid var(--bd);background:var(--card)}
.bulk-unit-sn{font-size:12px;font-family:var(--fm);color:var(--t2);font-weight:500}
.bulk-new-hdr{font-size:10px;color:var(--ac);font-weight:600;letter-spacing:1px;margin:16px 0 8px}
.bulk-val{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 12px;border-radius:12px;border:1.5px solid var(--bd);background:var(--inp);cursor:pointer;transition:all .12s}
.bulk-val:active{transform:scale(.97)}
.bulk-val-on{border-width:2px}
.bulk-change{padding:4px 10px;border-radius:6px;border:1px solid var(--bd);background:var(--inp);color:var(--t3);font-size:10px;cursor:pointer;font-family:var(--fb);margin-left:auto}
/* UI animations */
.sc{animation:fadeSlide .2s ease-out}
@keyframes fadeSlide{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
/* Compliance bar */
.comp-bar{margin:8px 16px;padding:10px 14px;border-radius:10px;background:var(--inp);border:1px solid var(--bd)}
.comp-bar-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.comp-bar-track{height:4px;border-radius:2px;background:var(--bd);overflow:hidden}
.comp-bar-fill{height:100%;border-radius:2px;transition:width .5s ease-out}
.fg{animation:fadeIn .15s ease-out}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.fr{transition:background .1s,border-color .1s}
.fr:active{background:rgba(91,110,234,.06)!important}
.sh{transition:background .12s}
.sh:active{opacity:.85}
.toast{animation:toastIn .25s ease-out}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
/* Enhanced interactivity */
.uchip{transition:all .15s ease;-webkit-tap-highlight-color:transparent}
.uchip:hover{background:rgba(255,255,255,.03);border-color:var(--bd2)}
.uchip-on{box-shadow:0 0 12px rgba(91,110,234,.15)}
.bulk-field{transition:all .15s ease;-webkit-tap-highlight-color:transparent}
.bulk-field:hover{border-color:var(--ac);background:rgba(91,110,234,.03)}
.bulk-unit{transition:all .12s ease;-webkit-tap-highlight-color:transparent}
.bulk-unit:active{transform:scale(.99)}
.savb{transition:all .2s ease}
.savA:active{transform:scale(.97);box-shadow:0 2px 12px rgba(91,110,234,.3)}
.btn1{transition:all .15s}
.btn1:active{transform:scale(.97);box-shadow:0 2px 12px rgba(91,110,234,.3)}
.ecnbtn{transition:all .12s;-webkit-tap-highlight-color:transparent}
.ecnbtn:hover{background:rgba(91,110,234,.08)}
.comp-badge{animation:badgePulse 2s ease-in-out infinite}
@keyframes badgePulse{0%,100%{opacity:1}50%{opacity:.7}}
.ecn-sub-body{animation:slideDown .2s ease-out}
@keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:2000px}}
.do{transition:all .12s ease;-webkit-tap-highlight-color:transparent}
.do:active{transform:scale(.98)}
.bulk-val{-webkit-tap-highlight-color:transparent}
/* Bulk chip input */
.bulk-chip-box{display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:10px 14px;border-radius:12px;border:2px solid rgba(91,110,234,.2);background:var(--inp);min-height:50px;cursor:text;transition:border-color .15s}
.bulk-chip-box:focus-within{border-color:var(--ac);box-shadow:0 0 0 3px rgba(91,110,234,.08)}
.bulk-chip{display:flex;align-items:center;gap:4px;padding:4px 6px 4px 10px;border-radius:6px;border:1px solid;font-size:12px;font-weight:600;font-family:var(--fm);animation:chipIn .15s ease-out}
.bulk-chip-x{margin-left:2px;cursor:pointer;font-size:10px;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(248,113,113,.1);color:var(--red);transition:background .1s}
.bulk-chip-x:hover{background:rgba(248,113,113,.25)}
.bulk-num-input{flex:1;min-width:80px;border:none;outline:none;background:transparent;color:var(--t1);font-size:14px;font-family:var(--fm);padding:4px 0}
@keyframes chipIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.rbk{transition:color .12s}
.rbk:active{color:var(--ac2)}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ===== CONFIG =====
const CONFIG={
  CLIENT_ID:'1088099187141-ut0dn0scqt3h99htf3rg8gsrg2oo1ad8.apps.googleusercontent.com',
  SCOPES:'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
  SHEET_ID:'1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M',
  APPROVED_USERS:{
    'anikettelexistence@gmail.com':{name:'Aniket',team:'production',isAdmin:true},
    'igarashi@tx-inc.com':{name:'Igarashi',team:'production',isAdmin:false},
    'niidome@tx-inc.com':{name:'Niidome',team:'production',isAdmin:false},
  },
  TABS:{ghosts:'00_GHOST',lMotors:'01_L-motor',a12Motors:'02_A12-motor',a35Motors:'03_A35-motor',a4Motors:'04_A4-motor',mobileBases:'05_Mobile Base',pillars:'06_Pillar',headBodies:'07_Head & Body',grippers:'08_Gripper',arms:'09_Arm',deployKits:'10_Deploy Kit'},
};

// ===== FIREBASE =====
let db=null;
try{
  const fbApp=firebase.initializeApp({
    apiKey:"AIzaSyBigwohpQQU3TKImuGL3StJ-eWtX6OKFxI",
    authDomain:"ghost-tracker-app-1b1d0.firebaseapp.com",
    projectId:"ghost-tracker-app-1b1d0",
    storageBucket:"ghost-tracker-app-1b1d0.firebasestorage.app",
    messagingSenderId:"859247887158",
    appId:"1:859247887158:web:ebefbd4c880ca15958a997"
  });
  db=firebase.firestore();
  console.log('[Firebase] Initialized OK');
}catch(e){console.warn('[Firebase] Init failed:',e);}

// ECN visibility settings: {dataKey: Set of visible ECN column names}
let ECN_SETTINGS={};
let ECN_LOADED=false;

async function loadECNSettings(){
  if(!db){ECN_LOADED=true;return;}
  try{const doc=await db.collection('ghost-tracker').doc('ecn-settings').get();
    if(doc.exists){const d=doc.data();Object.keys(d).forEach(k=>{ECN_SETTINGS[k]=new Set(d[k]||[]);});ECN_LOADED=true;console.log('[ECN] Loaded:',d);}
    else{ECN_SETTINGS={};ECN_LOADED=true;}
  }catch(e){console.warn('[ECN] Load failed:',e);ECN_LOADED=true;}}

async function saveECNSettings(){
  if(!db){showToast('Firestore not available','error');return;}
  try{const d={};Object.keys(ECN_SETTINGS).forEach(k=>{d[k]=[...ECN_SETTINGS[k]];});
    await db.collection('ghost-tracker').doc('ecn-settings').set(d);
    showToast('ECN settings saved');
  }catch(e){showToast('Save failed: '+e.message,'error');}}

// Detect if a column name is an ECN field
function isECNField(f){
  if(/^(GP-)?ECN-/.test(f))return true;
  if(f.includes('ECN')&&!/ECB/.test(f))return true;
  if(/^(i55|i61|i64|issue\d|RCM)/.test(f))return true;
  if(/ãƒªãƒ¯ãƒ¼ã‚¯|ãƒ†ã‚¹ãƒˆå¾…|ãƒ†ãƒ¼ãƒ—|æ³¨æ„|425|MP2/.test(f))return true;
  if(/ç‚¹æ¤œ|ä¿®æ­£|å¤‰æ›´|è¿½åŠ |å‰Šã‚‹|å¯¾ç­–|ç·©ã¿|é˜²æ°´|ã‚±ãƒ¼ãƒ–ãƒ«|ã‚°ãƒªã‚¹|ã°ã­|ã¯ã‚“ã |ãƒžãƒ¼ã‚­ãƒ³ã‚°|ãƒ”ãƒ³|åˆæ ¼/.test(f))return true;
  if(/Bracket|Dummy|STOCK|æˆåž‹/.test(f))return true;
  if(/ã­ã˜|ã‚´ãƒ |ãƒ¬ãƒ¼ãƒ«|ãƒ¬ãƒ³ã‚¸|ãƒ­ãƒƒã‚¯|ã‚³ãƒã‚¯ã‚¿|é˜²å¡µ|ãƒ¯ãƒƒã‚·ãƒ£|ã‚¹ãƒšãƒ¼ã‚µ|ã‚«ãƒãƒ¼/.test(f))return true;
  return false;
}

function getECNFields(dataKey){const rows=DATA[dataKey];if(!rows||!rows.length)return[];return Object.keys(rows[0]).filter(f=>isECNField(f));}
function isECNVisible(dataKey,field){return ECN_SETTINGS[dataKey]&&ECN_SETTINGS[dataKey].has(field);}

// ===== COMPLIANCE RULES =====
let COMP_RULES={latestFW:{},requiredChecks:{},requiredFields:{},requiredECN:{}};

async function loadCompRules(){
  if(!db)return;
  try{const doc=await db.collection('ghost-tracker').doc('compliance-rules').get();
    if(doc.exists){COMP_RULES={latestFW:{},requiredChecks:{},requiredFields:{},requiredECN:{},...doc.data()};console.log('[COMP] Loaded:',COMP_RULES);}
  }catch(e){console.warn('[COMP] Load failed:',e);}}

async function saveCompRules(){
  if(!db){showToast('Firestore not available','error');return;}
  try{await db.collection('ghost-tracker').doc('compliance-rules').set(COMP_RULES);showToast('Compliance rules saved');
  }catch(e){showToast('Save failed: '+e.message,'error');}}

// Check a single field for compliance. Returns null (ok) or string (reason)
function checkFieldComp(dataKey,field,value){
  const v=(value||'').trim();
  // Latest FW check - match field name partially
  // Skip if value looks like a boolean (field used as checkbox in this sheet, not a FW version)
  for(const[fwField,latest]of Object.entries(COMP_RULES.latestFW||{})){
    if(field===fwField||field.startsWith(fwField)){
      if(/^(TRUE|FALSE|true|false|1|0)$/i.test(v))break; // boolean value = not a FW field here
      if(!v)return'empty';
      if(v!==latest)return`not latest (${latest})`;
      return null;
    }
  }
  // Required checkbox
  const reqC=COMP_RULES.requiredChecks?.[dataKey]||[];
  if(reqC.includes(field)){
    if(!/^(TRUE|true|1|OK|âœ“|done)$/i.test(v))return'not checked';
    return null;
  }
  // Required field
  const reqF=COMP_RULES.requiredFields?.[dataKey]||[];
  if(reqF.includes(field)){
    if(!v)return'required';
    return null;
  }
  // Required ECN â€” any non-empty value means applied (dates, text, TRUE all count)
  const reqE=COMP_RULES.requiredECN?.[dataKey]||[];
  if(reqE.includes(field)){
    if(!v)return'ECN not applied';
    return null;
  }
  return null;
}

// Check all fields in a section, return count of issues (including ECN)
function countSectionIssues(dataKey,items){
  if(!items||!items.length)return 0;
  let issues=0;
  items.forEach(item=>{
    Object.entries(item).forEach(([k,v])=>{
      if(k==='_rowIdx')return;
      if(checkFieldComp(dataKey,k,v))issues++;
    });
  });
  return issues;
}

// Auto-detect FW fields from loaded data
function detectFWFields(){
  const fwFields=new Set();
  Object.values(DATA).forEach(rows=>{if(!rows||!rows.length)return;
    Object.keys(rows[0]).forEach(k=>{if(/FW\b/i.test(k)&&!/ECB/.test(k))fwFields.add(k);});
  });
  return[...fwFields];
}

// Auto-detect checkbox fields
function detectCheckboxFields(){
  const checks={};
  Object.entries(DATA).forEach(([dk,rows])=>{if(!rows||!rows.length)return;
    const cFields=Object.keys(rows[0]).filter(k=>{
      if(k==='_rowIdx')return false;
      return rows.some(r=>/^(TRUE|true|1|OK|âœ“|âœ—|done|no|FALSE|false|0)$/i.test((r[k]||'').trim()));
    });
    if(cFields.length)checks[dk]=cFields;
  });
  return checks;
}

// Auto-detect date/required fields
function detectFieldsByKey(){
  const fields={};
  Object.entries(DATA).forEach(([dk,rows])=>{if(!rows||!rows.length)return;
    fields[dk]=Object.keys(rows[0]).filter(k=>k!=='_rowIdx'&&!shouldSkipField(k)&&!isECNField(k));
  });
  return fields;
}

// ===== AUTH =====
let accessToken=null,tokenClient=null,currentUser={name:'',email:'',isAdmin:false,isGuest:false,team:''};

// ===== PARSING =====
const ASSEMBLY_CODES={GST:{type:'ghost',label:'Ghost'},MBB:{type:'mobileBase',label:'Mobile Base'},PLR:{type:'pillar',label:'Pillar'},HBD:{type:'headBody',label:'Head & Body'},GPR:{type:'gripper',label:'Gripper'},ARM:{type:'arm',label:'Arm'},DPK:{type:'deployKit',label:'Deploy Kit'},LAC:{type:'lMotor',label:'L-Motor'},A12:{type:'a12Motor',label:'A12 Motor'},A35:{type:'a35Motor',label:'A35 Motor'},A4A:{type:'a4Motor',label:'A4 Motor'}};
const SHORTHAND_MAP={GH:'GST',GHOST:'GST',GST:'GST',MB:'MBB',MBB:'MBB',PL:'PLR',PLR:'PLR',PILLAR:'PLR',HB:'HBD',HBD:'HBD',HEAD:'HBD',GR:'GPR',GPR:'GPR',GRIP:'GPR',ARM:'ARM',DPK:'DPK',DK:'DPK',LM:'LAC',LAC:'LAC',A12:'A12',A35:'A35',A4:'A4A',A4A:'A4A',PDB:'PDB',IOB:'IOB',MDB:'MDB',BRK:'BRK',BAT:'BAT'};
function parseInput(raw){const i=raw.trim();if(!i)return null;const f=i.match(/^GT\d{3}-([A-Z0-9]{2,3})-(\d{3,5})$/i);if(f){const c=f[1].toUpperCase(),n=parseInt(f[2]),a=ASSEMBLY_CODES[c];if(a)return{...a,num:n,fullSN:i.toUpperCase(),inputType:'qr'};}if(/^\d{5,6}$/.test(i))return{type:'galina',label:'GALINA',num:parseInt(i),fullSN:i,inputType:'manual'};const s=i.match(/^([A-Z]{2,6})[- ]?(\d+)$/i);if(s){const p=s[1].toUpperCase(),n=parseInt(s[2]),c=SHORTHAND_MAP[p];if(c&&ASSEMBLY_CODES[c])return{...ASSEMBLY_CODES[c],num:n,fullSN:`${p}-${n}`,inputType:'shorthand'};if(['PDB','IOB','MDB','BRK','BAT'].includes(p))return{type:p.toLowerCase(),label:p,num:n,fullSN:`${p}-${n}`,inputType:'shorthand'};}return null;}

// ===== SECTION CONFIG =====
const SC={ghost:{icon:'ðŸ‘»',label:'Ghost',color:'#5b6eea',bg:'#151728'},mobileBase:{icon:'ðŸ›ž',label:'Mobile Base',color:'#34d399',bg:'#13201a'},mbMotors:{icon:'âš™ï¸',label:'L-Motors (MB)',color:'#6ee7b7',bg:'#131d19'},pillar:{icon:'ðŸ›ï¸',label:'Pillar',color:'#a78bfa',bg:'#1a1528'},plMotors:{icon:'âš™ï¸',label:'L-Motor (Pillar)',color:'#6ee7b7',bg:'#131d19'},headBody:{icon:'ðŸ§ ',label:'Head & Body',color:'#f87171',bg:'#201414'},arm:{icon:'ðŸ¦¾',label:'Arm',color:'#fbbf24',bg:'#201c12'},armA12:{icon:'âš™ï¸',label:'A12 Motors',color:'#6ee7b7',bg:'#131d19'},armA35:{icon:'âš™ï¸',label:'A35 Motor',color:'#6ee7b7',bg:'#131d19'},armA4:{icon:'âš™ï¸',label:'A4 Motor',color:'#6ee7b7',bg:'#131d19'},gripper:{icon:'ðŸ¤',label:'Gripper',color:'#38bdf8',bg:'#121a20'},deployKit:{icon:'ðŸ“¦',label:'Deploy Kit',color:'#fb923c',bg:'#1e1812'}};
const FIELD_LABELS={'S/N':'S/N','SW':'SW','Endpoint':'Endpoint','SoraFW':'Sora FW','Sora FW':'Sora FW','FW':'FW','Sora Time zone':'Sora TZ','Mobile Base':'Mobile Base S/N','Pillar':'Pillar S/N','Body&Head':'Head & Body S/N','Arm':'Arm S/N','Deploy Kit':'Deploy Kit S/N','æ‰‹é †æ›¸ ver.':'SOP Ver.','SOP ver.':'SOP Ver.','ä½¿ç”¨SOP ver.':'SOP Ver.','M-BOM ver.':'M-BOM Ver.','çµ„ç«‹äººå“¡':'Assembler','æ™‚é–“':'Time','å®Œäº†æ—¥':'Completed','å‚™è€ƒ':'Notes','L1 motor S/N':'L1 Motor','L2 motor S/N':'L2 Motor','L3 motor S/N':'L3 Motor','PDB S/N':'PDB S/N','PDB FW':'PDB FW','ECB Ver.':'ECB Ver.','L2 belt tension [N]':'L2 Belt (N)','L3 belt tension (N)':'L3 Belt (N)','BRK S/N':'Brake S/N','GALINA S/N':'GALINA S/N','AGX image':'AGX Image','IP':'IP Address','IOB S/N':'IOB S/N','IOB FW':'IOB FW','A1 motor S/N':'A1 Motor','A2 motor S/N':'A2 Motor','A3 motor S/N':'A3 Motor','A4 motor S/N':'A4 Motor','A5 motor S/N':'A5 Motor','Gripper S/N':'Gripper S/N','BAT S/N':'Battery S/N','A4 belt tension':'A4 Belt','MDB S/N':'MDB S/N','MDB FW':'MDB FW','enc':'Encoder','mod':'Mod','æŠµæŠ— cNï½¥m':'Resistance','GANTRYé•·ã•':'Gantry Length','pick up config':'Pickup Config','fail status':'Fail Status','fail status/comment':'Fail Status','ä½¿ç”¨':'Usage','éƒ¨å“å‡ºåº«æ—¥':'Parts Issue','éƒ¨å“ å‡ºåº«æ—¥':'Parts Issue','çµ„ç«‹ æ™‚é–“':'Assy Time','çµ„ç«‹æ™‚é–“':'Assy Time','stator frame':'Stator Frame','rotor frame':'Rotor Frame','motor cap':'Motor Cap','æ¢±åŒ…å®Œäº†':'Packing Done','å®Œäº†':'Done','setup':'Setup','token':'Token','é…ç½®':'Placement','å‡ºåº«æ—¥':'Issue Date','éƒ¨ç½²':'Dept','ç›®çš„':'Purpose','ä½¿ç”¨æ‰‹é †æ›¸ ver.':'SOP Ver.'};
function shouldSkipField(f){if(f==='#'||f==='_rowIdx')return true;if(/^\d+$/.test(f))return true;if(/^(å…±é€š|ç‰¹å®š)$/.test(f))return true;if(/^\d+\.\d+\.\d+/.test(f))return true;if(f.startsWith('__'))return true;if(/^(ACT|ecn-)/.test(f))return true;
  // Row 1 group headers (from merged cells)
  if(/^(SWé–¢é€£|æ§‹æˆ|å‡ºåº«å…ˆ|ãƒ­ãƒœãƒƒãƒˆå‡ºè·æº–å‚™|ARMä»¥å¤–)$/.test(f))return true;
  if(f==='ARM'&&f!=='Arm')return true;
  // ECN fields handled separately in ECN sub-section
  if(isECNField(f))return true;
  return false;}

// ===== VALIDATION (from actual Google Sheets data validation rules) =====
const V={};

// Shared SOP version list
const SOP_VERS=['v2.0.0','v2.0.3','v2.4.2','v2.5.0','v2.6.0','v2.7.2','v2.8.2','v2.9.0','v2.9.2','v2.11.0','v2.11.1','v2.13.1'];
const USAGE_OPTS=['new','old'];
const DONE_OPTS=['done','no'];
const PDB_FW=['1.1.4.0','old','ãƒ†ã‚¹ãƒˆå¾…ã¡'];
const MDB_FW=['2.0.0.0','1.1.4.1','1.1.4.0','262144','none','unknown'];
const ECB_VERS=['TX_ECB_V1','TX_ECB_V2'];
const IOB_FW_HB=['1.1.4.0','1.1.4.1','IOB 2.0.0.0','bootloader / iob','bootloader / IOB','bootloader_stable / downgrade_IOB','unknown'];
const IOB_FW_GR=['1.1.4.0','IOB 2.0.0.0','GPR 2.0.0.0','bootloader/iob','bootloader_stable/downgrade_IOB','unknown'];
const MOTOR_FW=['2.0.0.0','1.1.4.1','1.1.4.0','20240403','unknown'];

// Ghost
V['ghost.å®Œäº†æ—¥']={type:'date'};

// Mobile Base
V['mobileBase.PDB FW']={type:'dropdown',options:PDB_FW};
V['mobileBase.ECB Ver.']={type:'dropdown',options:ECB_VERS};
V['mobileBase.ä½¿ç”¨æ‰‹é †æ›¸ ver.']={type:'dropdown',options:SOP_VERS};
V['mobileBase.æ‰‹é †æ›¸ ver.']={type:'dropdown',options:SOP_VERS};
V['mobileBase.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['mobileBase.å®Œäº†æ—¥']={type:'date'};

// Pillar
V['pillar.SOP ver.']={type:'dropdown',options:SOP_VERS};
V['pillar.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['pillar.å®Œäº†æ—¥']={type:'date'};

// Head & Body
V['headBody.IOB FW']={type:'dropdown',options:IOB_FW_HB};
V['headBody.ä½¿ç”¨SOP ver.']={type:'dropdown',options:SOP_VERS};
V['headBody.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['headBody.å®Œäº†æ—¥']={type:'date'};

// Arm
V['arm.æ‰‹é †æ›¸ ver.']={type:'dropdown',options:SOP_VERS};
V['arm.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['arm.å®Œäº†æ—¥']={type:'date'};

// Gripper
V['gripper.IOB FW']={type:'dropdown',options:IOB_FW_GR};
V['gripper.ä½¿ç”¨SOP ver.']={type:'dropdown',options:SOP_VERS};
V['gripper.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['gripper.å®Œäº†æ—¥']={type:'date'};

// Deploy Kit
V['deployKit.æ‰‹é †æ›¸ ver.']={type:'dropdown',options:SOP_VERS};
V['deployKit.ä½¿ç”¨']={type:'dropdown',options:USAGE_OPTS};
V['deployKit.å®Œäº†æ—¥']={type:'date'};

// Motors (all types share same MDB FW + enc checkbox)
['mbMotors','plMotors','armA12','armA35','armA4'].forEach(s=>{
  V[`${s}.MDB FW`]={type:'dropdown',options:MDB_FW};
  V[`${s}.enc`]={type:'checkbox'};
  V[`${s}.å®Œäº†æ—¥`]={type:'date'};
  V[`${s}.ä½¿ç”¨`]={type:'dropdown',options:USAGE_OPTS};
});
function getV(s,f){
  let v=V[`${s}.${f}`];if(v)return v;
  // Partial match: "IOB FW 2.0.0.0" â†’ match "IOB FW", "PDB FW 2.0.0.0" â†’ match "PDB FW"
  for(const[k,val]of Object.entries(V)){const[ks,kf]=k.split('.',2);if(ks===s&&f.startsWith(kf))return val;}
  // Common patterns across sections
  if(f==='ä½¿ç”¨')return{type:'dropdown',options:USAGE_OPTS};
  if(f==='å®Œäº†æ—¥'||f.includes('å®Œäº†'))return{type:'date'};
  if(f==='enc')return{type:'checkbox'};
  if(f==='å®Œäº†'||f==='æ¢±åŒ…å®Œäº†')return{type:'dropdown',options:DONE_OPTS};
  // FW fields fallback
  if(/FW/i.test(f)&&/MDB/.test(f))return{type:'dropdown',options:MDB_FW};
  if(/FW/i.test(f)&&/IOB/.test(f))return{type:'dropdown',options:IOB_FW_HB};
  if(/FW/i.test(f)&&/PDB/.test(f))return{type:'dropdown',options:PDB_FW};
  // ECN fields â€” detect type from actual data values
  if(isECNField(f)){return guessECNType(s,f);}
  return null;
}

// Detect ECN field type by scanning actual values in data
function guessECNType(section,field){
  const lk={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'}[section]||section;
  const rows=DATA[lk];
  if(!rows||!rows.length)return{type:'checkbox'};
  let bools=0,dates=0,texts=0;
  rows.forEach(r=>{
    const v=(r[field]||'').trim();if(!v)return;
    if(/^(TRUE|FALSE|true|false|1|0|OK|âœ“|âœ—|done|no)$/i.test(v))bools++;
    else if(/^\d{4}[\/-]\d{2}[\/-]\d{2}$/.test(v)||/^\d{2}[\/-]\d{2}[\/-]\d{4}$/.test(v))dates++;
    else texts++;
  });
  if(dates>bools&&dates>=texts)return{type:'date'};
  if(texts>bools&&texts>dates)return null; // free text
  return{type:'checkbox'};
}

// ===== DATA =====
let DATA={},LOADING=false;
let SHEET_META={}; // {key: {headers:[], startRow:number, tabName:string, sheetId:number}}
let SHEET_IDS={}; // {tabName: numericSheetId}

async function loadSheetIds(){
  try{
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?fields=sheets.properties`;
    const r=await fetch(url,{headers:{'Authorization':`Bearer ${accessToken}`}});
    if(!r.ok)return;
    const j=await r.json();
    (j.sheets||[]).forEach(s=>{
      if(s.properties)SHEET_IDS[s.properties.title]=s.properties.sheetId;
    });
    console.log('[Sheets] Tab IDs:',SHEET_IDS);
  }catch(e){console.warn('[Sheets] Failed to load sheet IDs:',e);}
}

async function loadAllData(onP){LOADING=true;const E=Object.entries(CONFIG.TABS);const T=E.length;let L=0;const errs=[];

  function parseSheet(raw,key,tabName){
    if(raw.length<2)return[];
    let hdr=raw[0];let startRow=1;
    // Detect multi-row headers: if row 1 has many empty cells, combine with row 2
    const emptyCount=hdr.filter(h=>!h||!h.trim()).length;
    const totalCols=Math.max(hdr.length,raw.length>1?raw[1].length:0);
    if(totalCols>5 && emptyCount/totalCols>0.3 && raw.length>2){
      // Merge row 1 + row 2: prefer row 2 value, fall back to row 1
      const row2=raw[1]||[];
      const merged=[];
      for(let ci=0;ci<totalCols;ci++){
        const h1=(hdr[ci]||'').trim();
        const h2=(row2[ci]||'').trim();
        merged[ci]=h2||h1; // prefer row 2 (actual col names) over row 1 (group headers)
      }
      hdr=merged;startRow=2;
    }
    // Handle duplicate column names by appending _2, _3 etc
    const seen={};
    hdr=hdr.map(h=>{if(!h)return h;if(!seen[h]){seen[h]=1;return h;}seen[h]++;return`${h}_${seen[h]}`;});
    // Store metadata for write-back
    SHEET_META[key]={headers:[...hdr],startRow,tabName};
    return raw.slice(startRow).map((row,ri)=>{const o={_rowIdx:ri};let has=false;
      hdr.forEach((c,ci)=>{if(c){const v=row[ci]!=null?String(row[ci]):'';o[c]=v;if(v)has=true;}});
      return has?o:null;}).filter(Boolean);
  }

  try{const R=E.map(([,t])=>encodeURIComponent(t));const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values:batchGet?${R.map(r=>`ranges=${r}`).join('&')}`;onP?.(0,T,'Fetching...');
    const resp=await fetch(url,{headers:{'Authorization':`Bearer ${accessToken}`}});if(!resp.ok)throw new Error(`HTTP ${resp.status}`);const j=await resp.json();
    (j.valueRanges||[]).forEach((vr,i)=>{const[key]=E[i];const raw=vr.values||[];DATA[key]=parseSheet(raw,key,E[i][1]);L++;onP?.(L,T,E[i][1]);});
  }catch(e){console.warn('Batch failed:',e);for(const[key,tab]of E){try{onP?.(L,T,tab);const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(tab)}`,{headers:{'Authorization':`Bearer ${accessToken}`}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const j=await r.json();const raw=j.values||[];DATA[key]=parseSheet(raw,key,tab);L++;}catch(er){errs.push({tab,error:er.message});DATA[key]=[];L++;}}}
  LOADING=false;onP?.(T,T,'Done');
  // Map numeric sheet IDs into SHEET_META
  Object.values(SHEET_META).forEach(m=>{
    const tabBase=m.tabName.replace(/!.*$/,''); // strip any range suffix
    if(SHEET_IDS[tabBase]!==undefined)m.sheetId=SHEET_IDS[tabBase];
  });
  buildDebugInfo();return errs;}

// ===== FLEXIBLE COLUMN MATCHING =====
function getSNField(rows){if(!rows||!rows.length)return'S/N';const K=Object.keys(rows[0]);const k=K.find(k=>/^S\/?N$/i.test(k.trim()));if(k)return k;for(const k2 of K){if(rows.some(r=>/^GT\d{3}-[A-Z0-9]{2,3}-\d{3,5}$/i.test(r[k2]||'')))return k2;}return K.find(k=>!shouldSkipField(k))||K[0];}
function getRowSN(row,list){return(row[getSNField(list||[row])]||'').trim();}

// getCol: flexibly find a value from a row using multiple possible column name keywords
function getCol(row,...keywords){if(!row)return'';const K=Object.keys(row);
  for(const kw of keywords){if(row[kw]!==undefined&&row[kw]!=='')return row[kw];}
  for(const kw of keywords){const kwN=kw.toLowerCase().replace(/[\s_\-\/&]/g,'');for(const k of K){const kN=k.toLowerCase().replace(/[\s_\-\/&]/g,'');if(kN===kwN&&row[k]!=='')return row[k];}}
  for(const kw of keywords){const kwL=kw.toLowerCase();for(const k of K){if(k.toLowerCase().includes(kwL)&&row[k]!=='')return row[k];}}
  return'';}

function findRowBySN(list,snVal){if(!list||!snVal)return null;const up=snVal.toUpperCase().trim();if(!up)return null;const sf=getSNField(list);let r=list.find(r=>(r[sf]||'').toUpperCase().trim()===up);if(r)return r;
  const K=Object.keys(list[0]||{});const snK=K.filter(k=>/s[\s\/]?n/i.test(k));for(const k of snK){r=list.find(r=>(r[k]||'').toUpperCase().trim()===up);if(r)return r;}return null;}

function findRowByCol(list,colKWs,val){if(!list||!val)return null;const up=val.toUpperCase().trim();for(const row of list){const v=getCol(row,...colKWs);if(v&&v.toUpperCase().trim()===up)return row;}return null;}

function findByNum(col,num){if(!col)return null;const f=getSNField(col);return col.find(i=>{const m=(i[f]||'').match(/(\d+)$/);return m&&parseInt(m[1])===num;});}

// ===== TRACE =====
function findGhost(colKWs,subSN){if(!DATA.ghosts||!subSN)return null;const up=subSN.toUpperCase().trim();
  for(const g of DATA.ghosts){const v=getCol(g,...colKWs);if(v&&v.toUpperCase().trim()===up)return g;}
  for(const g of DATA.ghosts){if(Object.values(g).some(v=>v&&v.toUpperCase().trim()===up))return g;}
  return null;}

function traceToGhost(input){const P=parseInput(input);if(!P)return null;let ghost,path=[],matchedIn=P.label,matchedSN='';const D=DATA;
  const sn=(r,l)=>getRowSN(r,l);
  const findItem=(list)=>{if(!list)return null;let it=P.fullSN.match(/^GT/)?findRowBySN(list,P.fullSN):null;if(!it)it=findByNum(list,P.num);return it;};

  switch(P.type){
    case'ghost':{const g=findItem(D.ghosts);if(g){ghost=g;path=['Ghost'];matchedSN=sn(g,D.ghosts);}break;}
    case'mobileBase':{const mb=findItem(D.mobileBases);if(mb){const s=sn(mb,D.mobileBases);ghost=findGhost(['Mobile Base'],s);path=['Mobile Base','Ghost'];matchedSN=s;}break;}
    case'pillar':{const pl=findItem(D.pillars);if(pl){const s=sn(pl,D.pillars);ghost=findGhost(['Pillar'],s);path=['Pillar','Ghost'];matchedSN=s;}break;}
    case'headBody':{const hb=findItem(D.headBodies);if(hb){const s=sn(hb,D.headBodies);ghost=findGhost(['Body&Head','Head & Body','Body'],s);path=['Head & Body','Ghost'];matchedSN=s;}break;}
    case'arm':{const a=findItem(D.arms);if(a){const s=sn(a,D.arms);ghost=findGhost(['Arm'],s);path=['Arm','Ghost'];matchedSN=s;}break;}
    case'gripper':{const gr=findItem(D.grippers);if(gr){const gs=sn(gr,D.grippers);const a=findRowByCol(D.arms,['Gripper S/N','gripper'],gs);if(a){ghost=findGhost(['Arm'],sn(a,D.arms));}path=['Gripper','Arm','Ghost'];matchedSN=gs;}break;}
    case'deployKit':{const dk=findItem(D.deployKits);if(dk){const s=sn(dk,D.deployKits);ghost=findGhost(['Deploy Kit','DeployKit'],s);path=['Deploy Kit','Ghost'];matchedSN=s;}break;}
    case'lMotor':{const lm=findItem(D.lMotors);if(lm){const ls=sn(lm,D.lMotors);
      let found=false;for(const mb of(D.mobileBases||[])){for(const c of['L1 motor S/N','L2 motor S/N']){const v=getCol(mb,c);if(v&&v.toUpperCase().trim()===ls.toUpperCase().trim()){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=[`L-Motor (${c.substring(0,2)})`,'Mobile Base','Ghost'];found=true;break;}}if(found)break;}
      if(!found){for(const pl of(D.pillars||[])){const v=getCol(pl,'L3 motor S/N');if(v&&v.toUpperCase().trim()===ls.toUpperCase().trim()){ghost=findGhost(['Pillar'],sn(pl,D.pillars));path=['L-Motor (L3)','Pillar','Ghost'];found=true;break;}}}
      matchedSN=ls;}break;}
    case'a12Motor':case'a35Motor':case'a4Motor':{const lk=P.type==='a12Motor'?'a12Motors':P.type==='a35Motor'?'a35Motors':'a4Motors';const m=findItem(D[lk]);if(m){const ms=sn(m,D[lk]);const cols=P.type==='a12Motor'?['A1 motor S/N','A2 motor S/N']:P.type==='a35Motor'?['A3 motor S/N','A5 motor S/N']:['A4 motor S/N'];
      for(const a of(D.arms||[])){for(const c of cols){const v=getCol(a,c);if(v&&v.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Arm'],sn(a,D.arms));path=[`${P.label} (${c.substring(0,2)})`,'Arm','Ghost'];break;}}if(ghost)break;}
      matchedSN=ms;}break;}
    case'galina':{const hb=findRowByCol(D.headBodies,['GALINA S/N','GALINA'],String(P.num));if(hb){ghost=findGhost(['Body&Head','Head & Body'],sn(hb,D.headBodies));path=['GALINA','Head & Body','Ghost'];matchedSN=String(P.num);}break;}
    case'pdb':{const v=`PDB-${P.num}`;const mb=findRowByCol(D.mobileBases,['PDB S/N','PDB'],v)||findRowByCol(D.mobileBases,['PDB S/N'],String(P.num));if(mb){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=['PDB','Mobile Base','Ghost'];matchedSN=v;}break;}
    case'iob':{const v=`IOB-${P.num}`;let hb=findRowByCol(D.headBodies,['IOB S/N','IOB'],v)||findRowByCol(D.headBodies,['IOB S/N'],String(P.num));if(hb){ghost=findGhost(['Body&Head','Head & Body'],sn(hb,D.headBodies));path=['IOB','Head & Body','Ghost'];matchedSN=v;break;}
      let gr=findRowByCol(D.grippers,['IOB S/N','IOB'],v);if(gr){const gs=sn(gr,D.grippers);const a=findRowByCol(D.arms,['Gripper S/N'],gs);if(a)ghost=findGhost(['Arm'],sn(a,D.arms));path=['IOB','Gripper','Arm','Ghost'];matchedSN=v;}break;}
    case'mdb':{const v=`MDB-${P.num}`;for(const lk of['lMotors','a12Motors','a35Motors','a4Motors']){const m=findRowByCol(D[lk],['MDB S/N','MDB'],v);if(m){const ms=sn(m,D[lk]);/* trace up */for(const a of(D.arms||[])){for(const c of['A1 motor S/N','A2 motor S/N','A3 motor S/N','A4 motor S/N','A5 motor S/N']){const cv=getCol(a,c);if(cv&&cv.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Arm'],sn(a,D.arms));path=['MDB',`Motor (${c.substring(0,2)})`,'Arm','Ghost'];break;}}if(ghost)break;}
      if(!ghost){for(const mb of(D.mobileBases||[])){for(const c of['L1 motor S/N','L2 motor S/N']){const cv=getCol(mb,c);if(cv&&cv.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=['MDB',`L-Motor (${c.substring(0,2)})`,'Mobile Base','Ghost'];break;}}if(ghost)break;}}
      matchedSN=v;break;}}break;}
    case'brk':{const v=`BRK-${P.num}`;const pl=findRowByCol(D.pillars,['BRK S/N','BRK'],v)||findRowByCol(D.pillars,['BRK S/N'],String(P.num));if(pl){ghost=findGhost(['Pillar'],sn(pl,D.pillars));path=['Brake','Pillar','Ghost'];matchedSN=v;}break;}
    case'bat':{const v=`BAT-${P.num}`;const a=findRowByCol(D.arms,['BAT S/N','BAT'],v)||findRowByCol(D.arms,['BAT S/N'],String(P.num));if(a){ghost=findGhost(['Arm'],sn(a,D.arms));path=['Battery','Arm','Ghost'];matchedSN=v;}break;}
  }
  if(!ghost)return null;return{ghost,path,matchedIn,matchedSN,parsed:P};}

// ===== GHOST TREE =====
function getGhostTree(ghostRow){if(!ghostRow)return null;const D=DATA;
  const mbSN=getCol(ghostRow,'Mobile Base'),plSN=getCol(ghostRow,'Pillar'),hbSN=getCol(ghostRow,'Body&Head','Head & Body','Body'),armSN=getCol(ghostRow,'Arm'),dkSN=getCol(ghostRow,'Deploy Kit','DeployKit');
  console.log('[Tree] Ghost keys:',Object.keys(ghostRow).join(', '));
  console.log('[Tree] MB:',mbSN,'PL:',plSN,'HB:',hbSN,'ARM:',armSN,'DK:',dkSN);
  const mb=findRowBySN(D.mobileBases,mbSN),pl=findRowBySN(D.pillars,plSN),hb=findRowBySN(D.headBodies,hbSN),arm=findRowBySN(D.arms,armSN),dk=findRowBySN(D.deployKits,dkSN);
  const grSN=arm?getCol(arm,'Gripper S/N','gripper','Gripper'):'';const gr=findRowBySN(D.grippers,grSN);
  const mbMotors=[];if(mb){['L1 motor S/N','L2 motor S/N'].forEach(c=>{const s=getCol(mb,c);if(s){const m=findRowBySN(D.lMotors,s);if(m)mbMotors.push(m);}});}
  const plMotors=[];if(pl){const s=getCol(pl,'L3 motor S/N');if(s){const m=findRowBySN(D.lMotors,s);if(m)plMotors.push(m);}}
  const armA12=[],armA35=[],armA4=[];
  if(arm){['A1 motor S/N','A2 motor S/N'].forEach(c=>{const s=getCol(arm,c);if(s){const m=findRowBySN(D.a12Motors,s);if(m)armA12.push(m);}});['A3 motor S/N','A5 motor S/N'].forEach(c=>{const s=getCol(arm,c);if(s){const m=findRowBySN(D.a35Motors,s);if(m)armA35.push(m);}});const a4s=getCol(arm,'A4 motor S/N');if(a4s){const m=findRowBySN(D.a4Motors,a4s);if(m)armA4.push(m);}}
  console.log('[Tree] Found:','MB=',!!mb,'PL=',!!pl,'HB=',!!hb,'ARM=',!!arm,'GR=',!!gr,'DK=',!!dk,'mbM=',mbMotors.length,'plM=',plMotors.length,'a12=',armA12.length,'a35=',armA35.length,'a4=',armA4.length);
  return{ghost:ghostRow,mb,pl,hb,arm,gr,dk,mbMotors,plMotors,armA12,armA35,armA4};}

// ===== DEBUG =====
let debugInfo='';
function buildDebugInfo(){const L=[];
  // Show each dataset
  for(const[k,rows]of Object.entries(DATA)){if(rows&&rows.length){const cols=Object.keys(rows[0]);const sf=getSNField(rows);L.push(`<b>${k}</b> (${rows.length} rows) S/N col: <code>${sf}</code> first: <code>${(rows[0][sf]||'').substring(0,25)}</code>`);L.push(`Columns: ${cols.slice(0,15).map(c=>'<code>'+c.replace(/</g,'&lt;').substring(0,20)+'</code>').join(', ')}${cols.length>15?' ...'+(cols.length-15)+' more':''}`);
  }else L.push(`<b>${k}</b>: empty`);}
  // Show Ghost row #1 ALL columns & values
  if(DATA.ghosts&&DATA.ghosts[0]){const g=DATA.ghosts[0];
    L.push('<hr><b style="color:#5b6eea">GHOST ROW #1 â€” ALL KEY COLUMNS:</b>');
    const linkCols=['Mobile Base','Pillar','Body&Head','Head & Body','Body','Arm','Deploy Kit','DeployKit','S/N'];
    linkCols.forEach(c=>{const v=g[c];L.push(`  <code>${c}</code> = <code style="color:${v?'#34d399':'#f87171'}">${v||'(empty/missing)'}</code>`);});
    L.push('<br><b style="color:#fbbf24">ALL Ghost row #1 columns:</b>');
    Object.entries(g).forEach(([k,v])=>{if(v)L.push(`  <code>${k.substring(0,30)}</code> = <code>${String(v).substring(0,40)}</code>`);});
  }
  // Show sub-assembly first rows
  const checks=[['mobileBases','ghosts link',"Mobile Base"],['pillars','ghosts link',"Pillar"],['headBodies','ghosts link',"Body&Head"],['arms','ghosts link',"Arm"],['deployKits','ghosts link',"Deploy Kit"]];
  checks.forEach(([dk,lbl,ghostCol])=>{
    if(DATA[dk]&&DATA[dk][0]){const r=DATA[dk][0];const rsn=getRowSN(r,DATA[dk]);const gRow=DATA.ghosts?DATA.ghosts[0]:null;const gVal=gRow?getCol(gRow,ghostCol):'';
      L.push(`<br><b>${dk}[0]</b> SN=<code>${rsn}</code> Ghost col "<code>${ghostCol}</code>"=<code style="color:${gVal===rsn?'#34d399':'#f87171'}">${gVal||'empty'}</code> ${gVal===rsn?'âœ… MATCH':'âŒ NO MATCH'}`);}});
  debugInfo=L.join('<br>');}

// ===== STATE =====
const S={screen:'login',searchInput:'',parsedPreview:null,result:null,tree:null,expanded:new Set(),editing:null,editValue:'',toast:null,scanning:false,loadErrors:[],refreshing:false,showDebug:false,ecnExpanded:new Set(),selectedChip:null,chipNum:'',bulkStep:1,bulkDK:null,bulkField:null,bulkValue:'',bulkSaving:false,bulkSelected:new Set(),bulkInputMode:'individual',bulkNumInput:'',bulkRangeStart:'',bulkRangeEnd:'',bulkPerUnit:{},bulkIsPerUnit:false,settingsTab:'ecn',settingsSel:null};
const $=s=>document.querySelector(s);const app=()=>document.getElementById('app');
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escA(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// Edit registry - avoids putting arbitrary strings in onclick handlers
let editRegistry=[];
function regEdit(sec,sn,field,value){const id=editRegistry.length;editRegistry.push({sec,sn,field,value});return id;}
function doEdit(id){const e=editRegistry[id];if(e)startEdit(e.sec,e.sn,e.field,e.value);}

// Compliance action registry
let compRegistry=[];
function regComp(action,dk,field){const id=compRegistry.length;compRegistry.push({action,dk,field});return id;}
function doComp(id){const c=compRegistry[id];if(!c)return;
  if(c.action==='check')togCompCheck(c.dk,c.field);
  else if(c.action==='req')togCompReq(c.dk,c.field);
  else if(c.action==='ecn')togCompECN(c.dk,c.field);
  else if(c.action==='ecnvis')togECNField(c.dk,c.field);
  else if(c.action==='togunit')togBulkUnit(c.field);
  else if(c.action==='bulk')pickBulkField(c.dk,c.field);
}
function regFW(field){const id=compRegistry.length;compRegistry.push({action:'fw',dk:'',field});return id;}
function doFWChange(id,val){const c=compRegistry[id];if(c)setFWRule(c.field,val);}

function render(){editRegistry=[];compRegistry=[];switch(S.screen){case'login':rLogin();break;case'loading':rLoad();break;case'search':rSearch();break;case'result':rResult();break;case'edit':rEdit();break;case'bulkEdit':rBulkEdit();break;case'settings':rSettings();break;case'ecnSettings':rSettings();break;case'compSettings':rSettings();break;}}

// ===== LOGIN =====
function rLogin(){app().innerHTML=`<div class="login-screen"><div class="login-bg"></div><div class="login-card"><div class="logo">ðŸ‘»</div><h1 class="login-title">Ghost Tracker</h1><p class="login-sub">Assembly tracking for Ghost robots.<br>Sign in to access production data.</p><button class="g-btn" onclick="doLogin()"><svg viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Sign in with Google</button><div class="login-err" id="loginErr"></div></div></div>${rToast()}`;}
function doLogin(){if(!tokenClient){$('#loginErr').textContent='Google loading... try again.';$('#loginErr').style.display='block';return;}tokenClient.requestAccessToken();}
async function fetchUser(){try{const r=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{'Authorization':`Bearer ${accessToken}`}});if(!r.ok)throw 0;const i=await r.json();const a=CONFIG.APPROVED_USERS[i.email||''];if(!a){const el=$('#loginErr');el.textContent=`Access denied.\n${i.email} not approved.`;el.style.display='block';accessToken=null;localStorage.removeItem('gat');return;}currentUser={name:a.name,email:i.email,team:a.team,isAdmin:a.isAdmin,isGuest:false};localStorage.setItem('gau',JSON.stringify(currentUser));startApp();}catch{const el=$('#loginErr');if(el){el.textContent='Login failed.';el.style.display='block';}}}
function doLogout(){if(accessToken)try{google.accounts.oauth2.revoke(accessToken);}catch{}localStorage.removeItem('gat');localStorage.removeItem('gau');accessToken=null;currentUser={name:'',email:'',isAdmin:false,isGuest:false,team:''};S.screen='login';render();}
async function startApp(){S.screen='loading';render();
  // Load ECN settings from Firestore in parallel with sheet data
  const [errs]=await Promise.all([loadAllData((l,t,c)=>{LP={l,t,c};rLoad();}),loadECNSettings(),loadCompRules(),loadSheetIds()]);
  S.loadErrors=errs;S.screen='search';render();}
async function valToken(){try{const r=await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token='+accessToken);if(r.ok)startApp();else{localStorage.removeItem('gat');localStorage.removeItem('gau');accessToken=null;render();}}catch{localStorage.removeItem('gat');accessToken=null;render();}}

// ===== LOADING =====
let LP={l:0,t:11,c:''};
function rLoad(){const p=LP.t?Math.round(LP.l/LP.t*100):0;app().innerHTML=`${rUBar()}<div class="ld-screen"><div class="ld-spin">ðŸ‘»</div><div style="color:var(--t3);font-size:14px">Loading assembly data...</div><div class="ld-bar-w"><div class="ld-bar" style="width:${p}%"></div></div><div style="color:var(--t5);font-size:12px;font-family:var(--fm)">${LP.c||'Connecting...'}</div></div>`;}
function rUBar(){if(!currentUser.name)return'';const b=currentUser.isAdmin?'<span class="ubadge ubadge-a">ADMIN</span>':`<span class="ubadge ubadge-t">${esc((currentUser.team||'team').toUpperCase())}</span>`;const adminBtns=currentUser.isAdmin?'<button class="ecnbtn" onclick="openSettings()">âš™ï¸ Settings</button><button class="ecnbtn" style="border-color:var(--grn);color:var(--grn)" onclick="openBulkEdit()">âš¡ Batch</button>':'';return`<div class="ubar"><span class="uname">${esc(currentUser.name)}${b}</span><div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">${adminBtns}<button class="logout" onclick="doLogout()">Sign out</button></div></div>`;}

// ===== SEARCH =====
const CHIPS=[
  {id:'GST',label:'Ghost',icon:'ðŸ‘»',short:'GST',color:'#5b6eea'},
  {id:'MBB',label:'MB',icon:'ðŸ›ž',short:'MB',color:'#34d399'},
  {id:'PLR',label:'Pillar',icon:'ðŸ›ï¸',short:'PL',color:'#a78bfa'},
  {id:'HBD',label:'H&B',icon:'ðŸ§ ',short:'HB',color:'#f87171'},
  {id:'ARM',label:'Arm',icon:'ðŸ¦¾',short:'ARM',color:'#fbbf24'},
  {id:'GPR',label:'Gripper',icon:'ðŸ¤',short:'GR',color:'#38bdf8'},
  {id:'DPK',label:'DK',icon:'ðŸ“¦',short:'DK',color:'#fb923c'},
  {id:'LAC',label:'L-Mot',icon:'âš™ï¸',short:'LM',color:'#6ee7b7'},
  {id:'A12',label:'A12',icon:'âš™ï¸',short:'A12',color:'#6ee7b7'},
  {id:'A35',label:'A35',icon:'âš™ï¸',short:'A35',color:'#6ee7b7'},
  {id:'A4A',label:'A4',icon:'âš™ï¸',short:'A4',color:'#6ee7b7'},
  {id:'PDB',label:'PDB',icon:'ðŸ”Œ',short:'PDB',color:'#f472b6',sub:true},
  {id:'IOB',label:'IOB',icon:'ðŸ”Œ',short:'IOB',color:'#f472b6',sub:true},
  {id:'MDB',label:'MDB',icon:'ðŸ”Œ',short:'MDB',color:'#f472b6',sub:true},
  {id:'BRK',label:'BRK',icon:'ðŸ”Œ',short:'BRK',color:'#f472b6',sub:true},
  {id:'BAT',label:'BAT',icon:'ðŸ”‹',short:'BAT',color:'#f472b6',sub:true},
  {id:'GALINA',label:'GALINA',icon:'ðŸ”¢',short:'',color:'#c084fc',sub:true},
];

function rSearch(){const tot=Object.values(DATA).reduce((s,a)=>s+(a?.length||0),0);
  const sel=S.selectedChip;const chip=sel?CHIPS.find(c=>c.id===sel):null;

  // Chip grid
  const mainChips=CHIPS.filter(c=>!c.sub);
  const subChips=CHIPS.filter(c=>c.sub);
  const chipH=(list)=>list.map(c=>{
    const active=sel===c.id;
    return`<div class="uchip ${active?'uchip-on':''}" style="${active?`background:${c.color}22;border-color:${c.color};color:${c.color}`:''};" onclick="pickChip('${c.id}')"><span class="uchip-i">${c.icon}</span><span class="uchip-l">${c.label}</span></div>`;
  }).join('');

  // Sample values from data
  const ds=[];
  if(DATA.ghosts?.length){const f=getSNField(DATA.ghosts);DATA.ghosts.slice(0,2).forEach(r=>r[f]&&ds.push(r[f]));}
  if(DATA.mobileBases?.length){const f=getSNField(DATA.mobileBases);DATA.mobileBases.slice(0,1).forEach(r=>r[f]&&ds.push(r[f]));}

  app().innerHTML=`${rUBar()}<div class="sch-screen"><div class="sch-bg"></div><div class="sch-c">
    <div class="logo" style="width:64px;height:64px;border-radius:18px;font-size:32px;margin-bottom:16px">ðŸ‘»</div>
    <h1 style="font-size:22px;font-weight:700;letter-spacing:-.5px;margin-bottom:4px">Ghost Tracker</h1>
    <div style="margin:8px 0 16px"><span class="ds"><span class="ds-dot"></span>${tot} records</span></div>

    <!-- CHIP SELECTOR -->
    <div style="width:100%;max-width:420px;margin-bottom:16px">
      <div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:6px">SELECT UNIT TYPE</div>
      <div class="chipgrid">${chipH(mainChips)}</div>
      <div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin:10px 0 6px">SUB-COMPONENTS</div>
      <div class="chipgrid">${chipH(subChips)}</div>
    </div>

    <!-- NUMBER INPUT (when chip selected) -->
    ${chip?`<div style="width:100%;max-width:420px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:12px;color:${chip.color};font-weight:700">${chip.icon} ${chip.label}</span>
        <span style="font-size:10px;color:var(--t4)">Enter number â†“</span>
      </div>
      <div style="display:flex;gap:8px">
        ${chip.short?`<div style="padding:12px 16px;border-radius:12px;background:${chip.color}15;border:1px solid ${chip.color}33;color:${chip.color};font-family:var(--fm);font-size:18px;font-weight:700;white-space:nowrap">${chip.short}-</div>`:''}
        <input class="sch-in" id="chipNum" type="number" inputmode="numeric" pattern="[0-9]*" value="${esc(S.chipNum)}" placeholder="${chip.id==='GALINA'?'240002...':'1, 24, 105...'}" style="font-size:20px;text-align:center;letter-spacing:2px" autocomplete="off">
      </div>
    </div>
    <div class="br"><button class="btn btn1" onclick="doChipSearch()">Search</button><button class="btn btn3" onclick="clearChip()">âœ• Clear</button></div>`

    :`<!-- FULL S/N INPUT (no chip selected) -->
    <div style="width:100%;max-width:420px;margin-bottom:12px">
      <div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:6px">OR ENTER FULL S/N</div>
      <input class="sch-in" id="si" value="${esc(S.searchInput)}" placeholder="GT418-GST-00001 or scan QR..." autocomplete="off" spellcheck="false">
    </div>
    <div class="br"><button class="btn btn1" onclick="doSearch()">Search</button><button class="btn btn2" onclick="demoScan()">ðŸ“· Scan QR</button></div>`}

    ${ds.length?`<div class="demo-s"><div class="demo-l">Quick</div><div class="demo-chips">${ds.map(s=>`<button class="demo-c" onclick="setSI('${esc(s)}')">${esc(s)}</button>`).join('')}</div></div>`:''}
    ${S.loadErrors.length?`<div class="err-b" style="margin-top:16px;max-width:400px">âš  ${S.loadErrors.map(e=>e.tab).join(', ')}</div>`:''}
  </div></div>${rToast()}`;

  // Event listeners
  const si=$('#si');if(si){si.addEventListener('input',e=>{S.searchInput=e.target.value;S.parsedPreview=parseInput(e.target.value);});si.addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});setTimeout(()=>si.focus(),50);}
  const cn=$('#chipNum');if(cn){cn.addEventListener('input',e=>{S.chipNum=e.target.value;});cn.addEventListener('keydown',e=>{if(e.key==='Enter')doChipSearch();});setTimeout(()=>cn.focus(),100);}
}

// ===== RESULT =====
function rResult(){const{result:R,tree:T}=S;if(!R||!T)return;const gSN=getRowSN(T.ghost,DATA.ghosts);
  const all=[{k:'ghost',d:T.ghost},{k:'mobileBase',d:T.mb},{k:'mbMotors',d:T.mbMotors},{k:'pillar',d:T.pl},{k:'plMotors',d:T.plMotors},{k:'headBody',d:T.hb},{k:'arm',d:T.arm},{k:'armA12',d:T.armA12},{k:'armA35',d:T.armA35},{k:'armA4',d:T.armA4},{k:'gripper',d:T.gr},{k:'deployKit',d:T.dk}];
  const mi=(R.matchedIn||'').toLowerCase().replace(/[^a-z0-9]/g,'');const mp=(R.path||[]).map(p=>p.toLowerCase().replace(/[^a-z0-9]/g,''));
  const sm={pdb:['mobilebase'],iob:['headbody','gripper'],mdb:['mbmotors','plmotors','arma12','arma35','arma4'],brk:['pillar'],bat:['arm'],galina:['headbody'],lmotor:['mbmotors','plmotors'],a12motor:['arma12'],a35motor:['arma35'],a4motor:['arma4']};
  const isM=k=>{const kl=k.toLowerCase();if(mi.includes(kl)||kl.includes(mi))return true;for(const p of mp)if(p.includes(kl)||kl.includes(p))return true;for(const[s,ts]of Object.entries(sm))if(mi.includes(s)&&ts.some(t=>kl.includes(t)))return true;return false;};
  const isGM=mi==='ghost';const matched=all.filter(s=>isM(s.k));const rest=all.filter(s=>!isM(s.k));const seen=new Set();const sorted=isGM?all:[...matched,...rest];const fin=sorted.filter(s=>{if(seen.has(s.k))return false;seen.add(s.k);return true;});
  let h='';if(!isGM&&matched.length)h+=`<div style="padding:6px 12px;margin:0 0 8px;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:10px;font-weight:700;letter-spacing:1px;background:rgba(91,110,234,.06);border:1px solid rgba(91,110,234,.1);color:var(--ac)">â–² MATCHED</div>`;
  fin.forEach((s,i)=>{if(!isGM&&matched.length&&i===matched.length)h+=`<div style="padding:6px 12px;margin:12px 0 8px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:1px;background:rgba(255,255,255,.02);border:1px solid #14152a;color:var(--t5)">â–¼ OTHER ASSEMBLIES</div>`;h+=rSC(s.k,s.d,isM(s.k));});
  app().innerHTML=`${rUBar()}<div style="min-height:100vh"><div class="rh"><button class="rbk" onclick="goBack()">â† Back</button><div class="rid">ðŸ‘» ${esc(gSN)}</div><span class="rlive">LIVE</span></div>
    <div class="tbox"><div class="tbox-t">TRACE PATH</div><div class="tsteps">${R.path.map((s,i)=>`<span style="display:flex;align-items:center;gap:4px"><span class="tstep ${i===0?'tstep0':'tstepN'}">${esc(s)}</span>${i<R.path.length-1?'<span class="tarr">â†’</span>':''}</span>`).join('')}</div><div class="tsum"><span class="thl">${esc(S.searchInput)}</span> â†’ ${esc(R.matchedIn)} â†’ <span class="thl2">${esc(gSN)}</span></div></div>
    ${rCompBar(all)}
    <div style="margin:4px 16px 4px;display:flex;gap:8px;align-items:center"><button class="dbgbtn" onclick="toggleDebug()">ðŸ” Debug</button></div>
    ${S.showDebug?`<div class="dbg">${debugInfo}</div>`:''}
    <div class="sw">${h}</div>
    <button class="rfb ${S.refreshing?'rfS':''}" onclick="doRefresh()" title="Refresh">â†»</button></div>${rToast()}`;
}

// Compliance progress bar
function rCompBar(allSecs){
  const lkMap={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'};
  let totalChecked=0,totalIssues=0;
  allSecs.forEach(({k,d})=>{
    if(!d)return;const items=Array.isArray(d)?d:[d];if(!items.length)return;
    const dk=lkMap[k]||k;
    items.forEach(item=>{
      Object.entries(item).forEach(([field,val])=>{
        if(field==='_rowIdx')return;
        const issue=checkFieldComp(dk,field,val);
        if(issue!==null){totalChecked++;totalIssues++;}
        else{
          // Count non-null rules that passed
          const hasRule=COMP_RULES.latestFW?.[field]||
            (COMP_RULES.requiredChecks?.[dk]||[]).includes(field)||
            (COMP_RULES.requiredFields?.[dk]||[]).includes(field)||
            (COMP_RULES.requiredECN?.[dk]||[]).includes(field);
          // Check partial FW match
          const hasFWRule=Object.keys(COMP_RULES.latestFW||{}).some(fw=>field===fw||field.startsWith(fw));
          if(hasRule||hasFWRule)totalChecked++;
        }
      });
    });
  });
  if(!totalChecked)return'';
  const passed=totalChecked-totalIssues;
  const pct=Math.round((passed/totalChecked)*100);
  const color=pct===100?'var(--grn)':pct>=70?'var(--yel)':'var(--red)';
  return`<div class="comp-bar">
    <div class="comp-bar-top">
      <span style="font-size:10px;font-weight:600;letter-spacing:1px;color:var(--t5)">COMPLIANCE</span>
      <span style="font-size:12px;font-weight:700;color:${color}">${pct}%</span>
    </div>
    <div class="comp-bar-track"><div class="comp-bar-fill" style="width:${pct}%;background:${color}"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:4px">
      <span style="font-size:10px;color:var(--t4)">${passed}/${totalChecked} checks passed</span>
      ${totalIssues?`<span style="font-size:10px;color:var(--red)">${totalIssues} issue${totalIssues>1?'s':''}</span>`:'<span style="font-size:10px;color:var(--grn)">All clear âœ“</span>'}
    </div>
  </div>`;
}

function rSC(sk,data,isMS){if(!data||(Array.isArray(data)&&!data.length))return'';const c=SC[sk];if(!c)return'';const items=Array.isArray(data)?data:[data];if(!items.length)return'';const isO=S.expanded.has(sk);const lk={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'}[sk]||sk;const sf=getSNField(DATA[lk]||items);
  const issues=countSectionIssues(lk,items);
  const issueBadge=issues?`<span class="comp-badge">${issues} âš </span>`:'';
  let innerH='';
  if(isO){
    const ecnH=rECNSubSection(sk,items,lk);
    const hasECN=ecnH.length>0;
    innerH=items.map((item,idx)=>`<div class="fg" style="background:var(--card);border:1px solid ${c.color}15;border-top:none;border-radius:${idx===items.length-1&&!hasECN?'0 0 12px 12px':'0'}">${items.length>1?`<div class="fgl" style="color:${c.color}">${esc(item[sf]||'?')}</div>`:''}${Object.entries(item).map(([k,v])=>rFR(sk,item[sf]||'',k,v,lk)).join('')}</div>`).join('');
    if(hasECN)innerH+=`<div style="background:var(--card);border:1px solid ${c.color}15;border-top:none;border-radius:0 0 12px 12px">${ecnH}</div>`;
  }
  return`<div class="sc"><div class="sh" onclick="togSec('${sk}')" style="background:${c.bg};border-radius:${isO?'12px 12px 0 0':'12px'};border:1px solid ${c.color}${isMS?'55':'22'};border-left:${isMS?'4px solid '+c.color:'1px solid '+c.color+'22'}"><span class="si">${c.icon}</span><div class="sinfo"><div class="slbl" style="color:${c.color}">${c.label}</div><div class="ssn">${items.map(i=>esc(i[sf]||'?')).join(' Â· ')}</div></div>${issueBadge}${isMS?`<span class="mbdg" style="background:${c.color}22;color:${c.color}">MATCH</span>`:''}<span class="schv ${isO?'schvO':''}">â–¼</span></div>${innerH}</div>`;}

function rFR(sec,sn,field,value,lk){if(shouldSkipField(field))return'';const label=FIELD_LABELS[field]||field;const val=getV(sec,field);const isSN=field===getSNField(DATA[lk]||[])||/S\/N$/i.test(field);const isC=val?.type==='checkbox';const isD=val?.type==='date';const isDr=val?.type==='dropdown';const isH=S.result?.matchedSN===value||(S.result?.matchedSN===sn&&field===getSNField(DATA[lk]||[]));
  const compIssue=checkFieldComp(lk,field,value);
  const eid=regEdit(sec,sn,field,value||'');
  let vH;if(isC){const p=value==='âœ“'||/^(TRUE|true|1|OK)$/.test(value);vH=`<span class="ckd ${p?'ckP':'ckF'}">${p?'âœ“':'âœ—'}</span>`;}else{vH=`<span class="fv ${isSN?'fvsn':''}">${esc(value||'â€”')}</span>`;}
  const compCls=compIssue?'fr-warn':'';
  const compTag=compIssue?`<span class="comp-tag">âš  ${esc(compIssue)}</span>`:'';
  return`<div class="fr ${isH?'frH':''} ${compCls}" onclick="doEdit(${eid})"><div class="fl"><span class="flbl">${esc(label)}</span>${isDr?'<span class="ib ib-l">â–¾</span>':''}${isC?'<span class="ib ib-c">â˜</span>':''}${isD?'<span class="ib ib-d">ðŸ“…</span>':''}${compTag}</div><div class="frt">${vH}<span class="fei">âœŽ</span></div></div>`;}

// ===== EDIT =====
function rEdit(){const{editing:E,editValue:ev}=S;if(!E)return;const label=FIELD_LABELS[E.field]||E.field;const c=SC[E.section];const val=getV(E.section,E.field);
  // Use effective type override for ECN fields with mixed values
  const eType=E._effectiveType!==undefined?E._effectiveType:val?.type;
  const isDr=eType==='dropdown';const isC=eType==='checkbox';const isD=eType==='date';const ch=ev!==E.value&&ev!=='';
  let iH='';
  if(isDr)iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">SELECT VALUE</div><div style="display:flex;flex-direction:column;gap:4px">${val.options.map(o=>{const s=ev===o,cu=E.value===o;return`<div class="do ${s?'doS':''}" onclick="setEV('${escA(o)}')"><div class="doi"><div class="dor ${s?'dorS':''}">${s?'<div class="dorD"></div>':''}</div><span class="dot ${s?'dotS':''}">${esc(o)}</span></div>${cu?'<span class="doCur">CURRENT</span>':''}</div>`;}).join('')}</div></div>`;
  else if(isC)iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:12px">TOGGLE</div><div style="display:flex;gap:12px">${['âœ“','âœ—'].map(v=>{const s=ev===v,p=v==='âœ“',col=p?'var(--grn)':'var(--red)',bg=p?'rgba(52,211,153,.1)':'rgba(248,113,113,.1)';return`<div style="flex:1;padding:24px 16px;border-radius:14px;cursor:pointer;text-align:center;border:${s?'2px solid '+col:'1px solid var(--bd)'};background:${s?bg:'var(--inp)'}" onclick="setEV('${v}')"><div style="width:56px;height:56px;border-radius:16px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:${s?col+'22':'rgba(255,255,255,.03)'};border:2px solid ${s?col:'var(--bd2)'};color:${s?col:'var(--t5)'}">${v}</div><div style="font-size:14px;font-weight:600;color:${s?col:'var(--t4)'}">${p?'Pass':'Fail'}</div></div>`;}).join('')}</div></div>`;
  else if(isD){const dv=(ev||'').replace(/\//g,'-');iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">DATE</div><input type="date" class="edin" id="edi" value="${dv}"><div class="dqb"><button class="dqbb" onclick="setToday()">Today</button><button class="dqbb" onclick="setYest()">Yesterday</button></div></div>`;}
  else iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">NEW VALUE</div><input type="text" class="etin" id="eti" value="${escA(ev)}"></div>`;
  app().innerHTML=`<div class="escreen"><div class="eh"><button class="ecn" onclick="goBack()">Cancel</button><span style="font-size:14px;font-weight:600">Edit Field</span><button class="esv" onclick="saveEdit()">Save âœ“</button></div><div class="ebody"><div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:${c?c.color+'10':'var(--inp)'};border:1px solid ${c?c.color+'22':'var(--bd)'}"><span>${c?.icon||'ðŸ“‹'}</span><span style="font-size:12px;color:${c?.color||'var(--t3)'};font-weight:600">${c?.label||E.section}</span></div><div style="font-size:11px;color:var(--t5);font-family:var(--fm);margin:6px 0 20px">${esc(E.sn)}</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:16px"><span style="font-size:15px;color:#b0b4cc;font-weight:500">${esc(label)}</span></div><div class="eold">${esc(E.value||'empty')}</div>${iH}<button class="savb ${ch?'savA':'savI'}" onclick="saveEdit()">${ch?'Save to Sheet':'No changes'}</button><p style="margin-top:14px;font-size:11px;color:var(--t6);text-align:center">Updates via Google Sheets API</p></div></div>${rToast()}`;
  const ti=$('#eti');if(ti){ti.addEventListener('input',e=>{S.editValue=e.target.value;});ti.addEventListener('keydown',e=>{if(e.key==='Enter')saveEdit();});setTimeout(()=>ti.focus(),50);}
  const di=$('#edi');if(di)di.addEventListener('change',e=>{S.editValue=e.target.value.replace(/-/g,'/');});}

function rToast(){if(!S.toast)return'';return`<div class="toast toast-${S.toast.type}">${esc(S.toast.msg)}</div>`;}

// ===== ACTIONS =====
function doSearch(){if(!S.searchInput.trim())return;const r=traceToGhost(S.searchInput);if(r){S.result=r;S.tree=getGhostTree(r.ghost);const ek=new Set(['ghost']);const mt=r.parsed?.type||'';const ts={ghost:['ghost'],mobileBase:['mobileBase'],pillar:['pillar'],headBody:['headBody'],arm:['arm'],gripper:['gripper'],deployKit:['deployKit'],lMotor:['mbMotors','plMotors'],a12Motor:['armA12'],a35Motor:['armA35'],a4Motor:['armA4'],pdb:['mobileBase'],iob:['headBody','gripper'],mdb:['mbMotors','plMotors','armA12','armA35','armA4'],brk:['pillar'],bat:['arm'],galina:['headBody']};(ts[mt]||[]).forEach(s=>ek.add(s));S.expanded=ek;S.screen='result';}else{showToast(`No match for "${S.searchInput}"`,'error');}render();}
function demoScan(){S.scanning=true;render();let d='GT418-GST-00001';if(DATA.ghosts?.length){const f=getSNField(DATA.ghosts);d=DATA.ghosts[0][f]||d;}setTimeout(()=>{S.searchInput=d;S.scanning=false;setTimeout(()=>doSearch(),300);},1800);}
function setSI(v){S.searchInput=v;S.selectedChip=null;S.chipNum='';S.parsedPreview=parseInput(v);render();}
function pickChip(id){S.selectedChip=S.selectedChip===id?null:id;S.chipNum='';render();}
function clearChip(){S.selectedChip=null;S.chipNum='';render();}
function doChipSearch(){
  if(!S.selectedChip||!S.chipNum.trim())return;
  const chip=CHIPS.find(c=>c.id===S.selectedChip);
  if(!chip)return;
  // GALINA: raw number. Others: prefix-number
  S.searchInput=chip.id==='GALINA'?S.chipNum.trim():`${chip.short}-${S.chipNum.trim()}`;
  doSearch();
}
function togSec(k){S.expanded.has(k)?S.expanded.delete(k):S.expanded.add(k);render();}
function toggleDebug(){S.showDebug=!S.showDebug;render();}
function startEdit(sec,sn,field,value){
  S.editing={section:sec,sn,field,value};
  const val=getV(sec,field);
  // For ECN fields, detect type from actual value (columns can have mixed types)
  let effectiveType=val?.type;
  if(isECNField(field)){
    const v=(value||'').trim();
    if(/^(TRUE|FALSE|true|false|1|0|OK|âœ“|âœ—|done|no)$/i.test(v))effectiveType='checkbox';
    else if(/^\d{4}[\/-]\d{2}[\/-]\d{2}$/.test(v)||/^\d{2}[\/-]\d{2}[\/-]\d{4}$/.test(v))effectiveType='date';
    else if(!v)effectiveType=val?.type||'checkbox'; // default for empty
    else effectiveType=null; // free text
    S.editing._effectiveType=effectiveType;
  }
  // Normalize checkbox values to âœ“/âœ— for the toggle UI
  if(effectiveType==='checkbox'){
    const isPass=/^(TRUE|true|1|OK|âœ“|done)$/i.test((value||'').trim());
    S.editValue=isPass?'âœ“':'âœ—';
    S.editing.value=isPass?'âœ“':'âœ—';
  }else{S.editValue=value||'';}
  S.screen='edit';render();
}
function setEV(v){S.editValue=v;render();}
function setToday(){const d=new Date();S.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
function setYest(){const d=new Date();d.setDate(d.getDate()-1);S.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
// Detect if a field is a S/N (serial number) field that should get exchange notes
function isSNField(field){
  const f=(field||'').toLowerCase();
  return f.includes('s/n')||f.includes('sn')||f==='serial'||/ã‚·ãƒªã‚¢ãƒ«/.test(field);
}

// Add or append a note to a Google Sheet cell
async function addCellNote(dataKey,rowIdx,colIdx,noteText){
  const meta=SHEET_META[dataKey];if(!meta)return;
  const tabName=meta.tabName.replace(/!.*$/,'');
  const sheetId=meta.sheetId??SHEET_IDS[tabName];
  if(sheetId===undefined){console.warn('[Note] No sheetId for',tabName);return;}
  const sheetRow=meta.startRow+1+rowIdx;

  // First, try to fetch existing note
  let existingNote='';
  try{
    const getUrl=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?ranges=${encodeURIComponent(tabName+'!R'+sheetRow+'C'+(colIdx+1))}&fields=sheets.data.rowData.values.note`;
    const gr=await fetch(getUrl,{headers:{'Authorization':`Bearer ${accessToken}`}});
    if(gr.ok){
      const gj=await gr.json();
      existingNote=(gj.sheets?.[0]?.data?.[0]?.rowData?.[0]?.values?.[0]?.note)||'';
    }
  }catch(e){console.warn('[Note] Failed to read existing note:',e);}

  // Build full note: append new line if existing
  const fullNote=existingNote?(existingNote+'\n'+noteText):noteText;

  // Write note via batchUpdate
  try{
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}:batchUpdate`;
    const body={requests:[{updateCells:{
      rows:[{values:[{note:fullNote}]}],
      fields:'note',
      range:{sheetId,startRowIndex:sheetRow-1,endRowIndex:sheetRow,startColumnIndex:colIdx,endColumnIndex:colIdx+1}
    }}]};
    const r=await fetch(url,{method:'POST',headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(r.ok){console.log('[Note] Added:',noteText);}
    else{console.warn('[Note] Failed:',r.status,await r.text().catch(()=>''));}
  }catch(e){console.warn('[Note] Error:',e);}
}

async function saveEdit(){
  if(!S.editing||S.editValue===S.editing.value)return;
  const{section,sn,field}=S.editing;
  let newVal=S.editValue;
  const label=FIELD_LABELS[field]||field;

  // Convert checkbox display values to sheet values
  const fieldType=getV(section,field);
  if(fieldType?.type==='checkbox'){
    newVal=newVal==='âœ“'?'TRUE':'FALSE';
  }

  // Map section to DATA key
  const secToKey={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'};
  const dataKey=secToKey[section];
  if(!dataKey||!SHEET_META[dataKey]){showToast('Cannot find sheet metadata','error');return;}

  const meta=SHEET_META[dataKey];
  const rows=DATA[dataKey];
  if(!rows){showToast('No data loaded','error');return;}

  // Find the row by matching S/N
  const sf=getSNField(rows);
  const row=rows.find(r=>(r[sf]||'').toUpperCase().trim()===sn.toUpperCase().trim());
  if(!row){showToast('Row not found','error');return;}

  // Find column index from headers
  const colIdx=meta.headers.indexOf(field);
  if(colIdx===-1){showToast('Column not found','error');return;}

  // Calculate sheet cell reference using stored original row index
  // Sheet row = startRow (header rows) + 1 (1-indexed) + _rowIdx
  const sheetRow=meta.startRow+1+row._rowIdx;
  // Column letter (A=0, B=1, ..., Z=25, AA=26, ...)
  function colLetter(n){let s='';while(n>=0){s=String.fromCharCode(65+(n%26))+s;n=Math.floor(n/26)-1;}return s;}
  const colL=colLetter(colIdx);
  const cellRef=`${meta.tabName}!${colL}${sheetRow}`;

  // Show saving state
  showToast(`Saving ${label}...`);

  async function doSave(){
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(cellRef)}?valueInputOption=USER_ENTERED`;
    return fetch(url,{
      method:'PUT',
      headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},
      body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[newVal]]})
    });
  }

  function refreshToken(){
    return new Promise((resolve,reject)=>{
      if(!tokenClient){reject(new Error('No token client'));return;}
      const origCb=tokenClient.callback;
      let done=false;
      tokenClient.callback=r=>{
        if(done)return;done=true;
        tokenClient.callback=origCb;
        if(r.access_token){accessToken=r.access_token;localStorage.setItem('gat',accessToken);resolve();}
        else reject(new Error('Re-auth failed'));
      };
      tokenClient.requestAccessToken({prompt:''});
      setTimeout(()=>{if(!done){done=true;tokenClient.callback=origCb;reject(new Error('Re-auth timed out'));}},15000);
    });
  }

  try{
    let resp=await doSave();
    if(resp.status===401){
      showToast('Token expired, refreshing...');
      await refreshToken();
      resp=await doSave();
    }
    if(!resp.ok){const e=await resp.text().catch(()=>'');let msg=`HTTP ${resp.status}`;try{msg=JSON.parse(e).error?.message||msg;}catch{}throw new Error(msg);}

    // Update local data
    row[field]=newVal;
    showToast(`âœ“ ${label}: ${newVal}`);

    // Auto-add exchange note for S/N fields
    const oldVal=S.editing.value;
    if(isSNField(field)&&oldVal&&oldVal!==newVal){
      const noteText=`${oldVal} â†’ ${newVal}ã€€äº¤æ›`;
      addCellNote(dataKey,row._rowIdx,colIdx,noteText).then(()=>{
        console.log('[Note] Exchange note added for',field);
      }).catch(e=>console.warn('[Note] Failed:',e));
    }

    S.screen='result';S.editing=null;
    if(S.result?.ghost){S.tree=getGhostTree(S.result.ghost);}
    render();
  }catch(err){
    console.error('Save failed:',err);
    showToast(`Save failed: ${err.message}`,'error');
  }
}
function goBack(){if(S.screen==='edit'){S.screen='result';S.editing=null;}else if(S.screen==='bulkEdit'){bulkBack();}else if(S.screen==='settings'||S.screen==='ecnSettings'||S.screen==='compSettings'){S.screen='search';}else{S.screen='search';S.searchInput='';S.result=null;S.tree=null;S.parsedPreview=null;S.showDebug=false;S.selectedChip=null;S.chipNum='';}render();}

// ===== UNIFIED SETTINGS PAGE =====
function openSettings(tab){S.screen='settings';S.settingsTab=tab||'ecn';S.settingsSel=null;render();}
function openECNSettings(){openSettings('ecn');}
function openCompSettings(){openSettings('rules');}

const SETTINGS_TYPES=[
  {dk:'ghosts',label:'Ghost',short:'Ghost',icon:'ðŸ‘»',color:'#5b6eea'},
  {dk:'mobileBases',label:'Mobile Base',short:'MB',icon:'ðŸ›ž',color:'#34d399'},
  {dk:'pillars',label:'Pillar',short:'Pillar',icon:'ðŸ›ï¸',color:'#a78bfa'},
  {dk:'headBodies',label:'Head & Body',short:'H&B',icon:'ðŸ§ ',color:'#f87171'},
  {dk:'arms',label:'Arm',short:'Arm',icon:'ðŸ¦¾',color:'#fbbf24'},
  {dk:'grippers',label:'Gripper',short:'Grip.',icon:'ðŸ¤',color:'#38bdf8'},
  {dk:'deployKits',label:'Deploy Kit',short:'DK',icon:'ðŸ“¦',color:'#fb923c'},
  {dk:'lMotors',label:'L-Motors',short:'L-Mot',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a12Motors',label:'A12 Motors',short:'A12',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a35Motors',label:'A35 Motors',short:'A35',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a4Motors',label:'A4 Motors',short:'A4',icon:'âš™ï¸',color:'#6ee7b7'},
];

function rSettings(){
  const tab=S.settingsTab||'ecn';
  const sel=S.settingsSel;
  const selType=SETTINGS_TYPES.find(t=>t.dk===sel);

  const fwFieldsAll=detectFWFields();
  const chkFieldsAll=detectCheckboxFields();
  const allFieldsAll=detectFieldsByKey();

  function fwForDK(dk){return fwFieldsAll.filter(f=>{const rows=DATA[dk];if(!rows||!rows.length)return false;return Object.keys(rows[0]).includes(f);});}
  function chkForDK(dk){return(chkFieldsAll[dk]||[]).filter(f=>f!=='_rowIdx'&&!shouldSkipField(f));}
  function reqForDK(dk){return allFieldsAll[dk]||[];}
  function ecnForDK(dk){return getECNFields(dk);}

  // Count helpers
  function ecnCount(dk){return ecnForDK(dk).filter(f=>isECNVisible(dk,f)).length;}
  function ecnTotal(dk){return ecnForDK(dk).length;}
  function ruleCount(dk){
    const fw=fwForDK(dk).filter(f=>(COMP_RULES.latestFW||{})[f]).length;
    const chk=(COMP_RULES.requiredChecks?.[dk]||[]).length;
    const req=(COMP_RULES.requiredFields?.[dk]||[]).length;
    const ecn=(COMP_RULES.requiredECN?.[dk]||[]).length;
    return fw+chk+req+ecn;
  }
  function ruleTotal(dk){return fwForDK(dk).length+chkForDK(dk).length+reqForDK(dk).length+ecnForDK(dk).length;}

  let h='';

  // Tab toggle
  h+=`<div style="display:flex;gap:2px;margin-bottom:12px">`;
  [{id:'ecn',label:'âš™ï¸ ECN Visibility'},{id:'rules',label:'ðŸ“‹ Compliance Rules'}].forEach(t=>{
    const isAct=tab===t.id;
    h+=`<div style="flex:1;padding:10px;text-align:center;cursor:pointer;border-radius:8px 8px 0 0;background:${isAct?'var(--inp)':'transparent'};border-bottom:2px solid ${isAct?'var(--ac)':'transparent'};transition:all .15s" onclick="S.settingsTab='${t.id}';S.settingsSel=null;render()">
      <span style="font-size:12px;font-weight:600;color:${isAct?'var(--ac)':'var(--t5)'}">${t.label}</span>
    </div>`;
  });
  h+=`</div>`;

  // Assembly chip grid (4 cols)
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px">`;
  SETTINGS_TYPES.forEach(t=>{
    const rows=DATA[t.dk];if(!rows||!rows.length)return;
    const isAct=sel===t.dk;
    const cnt=tab==='ecn'?ecnCount(t.dk):ruleCount(t.dk);
    const tot=tab==='ecn'?ecnTotal(t.dk):ruleTotal(t.dk);
    const hasItems=cnt>0;
    h+=`<div style="padding:8px 4px;border-radius:10px;cursor:pointer;text-align:center;position:relative;border:${isAct?`2px solid ${t.color}`:`1.5px solid #1a1c2e`};background:${isAct?t.color+'0a':'#0d0e18'};transition:all .15s" onclick="S.settingsSel=${isAct?'null':`'${t.dk}'`};render()">
      <div style="font-size:18px;margin-bottom:2px">${t.icon}</div>
      <div style="font-size:10px;font-weight:700;color:${isAct?t.color:hasItems?'var(--t1)':'var(--t5)'};margin-bottom:3px">${t.short}</div>
      <span style="font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:${hasItems?t.color+'18':'transparent'};color:${hasItems?t.color:'var(--t5)'}">${cnt}/${tot}</span>
      ${hasItems&&!isAct?`<div style="position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:${t.color};border:2px solid var(--bg)"></div>`:''}
    </div>`;
  });
  h+=`</div>`;

  // Expanded content for selected assembly
  if(selType){
    const dk=selType.dk;
    h+=`<div style="border-radius:12px;overflow:hidden;border:1px solid ${selType.color}22;background:#0d0e18;animation:slideDown .15s ease-out">`;
    // Header
    h+=`<div style="padding:10px 14px;display:flex;align-items:center;gap:8px;background:${selType.color}08;border-bottom:1px solid ${selType.color}12">
      <span style="font-size:16px">${selType.icon}</span>
      <span style="font-size:13px;font-weight:700;color:${selType.color}">${selType.label}</span>
      <span style="font-size:10px;color:var(--t5);margin-left:auto">${tab==='ecn'?`${ecnCount(dk)}/${ecnTotal(dk)} visible`:`${ruleCount(dk)}/${ruleTotal(dk)} set`}</span>
    </div>`;

    if(tab==='ecn'){
      // ECN toggles
      const ecnFs=ecnForDK(dk);
      if(ecnFs.length){
        h+=`<div style="padding:6px 0">`;
        ecnFs.forEach(f=>{
          const vis=isECNVisible(dk,f);
          const cid=regComp('ecnvis',dk,f);
          h+=`<div style="display:flex;align-items:center;gap:10px;padding:7px 14px;cursor:pointer" onclick="doComp(${cid})">
            <div style="width:32px;height:18px;border-radius:9px;background:${vis?'var(--grn)':'#1e2130'};border:1.5px solid ${vis?'var(--grn)':'#2a2d45'};position:relative;transition:all .15s;flex-shrink:0">
              <div style="width:12px;height:12px;border-radius:50%;background:${vis?'#fff':'#4d5070'};position:absolute;top:1.5px;left:${vis?'16px':'2px'};transition:left .15s"></div>
            </div>
            <span style="flex:1;font-size:11px;color:${vis?'var(--t1)':'var(--t5)'};font-family:var(--fm)">${esc(f)}</span>
          </div>`;
        });
        h+=`</div>`;
      } else {
        h+=`<div style="padding:20px;text-align:center;font-size:11px;color:var(--t5)">No ECN fields</div>`;
      }
    } else {
      // Rules content
      h+=`<div style="padding:6px 0">`;
      const fw=fwForDK(dk);
      const chk=chkForDK(dk);
      const req=reqForDK(dk);
      const ecn=ecnForDK(dk);

      if(fw.length){
        h+=`<div style="padding:6px 14px 2px;font-size:9px;color:var(--blu);font-weight:700;letter-spacing:.5px">FW VERSIONS</div>`;
        fw.forEach(f=>{
          const cur=COMP_RULES.latestFW?.[f]||'';
          const fid=regFW(f);
          h+=`<div style="display:flex;align-items:center;gap:8px;padding:5px 14px">
            <span style="flex:1;font-size:11px;color:var(--t3)">${esc(FIELD_LABELS[f]||f)}</span>
            <input class="comp-input" style="width:100px;padding:4px 8px;border-radius:6px;text-align:right;font-size:11px" data-fwid="${fid}" value="${escA(cur)}" placeholder="not set" onchange="doFWChange(${fid},this.value)">
          </div>`;
        });
      }

      if(chk.length){
        h+=`<div style="padding:8px 14px 2px;font-size:9px;color:var(--grn);font-weight:700;letter-spacing:.5px">REQUIRED CHECKS</div>`;
        chk.forEach(f=>{
          const on=(COMP_RULES.requiredChecks?.[dk]||[]).includes(f);
          const cid=regComp('check',dk,f);
          h+=`<div style="display:flex;align-items:center;gap:10px;padding:5px 14px;cursor:pointer" onclick="doComp(${cid})">
            <div style="width:32px;height:18px;border-radius:9px;background:${on?'var(--grn)':'#1e2130'};border:1.5px solid ${on?'var(--grn)':'#2a2d45'};position:relative;transition:all .15s;flex-shrink:0">
              <div style="width:12px;height:12px;border-radius:50%;background:${on?'#fff':'#4d5070'};position:absolute;top:1.5px;left:${on?'16px':'2px'};transition:left .15s"></div>
            </div>
            <span style="font-size:11px;color:${on?'var(--t1)':'var(--t5)'}">${esc(FIELD_LABELS[f]||f)}</span>
          </div>`;
        });
      }

      if(req.length){
        h+=`<div style="padding:8px 14px 2px;font-size:9px;color:var(--yel);font-weight:700;letter-spacing:.5px">REQUIRED FIELDS</div>`;
        req.forEach(f=>{
          const on=(COMP_RULES.requiredFields?.[dk]||[]).includes(f);
          const cid=regComp('req',dk,f);
          h+=`<div style="display:flex;align-items:center;gap:10px;padding:5px 14px;cursor:pointer" onclick="doComp(${cid})">
            <div style="width:32px;height:18px;border-radius:9px;background:${on?'var(--grn)':'#1e2130'};border:1.5px solid ${on?'var(--grn)':'#2a2d45'};position:relative;transition:all .15s;flex-shrink:0">
              <div style="width:12px;height:12px;border-radius:50%;background:${on?'#fff':'#4d5070'};position:absolute;top:1.5px;left:${on?'16px':'2px'};transition:left .15s"></div>
            </div>
            <span style="font-size:11px;color:${on?'var(--t1)':'var(--t5)'}">${esc(FIELD_LABELS[f]||f)}</span>
          </div>`;
        });
      }

      if(ecn.length){
        h+=`<div style="padding:8px 14px 2px;font-size:9px;color:var(--pur);font-weight:700;letter-spacing:.5px">REQUIRED ECN</div>`;
        ecn.forEach(f=>{
          const on=(COMP_RULES.requiredECN?.[dk]||[]).includes(f);
          const cid=regComp('ecn',dk,f);
          h+=`<div style="display:flex;align-items:center;gap:10px;padding:5px 14px;cursor:pointer" onclick="doComp(${cid})">
            <div style="width:32px;height:18px;border-radius:9px;background:${on?'var(--grn)':'#1e2130'};border:1.5px solid ${on?'var(--grn)':'#2a2d45'};position:relative;transition:all .15s;flex-shrink:0">
              <div style="width:12px;height:12px;border-radius:50%;background:${on?'#fff':'#4d5070'};position:absolute;top:1.5px;left:${on?'16px':'2px'};transition:left .15s"></div>
            </div>
            <span style="font-size:11px;color:${on?'var(--t1)':'var(--t5)'};font-family:var(--fm)">${esc(f)}</span>
          </div>`;
        });
      }

      if(!fw.length&&!chk.length&&!req.length&&!ecn.length){
        h+=`<div style="padding:20px;text-align:center;font-size:11px;color:var(--t5)">No configurable rules</div>`;
      }
      h+=`</div>`;
    }
    h+=`</div>`;
  }

  // Summary when nothing selected
  if(!selType){
    const totalEcnVis=Object.values(ECN_SETTINGS).reduce((s,set)=>s+set.size,0);
    const totalRules=Object.keys(COMP_RULES.latestFW||{}).length+Object.values(COMP_RULES.requiredChecks||{}).reduce((s,a)=>s+a.length,0)+Object.values(COMP_RULES.requiredFields||{}).reduce((s,a)=>s+a.length,0)+Object.values(COMP_RULES.requiredECN||{}).reduce((s,a)=>s+a.length,0);
    h+=`<div style="padding:14px;border-radius:10px;background:#0d0e18;border:1px solid #1a1c2e;text-align:center">
      <div style="font-size:11px;color:var(--t5);margin-bottom:8px">${tab==='ecn'?'Tap an assembly to toggle ECN visibility':'Tap an assembly to configure rules'}</div>
      <div style="display:flex;justify-content:center;gap:16px">${tab==='ecn'?
        `<div><span style="font-size:18px;font-weight:700;color:var(--ac)">${totalEcnVis}</span><div style="font-size:9px;color:var(--t5)">visible</div></div>`:
        `<div><span style="font-size:18px;font-weight:700;color:var(--ac)">${totalRules}</span><div style="font-size:9px;color:var(--t5)">rules set</div></div>
         <div><span style="font-size:18px;font-weight:700;color:var(--grn)">${Object.keys(COMP_RULES.latestFW||{}).length}</span><div style="font-size:9px;color:var(--grn)">FW tracked</div></div>`
      }</div>
    </div>`;
  }

  // Save button
  const saveLabel=tab==='ecn'?'saveECNAndBack':'saveCompAndBack';
  h+=`<button class="btn btn1" style="width:100%;margin-top:16px" onclick="${saveLabel}()">Save & Back</button>`;

  app().innerHTML=`${rUBar()}<div style="min-height:100vh">
    <div class="rh"><button class="rbk" onclick="goBack()">â† Back</button><div class="rid">âš™ï¸ Settings</div></div>
    <div style="padding:16px">${h}</div>
  </div>${rToast()}`;
}

function togECNSec(dk){S.ecnExpanded.has(dk)?S.ecnExpanded.delete(dk):S.ecnExpanded.add(dk);render();}

function togECNField(dk,field){
  if(!ECN_SETTINGS[dk])ECN_SETTINGS[dk]=new Set();
  if(ECN_SETTINGS[dk].has(field))ECN_SETTINGS[dk].delete(field);
  else ECN_SETTINGS[dk].add(field);
  render();
}

async function saveECNAndBack(){await saveECNSettings();S.screen='search';render();}

// ===== ECN SUB-SECTION IN RESULT CARDS =====
function rECNSubSection(sk,items,lk){
  const dk={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'}[sk]||sk;
  const ecnFields=getECNFields(dk).filter(f=>isECNVisible(dk,f));
  if(!ecnFields.length)return'';
  const ecnKey='ecn_'+sk;
  const isOpen=S.expanded.has(ecnKey);
  const sf=getSNField(DATA[lk]||items);

  // Count ECN compliance issues
  let ecnIssues=0;
  items.forEach(item=>{ecnFields.forEach(f=>{if(checkFieldComp(dk,f,item[f]))ecnIssues++;});});
  const issueBadge=ecnIssues?`<span class="comp-badge" style="margin-left:auto">${ecnIssues} âš </span>`:'';

  let h=`<div class="ecn-sub" onclick="togSec('${ecnKey}')">
    <span class="ecn-sub-icon">ðŸ”§</span>
    <span class="ecn-sub-label">ECN (${ecnFields.length})</span>
    ${issueBadge}
    <span class="schv ${isOpen?'schvO':''}">â–¼</span>
  </div>`;
  if(isOpen){
    h+=`<div class="ecn-sub-body">`;
    items.forEach(item=>{
      ecnFields.forEach(f=>{
        const val=item[f]||'';
        const eid=regEdit(sk,item[sf]||'',f,val);
        const compIssue=checkFieldComp(dk,f,val);
        const compCls=compIssue?'fr-warn':'';
        const compTag=compIssue?`<span class="comp-tag">âš  ${esc(compIssue)}</span>`:'';

        // Detect type from actual data
        const fType=guessECNType(sk,f);
        let vH;
        if(fType?.type==='checkbox'){
          const p=/^(TRUE|true|1|OK|âœ“|done)$/i.test(val);
          const isF=/^(FALSE|false|0|âœ—|no)$/i.test(val);
          vH=p?'<span class="ckd ckP">âœ“</span>':(isF?'<span class="ckd ckF">âœ—</span>':`<span class="fv">${esc(val||'â€”')}</span>`);
        } else if(fType?.type==='date'){
          vH=`<span class="fv" style="color:var(--blu)">${esc(val||'â€”')}</span>`;
        } else {
          vH=`<span class="fv">${esc(val||'â€”')}</span>`;
        }

        h+=`<div class="fr ${compCls}" onclick="doEdit(${eid})"><div class="fl"><span class="flbl ecn-flbl">${esc(f)}</span>${compTag}</div><div class="frt">${vH}<span class="fei">âœŽ</span></div></div>`;
      });
    });
    h+=`</div>`;
  }
  return h;
}


// Compliance settings actions
function setFWRule(field,val){
  if(!COMP_RULES.latestFW)COMP_RULES.latestFW={};
  if(val.trim())COMP_RULES.latestFW[field]=val.trim();
  else delete COMP_RULES.latestFW[field];
}
function togCompCheck(dk,f){
  if(!COMP_RULES.requiredChecks)COMP_RULES.requiredChecks={};
  if(!COMP_RULES.requiredChecks[dk])COMP_RULES.requiredChecks[dk]=[];
  const idx=COMP_RULES.requiredChecks[dk].indexOf(f);
  if(idx>=0)COMP_RULES.requiredChecks[dk].splice(idx,1);
  else COMP_RULES.requiredChecks[dk].push(f);
  render();
}
function togCompReq(dk,f){
  if(!COMP_RULES.requiredFields)COMP_RULES.requiredFields={};
  if(!COMP_RULES.requiredFields[dk])COMP_RULES.requiredFields[dk]=[];
  const idx=COMP_RULES.requiredFields[dk].indexOf(f);
  if(idx>=0)COMP_RULES.requiredFields[dk].splice(idx,1);
  else COMP_RULES.requiredFields[dk].push(f);
  render();
}
function togCompECN(dk,f){
  if(!COMP_RULES.requiredECN)COMP_RULES.requiredECN={};
  if(!COMP_RULES.requiredECN[dk])COMP_RULES.requiredECN[dk]=[];
  const idx=COMP_RULES.requiredECN[dk].indexOf(f);
  if(idx>=0)COMP_RULES.requiredECN[dk].splice(idx,1);
  else COMP_RULES.requiredECN[dk].push(f);
  render();
}
async function saveCompAndBack(){await saveCompRules();S.screen='search';render();}

// ===== BULK ECN EDIT =====
function openBulkEdit(){
  S.screen='bulkEdit';S.bulkStep=1;S.bulkDK=null;S.bulkField=null;S.bulkValue='';S.bulkSelected=new Set();S.bulkSaving=false;S.bulkInputMode='individual';S.bulkNumInput='';S.bulkRangeStart='';S.bulkRangeEnd='';S.bulkPerUnit={};S.bulkIsPerUnit=false;render();
}

// All assembly types for batch
const BULK_TYPES=[
  {dk:'ghosts',sk:'ghost',label:'Ghost',icon:'ðŸ‘»',color:'#5b6eea'},
  {dk:'mobileBases',sk:'mobileBase',label:'Mobile Base',icon:'ðŸ›ž',color:'#34d399'},
  {dk:'pillars',sk:'pillar',label:'Pillar',icon:'ðŸ›ï¸',color:'#a78bfa'},
  {dk:'headBodies',sk:'headBody',label:'Head & Body',icon:'ðŸ§ ',color:'#f87171'},
  {dk:'arms',sk:'arm',label:'Arm',icon:'ðŸ¦¾',color:'#fbbf24'},
  {dk:'grippers',sk:'gripper',label:'Gripper',icon:'ðŸ¤',color:'#38bdf8'},
  {dk:'deployKits',sk:'deployKit',label:'Deploy Kit',icon:'ðŸ“¦',color:'#fb923c'},
  {dk:'lMotors',sk:'lMotors',label:'L-Motors',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a12Motors',sk:'a12Motors',label:'A12 Motors',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a35Motors',sk:'a35Motors',label:'A35 Motors',icon:'âš™ï¸',color:'#6ee7b7'},
  {dk:'a4Motors',sk:'a4Motors',label:'A4 Motors',icon:'âš™ï¸',color:'#6ee7b7'},
];

function getBulkFields(dk){
  const rows=DATA[dk];if(!rows||!rows.length)return[];
  const fields=[];
  Object.keys(rows[0]).forEach(f=>{
    if(f==='_rowIdx')return;
    const isECN=isECNField(f);
    // shouldSkipField skips ECN fields (they're shown separately in results), but we want them in batch
    if(!isECN&&shouldSkipField(f))return;
    // Get field type
    const sk=BULK_TYPES.find(t=>t.dk===dk)?.sk||dk;
    let type=null;
    const v=getV(sk,f);
    if(v?.type)type=v.type;
    else if(isECN){const g=guessECNType(sk,f);type=g?.type||null;}
    // Include updatable fields: checkboxes, dates, dropdowns, ECN, and required/text fields (per-unit)
    const isReq=(COMP_RULES.requiredFields?.[dk]||[]).includes(f)||(COMP_RULES.requiredChecks?.[dk]||[]).includes(f);
    if(type==='checkbox'||type==='date'||type==='dropdown'||isECN)
      fields.push({name:f,type:type||'text',isECN,perUnit:false});
    else if(isReq)
      fields.push({name:f,type:'text',isECN:false,perUnit:true});
  });
  return fields;
}

function pickBulkField(dk,field){
  const fields=getBulkFields(S.bulkDK);
  const fInfo=fields.find(f=>f.name===field);
  S.bulkField=field;S.bulkValue='';
  S.bulkIsPerUnit=fInfo?.perUnit||false;
  // Pre-fill per-unit values from current data
  if(S.bulkIsPerUnit){
    S.bulkPerUnit={};
    const rows=DATA[S.bulkDK]||[];const sf=getSNField(rows);
    rows.forEach(r=>{
      const sn=r[sf];
      if(S.bulkSelected.has(sn))S.bulkPerUnit[sn]=r[field]||'';
    });
  } else {
    S.bulkPerUnit={};
  }
  render();
}

function bulkGoStep(n){
  if(n===1){S.bulkDK=null;S.bulkSelected=new Set();S.bulkField=null;S.bulkValue='';}
  if(n===2){S.bulkField=null;S.bulkValue='';}
  S.bulkStep=n;render();
}

function rBulkEdit(){
  const step=S.bulkStep||1;
  let h='';

  // Progress steps â€” new order
  const steps=['Assembly','Units','Field & Value'];
  h+=`<div style="display:flex;gap:4px;margin-bottom:20px">`;
  steps.forEach((s,i)=>{
    const n=i+1;const active=step===n;const done=step>n;
    h+=`<div style="flex:1;text-align:center;cursor:${done?'pointer':'default'}" ${done?`onclick="bulkGoStep(${n})"`:''}><div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:4px"><div style="width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;${active?'background:var(--ac);color:#fff':done?'background:var(--grn);color:#fff':'background:var(--bd);color:var(--t4)'}">${done?'âœ“':n}</div></div><div style="font-size:10px;font-weight:600;color:${active?'var(--ac)':done?'var(--grn)':'var(--t5)'}">${s}</div><div style="height:3px;border-radius:2px;margin-top:4px;background:${done?'var(--grn)':active?'var(--ac)':'var(--bd)'};transition:background .3s"></div></div>`;
  });
  h+=`</div>`;

  if(step===1){
    // Step 1: Pick assembly type
    h+=`<div style="font-size:12px;color:var(--t3);margin-bottom:12px">Select assembly type to batch update</div>`;
    BULK_TYPES.forEach(bt=>{
      const rows=DATA[bt.dk]||[];if(!rows.length)return;
      const fields=getBulkFields(bt.dk);
      h+=`<div class="bulk-field" onclick="S.bulkDK='${bt.dk}';S.bulkStep=2;S.bulkSelected=new Set();S.bulkInputMode='individual';S.bulkNumInput='';render()" style="border-left:3px solid ${bt.color}">
        <span style="font-size:18px">${bt.icon}</span>
        <div style="flex:1"><div style="font-size:13px;font-weight:600;color:${bt.color}">${bt.label}</div><div style="font-size:10px;color:var(--t4)">${rows.length} units Â· ${fields.length} fields</div></div>
        <span style="color:var(--t5)">â€º</span>
      </div>`;
    });
  }

  else if(step===2){
    // Step 2: Select units via chip input
    const bt=BULK_TYPES.find(t=>t.dk===S.bulkDK);
    if(!bt){S.bulkStep=1;render();return;}
    const rows=DATA[S.bulkDK]||[];
    const sf=getSNField(rows);
    const selCount=S.bulkSelected.size;
    function snNum(sn){const m=(sn||'').match(/(\d+)$/);return m?parseInt(m[1]):null;}
    const firstSN=rows.length?rows[0][sf]:'';
    const snPrefix=firstSN.replace(/\d+$/,'');

    h+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <span style="font-size:24px">${bt.icon}</span>
      <div><div style="font-size:16px;font-weight:700;color:${bt.color}">${bt.label}</div>
        <div style="font-size:11px;color:var(--t4)">${rows.length} units available Â· prefix: <span style="color:${bt.color};font-family:var(--fm)">${esc(snPrefix)}</span></div></div>
    </div>`;

    // Input mode tabs
    h+=`<div style="display:flex;gap:4px;margin-bottom:10px">
      <button class="bulk-change" style="padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;${S.bulkInputMode==='individual'?'background:var(--ac);color:#fff;border-color:var(--ac)':''}" onclick="S.bulkInputMode='individual';render()">Type Numbers</button>
      <button class="bulk-change" style="padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;${S.bulkInputMode==='range'?'background:var(--ac);color:#fff;border-color:var(--ac)':''}" onclick="S.bulkInputMode='range';render()">Range</button>
    </div>`;

    if(S.bulkInputMode==='individual'){
      h+=`<div id="bulkChipBox" class="bulk-chip-box" onclick="$('#bulkNumIn')?.focus()">`;
      S.bulkSelected.forEach(sn=>{
        const n=snNum(sn);
        const uid=regComp('togunit',S.bulkDK,sn);
        h+=`<div class="bulk-chip" style="background:${bt.color}15;border-color:${bt.color}33;color:${bt.color}">${n!==null?n:esc(sn)}<span class="bulk-chip-x" onclick="event.stopPropagation();doComp(${uid})">Ã—</span></div>`;
      });
      h+=`<input type="text" inputmode="numeric" id="bulkNumIn" class="bulk-num-input" value="${escA(S.bulkNumInput)}" placeholder="${selCount?'Add more...':'Type numbers: 1, 2, 3...'}" autocomplete="off"></div>`;
      h+=`<div style="font-size:10px;color:var(--t5);margin-top:4px">Comma/Enter to add Â· Backspace to remove last</div>`;
    } else {
      h+=`<div style="display:flex;gap:8px;align-items:flex-end">
        <div style="flex:1"><div style="font-size:10px;color:var(--t5);margin-bottom:4px">From</div>
          <div style="display:flex;align-items:center;gap:4px"><span style="font-size:11px;color:${bt.color};font-weight:700;font-family:var(--fm)">${esc(snPrefix)}</span>
          <input type="number" inputmode="numeric" id="bulkRangeS" class="etin" value="${escA(S.bulkRangeStart)}" placeholder="1" style="font-size:14px;padding:10px;text-align:center"></div></div>
        <div style="font-size:16px;color:var(--t5);padding-bottom:12px">â†’</div>
        <div style="flex:1"><div style="font-size:10px;color:var(--t5);margin-bottom:4px">To</div>
          <div style="display:flex;align-items:center;gap:4px"><span style="font-size:11px;color:${bt.color};font-weight:700;font-family:var(--fm)">${esc(snPrefix)}</span>
          <input type="number" inputmode="numeric" id="bulkRangeE" class="etin" value="${escA(S.bulkRangeEnd)}" placeholder="10" style="font-size:14px;padding:10px;text-align:center"></div></div>
        <button class="savb savA" style="padding:10px 16px;margin:0;font-size:13px;white-space:nowrap" onclick="bulkAddRange()">+ Add</button>
      </div>`;
    }

    // Selected summary + next button
    if(selCount>0){
      h+=`<div style="margin-top:12px;padding:10px 14px;border-radius:10px;background:rgba(91,110,234,.04);border:1px solid rgba(91,110,234,.1);display:flex;justify-content:space-between;align-items:center">
        <div><span style="font-size:14px;font-weight:700;color:var(--ac)">${selCount}</span><span style="font-size:12px;color:var(--t3);margin-left:6px">unit${selCount!==1?'s':''} selected</span></div>
        <button class="bulk-change" onclick="S.bulkSelected=new Set();render()">Clear all</button>
      </div>`;
      h+=`<button class="savb savA" style="width:100%;margin-top:16px" onclick="S.bulkStep=3;S.bulkField=null;S.bulkValue='';render()">Next: Pick field â†’</button>`;
    } else {
      h+=`<div style="margin-top:16px;padding:14px;border-radius:10px;background:var(--inp);border:1px solid var(--bd);text-align:center;font-size:12px;color:var(--t4)">Add unit numbers above to continue</div>`;
    }
  }

  else if(step===3){
    // Step 3: Pick field + set value
    const bt=BULK_TYPES.find(t=>t.dk===S.bulkDK);
    if(!bt){S.bulkStep=1;render();return;}
    const rows=DATA[S.bulkDK]||[];
    const sf=getSNField(rows);
    const selCount=S.bulkSelected.size;

    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
      <span style="font-size:16px">${bt.icon}</span>
      <span style="font-size:13px;font-weight:600;color:${bt.color}">${bt.label}</span>
      <span style="font-size:11px;color:var(--t3)">Â·</span>
      <span style="font-size:12px;color:var(--ac);font-weight:600">${selCount} unit${selCount!==1?'s':''}</span>
    </div>`;

    if(!S.bulkField){
      // Sub-step 3a: Pick field
      const fields=getBulkFields(S.bulkDK);
      const ecnFields=fields.filter(f=>f.isECN&&isECNVisible(S.bulkDK,f.name));
      const regFields=fields.filter(f=>!f.isECN&&!f.perUnit);
      const perUnitFields=fields.filter(f=>f.perUnit);

      // Count issues only for selected units
      const selRows=rows.filter(r=>S.bulkSelected.has(r[sf]));
      function issuesFor(fname){return selRows.filter(item=>checkFieldComp(S.bulkDK,fname,item[fname])).length;}

      if(regFields.length){
        h+=`<div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin:12px 0 6px">BATCH FIELDS <span style="color:var(--t5);font-weight:400">(same value for all)</span></div>`;
        regFields.forEach(f=>{
          const typeIcon=f.type==='checkbox'?'â˜‘ï¸':f.type==='date'?'ðŸ“…':f.type==='dropdown'?'â–¾':'ðŸ“';
          const needs=issuesFor(f.name);
          const cid=regComp('bulk',S.bulkDK,f.name);
          h+=`<div class="bulk-field" onclick="doComp(${cid})">
            <span class="bulk-field-type">${typeIcon}</span>
            <span class="bulk-field-name">${esc(FIELD_LABELS[f.name]||f.name)}</span>
            ${needs?`<span class="comp-tag">${needs}/${selCount} âš </span>`:''}
          </div>`;
        });
      }

      if(ecnFields.length){
        h+=`<div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin:12px 0 6px">ECN FIELDS</div>`;
        ecnFields.forEach(f=>{
          const typeIcon=f.type==='checkbox'?'â˜':f.type==='date'?'ðŸ“…':'ðŸ“';
          const needs=issuesFor(f.name);
          const cid=regComp('bulk',S.bulkDK,f.name);
          h+=`<div class="bulk-field" onclick="doComp(${cid})">
            <span class="bulk-field-type">${typeIcon}</span>
            <span class="bulk-field-name">${esc(f.name)}</span>
            ${needs?`<span class="comp-tag">${needs}/${selCount} âš </span>`:''}
          </div>`;
        });
      }

      if(perUnitFields.length){
        h+=`<div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin:12px 0 6px">PER-UNIT FIELDS <span style="color:var(--t5);font-weight:400">(unique value each)</span></div>`;
        perUnitFields.forEach(f=>{
          const needs=issuesFor(f.name);
          const emptyCount=selRows.filter(item=>!(item[f.name]||'').trim()).length;
          const cid=regComp('bulk',S.bulkDK,f.name);
          h+=`<div class="bulk-field" onclick="doComp(${cid})" style="border-left:2px solid var(--yel)">
            <span class="bulk-field-type">âœï¸</span>
            <span class="bulk-field-name">${esc(FIELD_LABELS[f.name]||f.name)}</span>
            ${emptyCount?`<span class="comp-tag" style="background:rgba(251,191,36,.1);color:var(--yel)">${emptyCount} empty</span>`:''}
            ${needs?`<span class="comp-tag">${needs}/${selCount} âš </span>`:''}
          </div>`;
        });
      }
    } else {
      // Sub-step 3b: Set value for selected field
      const sk=bt.sk;

      h+=`<div style="display:flex;align-items:center;gap:6px;margin:8px 0 12px;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--t2);font-family:var(--fm)">${esc(FIELD_LABELS[S.bulkField]||S.bulkField)}</span>
        ${S.bulkIsPerUnit?'<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(251,191,36,.1);color:var(--yel);font-weight:600">PER-UNIT</span>':''}
        <button class="bulk-change" onclick="S.bulkField=null;S.bulkValue='';S.bulkIsPerUnit=false;S.bulkPerUnit={};render()">Change field</button>
      </div>`;

      if(S.bulkIsPerUnit){
        // Per-unit mode: individual input per unit
        h+=`<div style="font-size:10px;color:var(--yel);font-weight:600;letter-spacing:1px;margin:8px 0 8px">ENTER VALUE FOR EACH UNIT</div>`;
        let idx=0;
        const sortedSNs=[...S.bulkSelected].sort();
        sortedSNs.forEach(sn=>{
          const curVal=S.bulkPerUnit[sn]||'';
          const compI=checkFieldComp(S.bulkDK,S.bulkField,curVal);
          const snShort=sn.replace(/^.*?-(\d+)$/,'$1');
          h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;${compI?'border-left:3px solid var(--red);padding-left:8px':''}">
            <span style="font-size:11px;color:var(--t3);font-family:var(--fm);min-width:50px;white-space:nowrap" title="${esc(sn)}">${esc(sn.length>20?'...'+sn.slice(-15):sn)}</span>
            <input type="text" class="etin bulk-pu-input" data-sn="${escA(sn)}" value="${escA(curVal)}" placeholder="Enter value..." style="flex:1;padding:8px 10px;font-size:13px">
            ${compI?'<span style="font-size:10px;color:var(--red)">âš </span>':''}
          </div>`;
          idx++;
        });

        const changed=sortedSNs.filter(sn=>{
          const origRow=(DATA[S.bulkDK]||[]).find(r=>r[sf]===sn);
          const orig=origRow?origRow[S.bulkField]||'':'';
          return(S.bulkPerUnit[sn]||'')!==orig;
        }).length;

        h+=`<button class="savb ${changed?'savA':'savI'}" style="width:100%;margin-top:12px" onclick="doBulkSavePerUnit()">${S.bulkSaving?'Saving...':changed?`Save ${changed} change${changed>1?'s':''}`:'Edit values above'}</button>`;
      } else {
        // Same-value mode (existing)
        const fType=isECNField(S.bulkField)?guessECNType(sk,S.bulkField):getV(sk,S.bulkField);
        const isChk=fType?.type==='checkbox';
        const isDt=fType?.type==='date';
        const isDr=fType?.type==='dropdown';
        const bv=S.bulkValue;

        h+=`<div style="font-size:10px;color:var(--ac);font-weight:600;letter-spacing:1px;margin:8px 0 8px">SET NEW VALUE</div>`;
        if(isChk){
          h+=`<div style="display:flex;gap:10px;margin-bottom:12px">
            ${['TRUE','FALSE'].map(v=>{const sel=bv===v;const p=v==='TRUE';const col=p?'var(--grn)':'var(--red)';
            return`<div class="bulk-val ${sel?'bulk-val-on':''}" style="${sel?`border-color:${col};background:${col}08`:''}" onclick="S.bulkValue='${v}';render()">
              <span class="ckd ${p?'ckP':'ckF'}" style="width:28px;height:28px;font-size:16px">${p?'âœ“':'âœ—'}</span>
              <span style="font-size:12px;font-weight:600;color:${sel?col:'var(--t3)'}">${p?'Done':'Not Done'}</span>
            </div>`;}).join('')}
          </div>`;
        } else if(isDt){
          const today=new Date();const todayStr=`${today.getFullYear()}/${String(today.getMonth()+1).padStart(2,'0')}/${String(today.getDate()).padStart(2,'0')}`;
          const yest=new Date();yest.setDate(yest.getDate()-1);const yestStr=`${yest.getFullYear()}/${String(yest.getMonth()+1).padStart(2,'0')}/${String(yest.getDate()).padStart(2,'0')}`;
          h+=`<div style="display:flex;gap:8px;margin-bottom:8px">
            <div class="bulk-val ${bv===todayStr?'bulk-val-on':''}" onclick="S.bulkValue='${todayStr}';render()"><span style="font-size:16px">ðŸ“…</span><span style="font-size:11px;font-weight:600;color:${bv===todayStr?'var(--blu)':'var(--t3)'}">Today</span><span style="font-size:9px;color:var(--t4)">${todayStr}</span></div>
            <div class="bulk-val ${bv===yestStr?'bulk-val-on':''}" onclick="S.bulkValue='${yestStr}';render()"><span style="font-size:16px">ðŸ“…</span><span style="font-size:11px;font-weight:600;color:${bv===yestStr?'var(--blu)':'var(--t3)'}">Yesterday</span><span style="font-size:9px;color:var(--t4)">${yestStr}</span></div>
          </div>
          <input type="date" class="edin" id="bulkDate" value="${(bv||'').replace(/\//g,'-')}" style="margin-bottom:8px">`;
        } else if(isDr&&fType?.options){
          h+=`<div style="display:flex;flex-direction:column;gap:4px;margin-bottom:12px;max-height:200px;overflow-y:auto">${fType.options.map(o=>{const sel=bv===o;return`<div class="do ${sel?'doS':''}" onclick="S.bulkValue='${escA(o)}';render()"><div class="doi"><div class="dor ${sel?'dorS':''}">${sel?'<div class="dorD"></div>':''}</div><span class="dot ${sel?'dotS':''}">${esc(o)}</span></div></div>`;}).join('')}</div>`;
        } else {
          h+=`<input type="text" class="etin" id="bulkText" value="${escA(bv)}" placeholder="Enter value..." style="margin-bottom:12px">`;
        }

        const hasChange=bv!=='';
        h+=`<button class="savb ${hasChange?'savA':'savI'}" style="width:100%;margin-top:12px" onclick="doBulkSave()">${S.bulkSaving?'Saving...':hasChange?`Apply to ${selCount} unit${selCount>1?'s':''}`:'Select a value above'}</button>`;
      }
    }
  }

  app().innerHTML=`${rUBar()}<div style="min-height:100vh">
    <div class="rh"><button class="rbk" onclick="bulkBack()">â† Back</button><div class="rid">âš¡ Batch Update</div></div>
    <div style="padding:16px">${h}</div>
  </div>${rToast()}`;

  // Event listeners
  const bd=$('#bulkDate');if(bd)bd.addEventListener('change',e=>{S.bulkValue=e.target.value.replace(/-/g,'/');});
  const btt=$('#bulkText');if(btt)btt.addEventListener('input',e=>{S.bulkValue=e.target.value;});
  const bni=$('#bulkNumIn');if(bni){
    bni.addEventListener('input',e=>{S.bulkNumInput=e.target.value.replace(/[^0-9,\s]/g,'');});
    bni.addEventListener('keydown',bulkNumKeydown);
    setTimeout(()=>bni.focus(),50);
  }
  const brs=$('#bulkRangeS');if(brs)brs.addEventListener('input',e=>{S.bulkRangeStart=e.target.value;});
  const bre=$('#bulkRangeE');if(bre)bre.addEventListener('input',e=>{S.bulkRangeEnd=e.target.value;});
  // Per-unit inputs
  document.querySelectorAll('.bulk-pu-input').forEach(inp=>{
    inp.addEventListener('input',e=>{S.bulkPerUnit[e.target.dataset.sn]=e.target.value;});
  });
}

function togBulkUnit(sn){
  if(S.bulkSelected.has(sn))S.bulkSelected.delete(sn);else S.bulkSelected.add(sn);render();
}

// Find row S/N by numeric suffix
function findSNByNum(dk,num){
  const rows=DATA[dk]||[];const sf=getSNField(rows);
  const r=rows.find(r=>{const m=(r[sf]||'').match(/(\d+)$/);return m&&parseInt(m[1])===num;});
  return r?r[sf]:null;
}

// Add units by number(s)
function bulkAddNums(numsStr){
  if(!S.bulkDK)return;
  const nums=numsStr.split(/[,\s]+/).map(s=>parseInt(s.trim())).filter(n=>!isNaN(n)&&n>0);
  let added=0;
  nums.forEach(n=>{
    const sn=findSNByNum(S.bulkDK,n);
    if(sn&&!S.bulkSelected.has(sn)){S.bulkSelected.add(sn);added++;}
  });
  S.bulkNumInput='';
  if(added)render();
  else if(nums.length)showToast('No matching units found','error');
}

function bulkNumKeydown(e){
  if(e.key==='Enter'||e.key===','||e.key===' '){
    e.preventDefault();
    if(S.bulkNumInput.trim())bulkAddNums(S.bulkNumInput);
  } else if(e.key==='Backspace'&&!S.bulkNumInput&&S.bulkSelected.size){
    // Remove last added
    const arr=[...S.bulkSelected];
    S.bulkSelected.delete(arr[arr.length-1]);
    render();
  }
}

function bulkAddRange(){
  const s=parseInt(S.bulkRangeStart),e=parseInt(S.bulkRangeEnd);
  if(isNaN(s)||isNaN(e)||s<1||e<s){showToast('Invalid range','error');return;}
  if(e-s>500){showToast('Range too large (max 500)','error');return;}
  let added=0;
  for(let i=s;i<=e;i++){
    const sn=findSNByNum(S.bulkDK,i);
    if(sn&&!S.bulkSelected.has(sn)){S.bulkSelected.add(sn);added++;}
  }
  S.bulkRangeStart='';S.bulkRangeEnd='';
  if(added){showToast(`Added ${added} units`);render();}
  else showToast('No matching units in range','error');
}

function bulkSelectIssues(){
  if(!S.bulkDK||!S.bulkField)return;
  const rows=DATA[S.bulkDK]||[];const sf=getSNField(rows);
  S.bulkSelected=new Set();
  rows.forEach(r=>{
    if(checkFieldComp(S.bulkDK,S.bulkField,r[S.bulkField]))S.bulkSelected.add(r[sf]);
  });
  S.bulkInputMode='issues';
  render();
}

function selectAllBulk(){
  const rows=DATA[S.bulkDK]||[];const sf=getSNField(rows);
  S.bulkSelected=new Set(rows.map(r=>r[sf]).filter(Boolean));render();
}

function bulkBack(){
  if(S.bulkStep===3&&S.bulkField){S.bulkField=null;S.bulkValue='';S.bulkIsPerUnit=false;S.bulkPerUnit={};render();}
  else if(S.bulkStep===3){S.bulkStep=2;render();}
  else if(S.bulkStep===2){S.bulkStep=1;S.bulkDK=null;S.bulkSelected=new Set();render();}
  else{S.screen='search';render();}
}

async function doBulkSave(){
  if(!S.bulkDK||!S.bulkField||!S.bulkValue||S.bulkSaving||!S.bulkSelected.size)return;

  const dk=S.bulkDK;
  const field=S.bulkField;
  const rows=DATA[dk]||[];
  const sf=getSNField(rows);
  const meta=SHEET_META[dk];
  if(!meta){showToast('No sheet metadata','error');return;}

  S.bulkSaving=true;render();
  showToast(`Saving to ${S.bulkSelected.size} units...`);

  function colLetter(n){let s='';while(n>=0){s=String.fromCharCode(65+(n%26))+s;n=Math.floor(n/26)-1;}return s;}
  const colIdx=meta.headers.indexOf(field);
  if(colIdx===-1){showToast('Column not found','error');S.bulkSaving=false;return;}
  const colL=colLetter(colIdx);

  let ok=0,fail=0;
  const selectedItems=rows.filter(r=>S.bulkSelected.has(r[sf]));

  for(const item of selectedItems){
    const sheetRow=meta.startRow+1+item._rowIdx;
    const cellRef=`${meta.tabName}!${colL}${sheetRow}`;
    try{
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(cellRef)}?valueInputOption=USER_ENTERED`;
      let resp=await fetch(url,{method:'PUT',headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[S.bulkValue]]})});
      if(resp.status===401&&ok===0){
        // Refresh token once on first 401
        const origCb=tokenClient.callback;let done=false;
        await new Promise((resolve,reject)=>{
          tokenClient.callback=r=>{if(done)return;done=true;tokenClient.callback=origCb;if(r.access_token){accessToken=r.access_token;localStorage.setItem('gat',accessToken);resolve();}else reject(new Error('Auth failed'));};
          tokenClient.requestAccessToken({prompt:''});
          setTimeout(()=>{if(!done){done=true;tokenClient.callback=origCb;reject(new Error('Timeout'));}},15000);
        });
        resp=await fetch(url,{method:'PUT',headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[S.bulkValue]]})});
      }
      if(resp.ok){item[field]=S.bulkValue;ok++;}else{fail++;}
    }catch{fail++;}
  }

  S.bulkSaving=false;
  if(S.result?.ghost)S.tree=getGhostTree(S.result.ghost);
  if(fail)showToast(`${ok} saved, ${fail} failed`,'error');
  else showToast(`âœ“ ${ok} units updated`);
  render();
}
async function doBulkSavePerUnit(){
  if(!S.bulkDK||!S.bulkField||S.bulkSaving)return;

  const dk=S.bulkDK;
  const field=S.bulkField;
  const rows=DATA[dk]||[];
  const sf=getSNField(rows);
  const meta=SHEET_META[dk];
  if(!meta){showToast('No sheet metadata','error');return;}

  function colLetter(n){let s='';while(n>=0){s=String.fromCharCode(65+(n%26))+s;n=Math.floor(n/26)-1;}return s;}
  const colIdx=meta.headers.indexOf(field);
  if(colIdx===-1){showToast('Column not found','error');return;}
  const colL=colLetter(colIdx);

  // Find changed rows
  const changes=[];
  [...S.bulkSelected].forEach(sn=>{
    const row=rows.find(r=>r[sf]===sn);if(!row)return;
    const oldVal=row[field]||'';
    const newVal=S.bulkPerUnit[sn]||'';
    if(newVal!==oldVal)changes.push({sn,row,oldVal,newVal});
  });

  if(!changes.length){showToast('No changes to save');return;}

  S.bulkSaving=true;render();
  showToast(`Saving ${changes.length} changes...`);

  let ok=0,fail=0;
  for(const c of changes){
    const sheetRow=meta.startRow+1+c.row._rowIdx;
    const cellRef=`${meta.tabName}!${colL}${sheetRow}`;
    try{
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(cellRef)}?valueInputOption=USER_ENTERED`;
      let resp=await fetch(url,{method:'PUT',headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[c.newVal]]})});
      if(resp.status===401&&ok===0){
        const origCb=tokenClient.callback;let done=false;
        await new Promise((resolve,reject)=>{
          tokenClient.callback=r=>{if(done)return;done=true;tokenClient.callback=origCb;if(r.access_token){accessToken=r.access_token;localStorage.setItem('gat',accessToken);resolve();}else reject(new Error('Auth failed'));};
          tokenClient.requestAccessToken({prompt:''});
          setTimeout(()=>{if(!done){done=true;tokenClient.callback=origCb;reject(new Error('Timeout'));}},15000);
        });
        resp=await fetch(url,{method:'PUT',headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[c.newVal]]})});
      }
      if(resp.ok){
        c.row[field]=c.newVal;ok++;
        // Auto-add exchange note for S/N fields
        if(isSNField(field)&&c.oldVal&&c.oldVal!==c.newVal){
          const noteText=`${c.oldVal} â†’ ${c.newVal}ã€€äº¤æ›`;
          addCellNote(dk,c.row._rowIdx,colIdx,noteText).catch(e=>console.warn('[Note]',e));
        }
      }else{fail++;}
    }catch{fail++;}
  }

  S.bulkSaving=false;
  if(S.result?.ghost)S.tree=getGhostTree(S.result.ghost);
  if(fail)showToast(`${ok} saved, ${fail} failed`,'error');
  else showToast(`âœ“ ${ok} changes saved`);
  // Update per-unit values from saved data
  rows.forEach(r=>{if(S.bulkSelected.has(r[sf]))S.bulkPerUnit[r[sf]]=r[field]||'';});
  render();
}
async function doRefresh(){S.refreshing=true;render();S.loadErrors=await loadAllData((l,t,c)=>{LP={l,t,c};});S.refreshing=false;showToast('Data refreshed');render();}
function showToast(msg,type='success'){S.toast={msg,type};render();setTimeout(()=>{S.toast=null;render();},3000);}

// ===== INIT =====
window.onload=function(){render();
  function initGA(){if(typeof google==='undefined'||!google.accounts){setTimeout(initGA,200);return;}
    tokenClient=google.accounts.oauth2.initTokenClient({client_id:CONFIG.CLIENT_ID,scope:CONFIG.SCOPES,callback:r=>{if(r.access_token){accessToken=r.access_token;localStorage.setItem('gat',accessToken);fetchUser();}}});
    const su=localStorage.getItem('gau'),st=localStorage.getItem('gat');
    if(su&&st){currentUser=JSON.parse(su);accessToken=st;
      // Re-apply config to ensure isAdmin is current
      const cfg=CONFIG.APPROVED_USERS[currentUser.email];
      if(cfg){currentUser.isAdmin=cfg.isAdmin;currentUser.team=cfg.team;currentUser.name=cfg.name;localStorage.setItem('gau',JSON.stringify(currentUser));valToken();}
      else doLogout();}
  }initGA();};
</script>
</body>
</html>
