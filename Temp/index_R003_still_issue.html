<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ghost Assembly Tracker</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg-root: #0a0b12;
    --bg-card: #0d0e18;
    --bg-input: #12131e;
    --border-dim: #14152a;
    --border-base: #1e2130;
    --border-bright: #2a2d3e;
    --text-primary: #e2e4ed;
    --text-secondary: #8b8fa7;
    --text-dim: #6b7094;
    --text-muted: #4d5070;
    --text-faint: #3d4060;
    --text-ghost: #2d3050;
    --accent: #5b6eea;
    --accent-hover: #7c5cf6;
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
    --blue: #38bdf8;
    --orange: #fb923c;
    --purple: #a78bfa;
    --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-mono: 'Courier New', Courier, monospace;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; }
  body { background:var(--bg-root); color:var(--text-primary); font-family:var(--font-body); -webkit-font-smoothing:antialiased; overflow-x:hidden; }

  /* LOGIN */
  .login-screen { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; }
  .login-bg { position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse at 50% 30%, rgba(91,110,234,0.1) 0%, transparent 70%); }
  .login-card { position:relative; z-index:1; width:100%; max-width:380px; text-align:center; }
  .login-logo { width:80px; height:80px; border-radius:24px; margin:0 auto 24px; background:linear-gradient(135deg,var(--accent),var(--accent-hover)); display:flex; align-items:center; justify-content:center; font-size:42px; box-shadow:0 12px 48px rgba(91,110,234,0.3); }
  .login-title { font-size:26px; font-weight:700; letter-spacing:-0.5px; margin-bottom:8px; }
  .login-subtitle { color:var(--text-dim); font-size:14px; margin-bottom:32px; line-height:1.5; }
  .login-btn { width:100%; padding:16px 24px; border-radius:14px; border:none; background:#4285f4; color:#fff; font-size:16px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:background 0.15s; font-family:var(--font-body); }
  .login-btn:hover { background:#3367d6; }
  .login-btn svg { width:20px; height:20px; }
  .login-divider { display:flex; align-items:center; margin:20px 0; color:var(--text-faint); font-size:12px; }
  .login-divider::before,.login-divider::after { content:''; flex:1; height:1px; background:var(--border-base); margin:0 12px; }
  .login-guest-btn { width:100%; padding:14px 24px; border-radius:14px; border:1px solid var(--border-base); background:var(--bg-input); color:var(--text-secondary); font-size:15px; font-weight:500; cursor:pointer; font-family:var(--font-body); }
  .login-guest-btn:hover { border-color:var(--green); color:var(--green); }
  .login-error { margin-top:16px; padding:12px 16px; border-radius:10px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.2); color:var(--red); font-size:13px; line-height:1.5; display:none; white-space:pre-line; }
  .guest-section { display:none; width:100%; max-width:380px; position:relative; z-index:1; flex-direction:column; align-items:center; }
  .guest-input { width:100%; padding:14px 18px; border-radius:12px; margin-bottom:12px; border:1px solid var(--border-base); background:var(--bg-input); color:var(--text-primary); font-size:16px; outline:none; font-family:var(--font-body); }
  .guest-input:focus { border-color:var(--green); }
  .guest-continue-btn { width:100%; padding:14px; border-radius:12px; border:none; background:var(--green); color:#fff; font-size:15px; font-weight:600; cursor:pointer; font-family:var(--font-body); }
  .guest-continue-btn:disabled { background:var(--border-bright); color:var(--text-muted); cursor:default; }
  .guest-back { display:block; text-align:center; margin-top:12px; color:var(--accent); cursor:pointer; font-size:13px; background:none; border:none; font-family:var(--font-body); }

  /* USER BAR */
  .user-bar { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--bg-card); border-bottom:1px solid var(--border-dim); }
  .user-name { color:var(--text-secondary); font-size:13px; }
  .user-badge { font-size:10px; padding:2px 8px; border-radius:10px; margin-left:8px; font-weight:600; }
  .user-badge-admin { background:rgba(91,110,234,0.15); color:var(--accent); }
  .user-badge-team { background:rgba(167,139,250,0.15); color:var(--purple); }
  .user-badge-guest { background:rgba(52,211,153,0.15); color:var(--green); }
  .logout-btn { background:none; border:1px solid var(--border-base); color:var(--text-dim); padding:5px 12px; border-radius:6px; font-size:11px; cursor:pointer; font-family:var(--font-body); }
  .logout-btn:hover { border-color:var(--red); color:var(--red); }

  /* LOADING */
  .loading-screen { min-height:80vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; }
  .loading-spinner { width:48px; height:48px; border-radius:14px; background:linear-gradient(135deg,var(--accent),var(--accent-hover)); display:flex; align-items:center; justify-content:center; font-size:28px; animation:pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.08);opacity:0.8;} }
  .loading-text { color:var(--text-dim); font-size:14px; }
  .loading-progress { width:200px; height:3px; border-radius:2px; background:var(--border-base); overflow:hidden; }
  .loading-bar { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s ease; }
  .loading-detail { color:var(--text-faint); font-size:12px; font-family:var(--font-mono); }

  /* ERROR */
  .error-banner { margin:16px; padding:16px; border-radius:12px; background:rgba(248,113,113,0.06); border:1px solid rgba(248,113,113,0.15); color:var(--red); font-size:13px; line-height:1.5; }
  .error-banner code { display:block; margin-top:8px; padding:8px 12px; border-radius:8px; background:rgba(248,113,113,0.05); font-family:var(--font-mono); font-size:11px; word-break:break-all; color:var(--text-secondary); }

  /* SEARCH */
  .search-screen { min-height:100vh; display:flex; flex-direction:column; }
  .search-bg { position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse at 50% 20%, rgba(91,110,234,0.06) 0%, transparent 70%); }
  .search-content { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; position:relative; z-index:1; }
  .search-logo { width:72px; height:72px; border-radius:20px; background:linear-gradient(135deg,var(--accent),var(--accent-hover)); display:flex; align-items:center; justify-content:center; font-size:36px; margin-bottom:20px; box-shadow:0 12px 48px rgba(91,110,234,0.25); }
  .search-title { font-size:24px; font-weight:700; letter-spacing:-0.5px; margin-bottom:6px; }
  .search-subtitle { color:var(--text-dim); font-size:14px; margin-bottom:32px; text-align:center; max-width:340px; line-height:1.5; }
  .search-input-wrap { width:100%; max-width:400px; margin-bottom:12px; }
  .search-input { width:100%; padding:15px 18px; border-radius:14px; border:1px solid var(--border-base); background:var(--bg-input); color:var(--text-primary); font-size:16px; font-family:var(--font-mono); outline:none; transition:all 0.2s; }
  .search-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(91,110,234,0.12); }
  .search-input::placeholder { color:var(--text-muted); }
  .parse-preview { width:100%; max-width:400px; padding:8px 14px; border-radius:10px; background:rgba(91,110,234,0.06); border:1px solid rgba(91,110,234,0.12); margin-bottom:16px; display:flex; align-items:center; gap:8px; font-size:12px; }
  .parse-tag { font-size:11px; color:var(--accent); font-weight:600; }
  .btn-row { display:flex; gap:10px; width:100%; max-width:400px; }
  .btn { flex:1; padding:14px; border-radius:12px; border:none; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.15s; font-family:var(--font-body); }
  .btn-primary { background:linear-gradient(135deg,var(--accent),var(--accent-hover)); color:#fff; box-shadow:0 4px 20px rgba(91,110,234,0.25); }
  .btn-primary:hover { transform:translateY(-1px); }
  .btn-secondary { border:1px solid var(--border-base); background:var(--bg-input); color:var(--text-primary); }
  .btn-secondary:hover { border-color:var(--accent); }
  .formats-box { margin-top:32px; width:100%; max-width:400px; padding:16px; border-radius:12px; background:var(--bg-card); border:1px solid var(--border-dim); }
  .formats-title { font-size:11px; color:var(--text-faint); font-weight:600; margin-bottom:10px; letter-spacing:1px; }
  .format-row { display:flex; align-items:center; gap:10px; padding:6px 0; }
  .format-tag { padding:2px 6px; border-radius:4px; font-size:9px; font-weight:600; }
  .format-tag-qr { background:rgba(91,110,234,0.12); color:var(--accent); }
  .format-tag-type { background:rgba(251,191,36,0.12); color:var(--yellow); }
  .format-code { font-size:12px; color:var(--text-secondary); font-family:var(--font-mono); }
  .format-desc { font-size:11px; color:var(--text-faint); margin-left:auto; }
  .demo-section { margin-top:20px; text-align:center; }
  .demo-label { font-size:11px; color:var(--text-ghost); margin-bottom:8px; }
  .demo-chips { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; max-width:400px; }
  .demo-chip { padding:5px 10px; border-radius:6px; border:1px solid var(--border-dim); background:var(--bg-card); color:var(--text-dim); font-size:11px; font-family:var(--font-mono); cursor:pointer; transition:all 0.12s; }
  .demo-chip:hover { border-color:var(--accent); color:var(--accent); }
  .data-status { padding:4px 10px; border-radius:8px; font-size:10px; font-weight:600; display:inline-flex; align-items:center; gap:6px; }
  .data-status-live { background:rgba(52,211,153,0.1); border:1px solid rgba(52,211,153,0.2); color:var(--green); }
  .data-status-dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:blink 2s ease-in-out infinite; }
  @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  /* RESULT */
  .result-screen { min-height:100vh; }
  .result-header { display:flex; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border-dim); background:var(--bg-card); position:sticky; top:0; z-index:100; }
  .back-btn { background:none; border:none; color:var(--accent); font-size:13px; cursor:pointer; padding:6px 10px; border-radius:6px; font-family:var(--font-body); }
  .result-ghost-id { flex:1; text-align:center; font-size:14px; font-weight:700; font-family:var(--font-mono); }
  .live-badge { padding:3px 8px; border-radius:6px; font-size:10px; font-weight:600; background:rgba(52,211,153,0.1); color:var(--green); }
  .trace-box { margin:12px 16px 8px; padding:12px 14px; border-radius:10px; background:rgba(91,110,234,0.04); border:1px solid rgba(91,110,234,0.1); }
  .trace-title { font-size:10px; color:var(--text-faint); font-weight:600; letter-spacing:1px; margin-bottom:8px; }
  .trace-steps { display:flex; align-items:center; gap:4px; flex-wrap:wrap; }
  .trace-step { padding:3px 8px; border-radius:5px; font-size:12px; }
  .trace-step-first { background:rgba(91,110,234,0.15); color:var(--accent); font-weight:600; }
  .trace-step-rest { background:rgba(255,255,255,0.03); color:var(--text-dim); }
  .trace-arrow { color:var(--text-ghost); font-size:10px; }
  .trace-summary { font-size:11px; color:var(--text-muted); margin-top:8px; }
  .trace-summary .hl { color:var(--accent); font-family:var(--font-mono); }
  .trace-summary .hl2 { color:var(--text-secondary); font-family:var(--font-mono); }
  .val-legend { margin:4px 16px 8px; display:flex; gap:8px; flex-wrap:wrap; }
  .val-tag { display:flex; align-items:center; gap:4px; padding:4px 8px; border-radius:6px; font-size:9px; font-weight:600; }
  .val-tag-desc { font-size:10px; color:var(--text-muted); font-weight:400; }
  .section-divider { padding:6px 12px; margin:0 0 8px; border-radius:8px; display:flex; align-items:center; gap:6px; font-size:10px; font-weight:700; letter-spacing:1px; }
  .section-divider-match { background:rgba(91,110,234,0.06); border:1px solid rgba(91,110,234,0.1); color:var(--accent); }
  .section-divider-other { background:rgba(255,255,255,0.02); border:1px solid var(--border-dim); color:var(--text-faint); }
  .section-divider-hint { font-weight:400; color:var(--text-faint); }
  .sections-wrap { padding:4px 16px 100px; }
  .section-card { margin-bottom:6px; }
  .section-header { display:flex; align-items:center; gap:12px; padding:14px 16px; cursor:pointer; transition:all 0.15s; }
  .section-icon { font-size:22px; line-height:1; }
  .section-info { flex:1; min-width:0; }
  .section-label { font-size:14px; font-weight:600; }
  .section-sns { font-size:11px; color:var(--text-dim); margin-top:2px; font-family:var(--font-mono); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .match-badge { padding:2px 8px; border-radius:6px; font-size:10px; font-weight:600; }
  .section-chevron { font-size:11px; color:var(--text-faint); transition:transform 0.2s; }
  .section-chevron-open { transform:rotate(180deg); }
  .field-group { padding-top:4px; padding-bottom:4px; }
  .field-group-label { padding:6px 16px; font-size:11px; font-weight:600; opacity:0.7; font-family:var(--font-mono); }
  .field-row { display:flex; justify-content:space-between; align-items:center; padding:11px 16px; cursor:pointer; border-radius:8px; border-left:3px solid transparent; transition:all 0.12s; margin:0 4px; }
  .field-row:hover { background:rgba(255,255,255,0.03); }
  .field-row-highlight { background:rgba(91,110,234,0.08); border-left-color:var(--accent); }
  .field-left { display:flex; align-items:center; gap:8px; min-width:0; }
  .field-label { font-size:13px; color:var(--text-dim); flex-shrink:0; }
  .field-right { display:flex; align-items:center; gap:8px; }
  .field-value { font-size:13px; color:var(--text-secondary); text-align:right; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .field-value-sn { color:var(--text-primary); font-family:var(--font-mono); font-weight:600; }
  .field-edit-icon { font-size:10px; color:var(--text-faint); flex-shrink:0; }
  .inline-badge { font-size:9px; padding:1px 5px; border-radius:3px; font-weight:600; flex-shrink:0; }
  .badge-list { background:rgba(91,110,234,0.12); color:var(--accent); }
  .badge-check { background:rgba(251,191,36,0.12); color:var(--yellow); }
  .badge-date { background:rgba(56,189,248,0.12); color:var(--blue); }
  .check-display { width:22px; height:22px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:13px; }
  .check-pass { background:rgba(52,211,153,0.15); border:1.5px solid var(--green); color:var(--green); }
  .check-fail { background:rgba(248,113,113,0.1); border:1.5px solid rgba(248,113,113,0.35); color:var(--red); }

  /* EDIT */
  .edit-screen { min-height:100vh; display:flex; flex-direction:column; }
  .edit-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border-dim); background:var(--bg-card); }
  .cancel-btn { background:none; border:none; color:var(--red); font-size:13px; cursor:pointer; padding:6px 10px; font-family:var(--font-body); }
  .save-btn { background:none; border:none; color:var(--accent); font-size:13px; cursor:pointer; padding:6px 10px; font-weight:600; font-family:var(--font-body); }
  .edit-body { flex:1; display:flex; flex-direction:column; align-items:center; padding:24px; padding-top:32px; }
  .edit-context { display:flex; align-items:center; gap:8px; padding:8px 14px; border-radius:8px; margin-bottom:6px; }
  .edit-sn { font-size:11px; color:var(--text-faint); font-family:var(--font-mono); margin-bottom:20px; }
  .edit-field-name { display:flex; align-items:center; gap:8px; margin-bottom:16px; }
  .edit-field-label { font-size:15px; color:#b0b4cc; font-weight:500; }
  .edit-old-value { padding:8px 16px; border-radius:8px; margin-bottom:24px; background:rgba(248,113,113,0.04); border:1px solid rgba(248,113,113,0.1); font-family:var(--font-mono); font-size:13px; color:var(--red); text-decoration:line-through; opacity:0.5; width:100%; max-width:380px; text-align:center; }
  .edit-input-wrap { width:100%; max-width:380px; }
  .edit-input-label { font-size:10px; color:var(--text-faint); font-weight:600; letter-spacing:1px; margin-bottom:8px; }
  .edit-text-input { width:100%; padding:16px 18px; border-radius:12px; border:2px solid var(--accent); background:var(--bg-input); color:var(--text-primary); font-size:18px; font-family:var(--font-mono); font-weight:600; outline:none; text-align:center; box-shadow:0 0 0 4px rgba(91,110,234,0.1); }
  .edit-date-input { width:100%; padding:16px 18px; border-radius:12px; border:2px solid var(--blue); background:var(--bg-input); color:var(--text-primary); font-size:18px; font-family:var(--font-mono); font-weight:600; outline:none; text-align:center; box-shadow:0 0 0 4px rgba(56,189,248,0.1); color-scheme:dark; }
  .date-quick-btns { display:flex; gap:8px; margin-top:12px; }
  .date-quick-btn { flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-base); background:var(--bg-input); color:var(--blue); font-size:13px; font-weight:500; cursor:pointer; font-family:var(--font-body); }
  .dropdown-list { display:flex; flex-direction:column; gap:4px; }
  .dropdown-option { padding:12px 16px; border-radius:10px; cursor:pointer; border:1px solid var(--border-base); background:var(--bg-input); display:flex; align-items:center; justify-content:space-between; transition:all 0.12s; }
  .dropdown-option-selected { border:2px solid var(--accent); background:rgba(91,110,234,0.1); }
  .dropdown-option-inner { display:flex; align-items:center; gap:10px; }
  .radio-circle { width:20px; height:20px; border-radius:10px; border:2px solid var(--border-bright); display:flex; align-items:center; justify-content:center; }
  .radio-circle-selected { border-color:var(--accent); }
  .radio-dot { width:10px; height:10px; border-radius:5px; background:var(--accent); }
  .dropdown-option-text { font-size:14px; font-family:var(--font-mono); font-weight:500; color:var(--text-secondary); }
  .dropdown-option-text-selected { color:var(--text-primary); }
  .current-tag { font-size:9px; padding:2px 6px; border-radius:4px; background:rgba(251,191,36,0.1); color:var(--yellow); font-weight:600; }
  .check-options { display:flex; gap:12px; }
  .check-option { flex:1; padding:24px 16px; border-radius:14px; cursor:pointer; text-align:center; border:1px solid var(--border-base); background:var(--bg-input); transition:all 0.15s; }
  .check-icon-wrap { width:56px; height:56px; border-radius:16px; margin:0 auto 12px; display:flex; align-items:center; justify-content:center; font-size:28px; background:rgba(255,255,255,0.03); border:2px solid var(--border-bright); color:var(--text-faint); }
  .check-option-label { font-size:14px; font-weight:600; color:var(--text-muted); }
  .save-action-btn { margin-top:28px; padding:14px 40px; border-radius:12px; border:none; font-size:15px; font-weight:600; cursor:pointer; font-family:var(--font-body); }
  .save-active { background:linear-gradient(135deg,var(--accent),var(--accent-hover)); color:#fff; box-shadow:0 4px 20px rgba(91,110,234,0.2); }
  .save-inactive { background:var(--border-base); color:var(--text-muted); cursor:default; }
  .edit-api-hint { margin-top:14px; font-size:11px; color:var(--text-ghost); text-align:center; }

  /* TOAST & REFRESH */
  .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); padding:10px 20px; border-radius:10px; font-size:13px; font-weight:500; z-index:999; box-shadow:0 8px 32px rgba(0,0,0,0.4); }
  .toast-success { background:#121e16; border:1px solid rgba(52,211,153,0.2); color:var(--green); }
  .toast-error { background:#1e1214; border:1px solid rgba(248,113,113,0.2); color:var(--red); }
  .refresh-btn { position:fixed; bottom:20px; right:20px; z-index:100; width:48px; height:48px; border-radius:14px; border:1px solid var(--border-base); background:var(--bg-card); color:var(--text-dim); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 16px rgba(0,0,0,0.3); }
  .refresh-btn:hover { border-color:var(--accent); color:var(--accent); }
  .refresh-spinning { animation:spin 1s linear infinite; }
  @keyframes spin { 100%{transform:rotate(360deg);} }
  .scan-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; }
  .scan-frame { width:200px; height:200px; border:2px solid rgba(91,110,234,0.27); border-radius:16px; position:relative; margin-bottom:24px; }
  .scan-line { position:absolute; left:8px; right:8px; height:2px; background:linear-gradient(90deg,transparent,var(--accent),transparent); animation:scanAnim 1.5s ease-in-out infinite; }
  @keyframes scanAnim { 0%,100%{top:10%;opacity:0.3;} 50%{top:85%;opacity:1;} }
</style>
</head>
<body>
<div id="app"></div>
<script>
// ===== CONFIGURATION (same pattern as inventory app) =====
const CONFIG = {
  CLIENT_ID: '1088099187141-ut0dn0scqt3h99htf3rg8gsrg2oo1ad8.apps.googleusercontent.com',
  SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
  SHEET_ID: '1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M',
  APPROVED_USERS: {
    'anikettelexistence@gmail.com': { name: 'Aniket', team: 'production', isAdmin: true },
    'igarashi@tx-inc.com': { name: 'Igarashi', team: 'production', isAdmin: false },
    'niidome@tx-inc.com': { name: 'Niidome', team: 'production', isAdmin: false },
  },
  TABS: {
    ghosts:'00_GHOST', lMotors:'01_L-motor', a12Motors:'02_A12-motor',
    a35Motors:'03_A35-motor', a4Motors:'04_A4-motor', mobileBases:'05_Mobile Base',
    pillars:'06_Pillar', headBodies:'07_Head & Body', grippers:'08_Gripper',
    arms:'09_Arm', deployKits:'10_Deploy Kit',
  },
};

// ===== AUTH STATE (same as inventory app) =====
let accessToken = null;
let tokenClient = null;
let currentUser = { name:'', email:'', isAdmin:false, isGuest:false, team:'' };

// ===== S/N PARSING =====
const ASSEMBLY_CODES={GST:{type:'ghost',label:'Ghost',sheet:'00_GHOST'},MBB:{type:'mobileBase',label:'Mobile Base',sheet:'05_Mobile Base'},PLR:{type:'pillar',label:'Pillar',sheet:'06_Pillar'},HBD:{type:'headBody',label:'Head & Body',sheet:'07_Head & Body'},GPR:{type:'gripper',label:'Gripper',sheet:'08_Gripper'},ARM:{type:'arm',label:'Arm',sheet:'09_Arm'},DPK:{type:'deployKit',label:'Deploy Kit',sheet:'10_Deploy Kit'},LAC:{type:'lMotor',label:'L-Motor',sheet:'01_L-motor'},A12:{type:'a12Motor',label:'A12 Motor',sheet:'02_A12-motor'},A35:{type:'a35Motor',label:'A35 Motor',sheet:'03_A35-motor'},A4A:{type:'a4Motor',label:'A4 Motor',sheet:'04_A4-motor'}};
const SHORTHAND_MAP={GH:'GST',GHOST:'GST',GST:'GST',MB:'MBB',MBB:'MBB',PL:'PLR',PLR:'PLR',PILLAR:'PLR',HB:'HBD',HBD:'HBD',HEAD:'HBD',GR:'GPR',GPR:'GPR',GRIP:'GPR',ARM:'ARM',DPK:'DPK',DK:'DPK',LM:'LAC',LAC:'LAC',A12:'A12',A35:'A35',A4:'A4A',A4A:'A4A',PDB:'PDB',IOB:'IOB',MDB:'MDB',BRK:'BRK',BAT:'BAT'};

function parseInput(raw){const input=raw.trim();if(!input)return null;const full=input.match(/^GT\d{3}-([A-Z0-9]{2,3})-(\d{3,5})$/i);if(full){const code=full[1].toUpperCase(),num=parseInt(full[2]),asm=ASSEMBLY_CODES[code];if(asm)return{...asm,num,fullSN:input.toUpperCase(),inputType:'qr'};}if(/^\d{5,6}$/.test(input))return{type:'galina',label:'GALINA',num:parseInt(input),fullSN:input,inputType:'manual'};const short=input.match(/^([A-Z]{2,6})[- ]?(\d+)$/i);if(short){const prefix=short[1].toUpperCase(),num=parseInt(short[2]),code=SHORTHAND_MAP[prefix];if(code&&ASSEMBLY_CODES[code])return{...ASSEMBLY_CODES[code],num,fullSN:`${prefix}-${num}`,inputType:'shorthand'};if(['PDB','IOB','MDB','BRK','BAT'].includes(prefix))return{type:prefix.toLowerCase(),label:prefix,num,fullSN:`${prefix}-${num}`,inputType:'shorthand'};}return null;}

// ===== SECTION CONFIG =====
const SECTION_CONFIG={ghost:{icon:'üëª',label:'Ghost',color:'#5b6eea',bg:'#151728'},mobileBase:{icon:'üõû',label:'Mobile Base',color:'#34d399',bg:'#13201a'},mbMotors:{icon:'‚öôÔ∏è',label:'L-Motors (MB)',color:'#6ee7b7',bg:'#131d19'},pillar:{icon:'üèõÔ∏è',label:'Pillar',color:'#a78bfa',bg:'#1a1528'},plMotors:{icon:'‚öôÔ∏è',label:'L-Motor (Pillar)',color:'#6ee7b7',bg:'#131d19'},headBody:{icon:'üß†',label:'Head & Body',color:'#f87171',bg:'#201414'},arm:{icon:'ü¶æ',label:'Arm',color:'#fbbf24',bg:'#201c12'},armA12:{icon:'‚öôÔ∏è',label:'A12 Motors',color:'#6ee7b7',bg:'#131d19'},armA35:{icon:'‚öôÔ∏è',label:'A35 Motor',color:'#6ee7b7',bg:'#131d19'},armA4:{icon:'‚öôÔ∏è',label:'A4 Motor',color:'#6ee7b7',bg:'#131d19'},gripper:{icon:'ü§è',label:'Gripper',color:'#38bdf8',bg:'#121a20'},deployKit:{icon:'üì¶',label:'Deploy Kit',color:'#fb923c',bg:'#1e1812'}};
const FIELD_LABELS={'S/N':'S/N','#':'#','SW':'SW Version','Endpoint':'Endpoint','Sora Time zone':'Sora TZ','SoraFW':'Sora FW','Sora FW':'Sora FW','FW':'FW Version','Mobile Base':'Mobile Base S/N','Pillar':'Pillar S/N','Body&Head':'Head & Body S/N','Arm':'Arm S/N','Deploy Kit':'Deploy Kit S/N','DPK#':'DPK #','ÊâãÈ†ÜÊõ∏ ver.':'SOP Ver.','SOP ver.':'SOP Ver.','M-BOM ver.':'M-BOM Ver.','ÁµÑÁ´ã‰∫∫Âì°':'Assembler','ÁµÑÁ´ã‰∫∫Âì° A4 reducer':'Assembler (A4R)','ÁµÑÁ´ã‰∫∫Âì° Êú¨‰Ωì':'Assembler (Main)','ÊôÇÈñì':'Time','ÊôÇÈñì A4R':'Time (A4R)','ÊôÇÈñì Êú¨‰Ωì':'Time (Main)','ÂÆå‰∫ÜÊó•':'Completed','ÂÇôËÄÉ':'Notes','ÂÆå‰∫Ü':'Done','Ê¢±ÂåÖÂÆå‰∫Ü':'Packing Done','setup':'Setup','token':'Token','ÈÖçÁΩÆ':'Placement','Âá∫Â∫´Êó•':'Issue Date','ÈÉ®ÁΩ≤':'Dept','ÁõÆÁöÑ':'Purpose','‰ΩøÁî®':'Usage','ÈÉ®ÂìÅÂá∫Â∫´Êó•':'Parts Issue Date','ÈÉ®ÂìÅ Âá∫Â∫´Êó•':'Parts Issue Date','ÁµÑÁ´ã ÊôÇÈñì':'Assy Time','ÁµÑÁ´ãÊôÇÈñì':'Assy Time','L1 motor S/N':'L1 Motor S/N','L2 motor S/N':'L2 Motor S/N','L3 motor S/N':'L3 Motor S/N','PDB S/N':'PDB S/N','PDB FW':'PDB FW','ECB Ver.':'ECB Ver.','L2 belt tension [N]':'L2 Belt Tension (N)','L3 belt tension (N)':'L3 Belt Tension (N)','BRK S/N':'Brake S/N','GALINA S/N':'GALINA S/N','AGX image':'AGX Image','IP':'IP Address','IOB S/N':'IOB S/N','IOB FW':'IOB FW','A1 motor S/N':'A1 Motor S/N','A2 motor S/N':'A2 Motor S/N','A3 motor S/N':'A3 Motor S/N','A4 motor S/N':'A4 Motor S/N','A5 motor S/N':'A5 Motor S/N','Gripper S/N':'Gripper S/N','BAT S/N':'Battery S/N','A4 belt tension':'A4 Belt Tension','MDB S/N':'MDB S/N','MDB FW':'MDB FW','enc':'Encoder','mod':'Mod','ÊäµÊäó cNÔΩ•m':'Resistance (cN¬∑m)','encM':'Encoder M','GANTRYÈï∑„Åï':'Gantry Length','pick up config':'Pickup Config','ÂØæÂøú„ÅÆ':'For','stator frame':'Stator Frame','rotor frame':'Rotor Frame','motor cap':'Motor Cap','fail status':'Fail Status','fail status/comment':'Fail Status'};
const SKIP_FIELDS=new Set(['#']);
// Also skip columns that are just numbers (ECN refs like 110, 214) or ECN tracking headers
function shouldSkipField(field) {
  if (SKIP_FIELDS.has(field)) return true;
  if (/^\d+$/.test(field)) return true; // pure numbers like 110, 214, 298
  if (/^(ÂÖ±ÈÄö|ÁâπÂÆö)$/.test(field)) return true;
  if (field.includes('ECN') && (field.includes('ÂØæÂøú') || field.includes('Ëá™ÂãïÂÖ•Âäõ'))) return true;
  if (field.startsWith('GP-ECN-') || field.startsWith('ECN-') || field.startsWith('ecn-')) return true;
  if (/^\d+\.\d+\.\d+/.test(field)) return true; // version-as-column like "2.0.0.0"
  if (field.startsWith('__')) return true;
  return false;
}

// ===== VALIDATION =====
const VALIDATIONS={
  'ghost.SW':{type:'dropdown',options:['v3.0.0','v3.1.0','v3.1.9','v3.2.0','v3.2.1','v3.3.0']},
  'ghost.SoraFW':{type:'dropdown',options:['2.0.0','2.0.5','2.0.8','2.1.0','2.1.1']},
  'ghost.Sora FW':{type:'dropdown',options:['2.0.0','2.0.5','2.0.8','2.1.0','2.1.1']},
  'ghost.FW':{type:'dropdown',options:['3.9.0','4.0.0','4.0.1','4.1.0']},
  'ghost.Sora Time zone':{type:'dropdown',options:['Asia/Tokyo','America/New_York','Europe/London','America/Los_Angeles']},
  'ghost.ÂÆå‰∫ÜÊó•':{type:'date'},
  'mobileBase.PDB FW':{type:'dropdown',options:['1.9.0.0','1.9.1.0','1.9.2.0','2.0.0.0','2.1.0.0']},
  'mobileBase.ECB Ver.':{type:'dropdown',options:['v1.0','v1.1','v1.2','v1.3','v1.4']},
  'mobileBase.ÊâãÈ†ÜÊõ∏ ver.':{type:'dropdown',options:['v2.0','v2.1','v2.2','v2.3','v2.4']},
  'mobileBase.M-BOM ver.':{type:'dropdown',options:['v1.5','v1.6','v1.7','v1.8','v1.9']},
  'mobileBase.ÂÆå‰∫ÜÊó•':{type:'date'},
  'pillar.SOP ver.':{type:'dropdown',options:['v1.6','v1.7','v1.8','v1.9','v2.0']},
  'pillar.M-BOM ver.':{type:'dropdown',options:['v1.2','v1.3','v1.4','v1.5','v1.6']},
  'pillar.ÂÆå‰∫ÜÊó•':{type:'date'},
  'headBody.IOB FW':{type:'dropdown',options:['1.8.0.0','1.9.0.0','1.9.1.0','2.0.0.0','2.1.0.0']},
  'headBody.AGX image':{type:'dropdown',options:['r35.3.1','r35.4.1','r35.5.0','r36.0.0']},
  'headBody.‰ΩøÁî®SOP ver.':{type:'dropdown',options:['v1.8','v1.9','v2.0','v2.1','v2.2']},
  'headBody.M-BOM ver.':{type:'dropdown',options:['v1.3','v1.4','v1.5','v1.6','v1.7']},
  'headBody.ÂÆå‰∫ÜÊó•':{type:'date'},
  'arm.ÊâãÈ†ÜÊõ∏ ver.':{type:'dropdown',options:['v2.1','v2.2','v2.3','v2.4','v2.5']},
  'arm.M-BOM ver.':{type:'dropdown',options:['v1.6','v1.7','v1.8','v1.9','v2.0']},
  'arm.ÂÆå‰∫ÜÊó•':{type:'date'},
  'gripper.IOB FW':{type:'dropdown',options:['1.8.0.0','1.9.0.0','1.9.1.0','2.0.0.0','2.1.0.0']},
  'gripper.‰ΩøÁî®SOP ver.':{type:'dropdown',options:['v1.4','v1.5','v1.6','v1.7','v1.8']},
  'gripper.M-BOM ver.':{type:'dropdown',options:['v1.0','v1.1','v1.2','v1.3','v1.4']},
  'gripper.ÂÆå‰∫ÜÊó•':{type:'date'},
  'deployKit.ÊâãÈ†ÜÊõ∏ ver.':{type:'dropdown',options:['v1.0','v1.1','v1.2','v1.3']},
  'deployKit.M-BOM ver.':{type:'dropdown',options:['v1.0','v1.1','v1.2']},
  'deployKit.GANTRYÈï∑„Åï':{type:'dropdown',options:['900mm','1000mm','1100mm','1200mm','1300mm']},
  'deployKit.ÂÆå‰∫ÜÊó•':{type:'date'},
};
['mbMotors','plMotors','armA12','armA35','armA4'].forEach(mt=>{
  VALIDATIONS[`${mt}.MDB FW`]={type:'dropdown',options:['1.9.0.0','1.9.2.0','2.0.0.0','2.1.0.0']};
  VALIDATIONS[`${mt}.enc`]={type:'checkbox'};
  VALIDATIONS[`${mt}.ÂÆå‰∫ÜÊó•`]={type:'date'};
});
function getValidation(s,f){let v=VALIDATIONS[`${s}.${f}`];if(v)return v;const m={mbMotors:'mbMotors',plMotors:'plMotors',armA12:'armA12',armA35:'armA35',armA4:'armA4'};if(m[s]){v=VALIDATIONS[`${m[s]}.${f}`];if(v)return v;}if(f==='ÂÆå‰∫ÜÊó•'||f.toLowerCase().includes('date'))return{type:'date'};if(f==='enc')return{type:'checkbox'};return null;}

// ===== DATA (fetched via Sheets API with Bearer token, same as inventory app) =====
let DATA = {};
let LOADING = false;

async function fetchSheetTab(tabName) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(tabName)}`;
  const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
  if (!resp.ok) { const e=await resp.text().catch(()=>''); let msg=`HTTP ${resp.status}`; try{msg=JSON.parse(e).error?.message||msg;}catch{} throw new Error(msg); }
  const json = await resp.json();
  const raw = json.values || [];
  if (raw.length < 2) return [];
  const headers = raw[0];
  return raw.slice(1).map(row => {
    const obj = {}; let has = false;
    headers.forEach((h,i) => { if(h){ const v=row[i]!=null?String(row[i]):''; obj[h]=v; if(v)has=true; } });
    return has ? obj : null;
  }).filter(Boolean);
}

async function loadAllData(onProgress) {
  LOADING = true;
  const entries = Object.entries(CONFIG.TABS);
  const total = entries.length;
  let loaded = 0;
  const errors = [];
  // batchGet ‚Äî single request for all tabs
  try {
    const ranges = entries.map(([,tab]) => encodeURIComponent(tab));
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values:batchGet?${ranges.map(r=>`ranges=${r}`).join('&')}`;
    onProgress?.(0, total, 'Fetching all tabs...');
    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    (json.valueRanges || []).forEach((vr, idx) => {
      const [key] = entries[idx];
      const raw = vr.values || [];
      if (raw.length < 2) { DATA[key]=[]; loaded++; onProgress?.(loaded,total,entries[idx][1]); return; }
      const headers = raw[0];
      DATA[key] = raw.slice(1).map(row => {
        const obj={}; let has=false;
        headers.forEach((h,i)=>{ if(h){ const v=row[i]!=null?String(row[i]):''; obj[h]=v; if(v)has=true; } });
        return has?obj:null;
      }).filter(Boolean);
      loaded++;
      onProgress?.(loaded, total, entries[idx][1]);
    });
  } catch (batchErr) {
    console.warn('Batch failed, falling back:', batchErr);
    for (const [key, tabName] of entries) {
      try { onProgress?.(loaded,total,tabName); DATA[key]=await fetchSheetTab(tabName); loaded++; }
      catch(err) { errors.push({tab:tabName,error:err.message}); DATA[key]=[]; loaded++; }
    }
  }
  LOADING=false; onProgress?.(total,total,'Done'); return errors;
}

// ===== FIELD HELPERS =====
function getSNField(rows){if(!rows||!rows.length)return'sn';const keys=Object.keys(rows[0]);const k=keys.find(k=>/^s\/?n$/i.test(k.trim())||k==='sn');if(k)return k;for(const k2 of keys){if(rows.some(r=>/^GT\d{3}-[A-Z0-9]{2,3}-\d{3,5}$/i.test(r[k2]||'')))return k2;}return keys[0];}
function getField(row,...cs){for(const c of cs){if(row[c]!==undefined&&row[c]!=='')return row[c];const k=Object.keys(row).find(k2=>k2.toLowerCase().replace(/[\s_\/]/g,'')===c.toLowerCase().replace(/[\s_\/]/g,''));if(k&&row[k]!==undefined&&row[k]!=='')return row[k];}return'';}
function getRowSN(row,col){return row[getSNField(col||[row])]||'';}
function findBySN(col,sn){if(!col||!sn)return null;const f=getSNField(col);return col.find(i=>(i[f]||'').toUpperCase()===sn.toUpperCase());}
function findByNum(col,num){if(!col)return null;const f=getSNField(col);return col.find(i=>{const m=(i[f]||'').match(/(\d+)$/);return m&&parseInt(m[1])===num;});}
function findBySubField(col,fcs,val){if(!col)return null;for(const row of col){for(const fc of(Array.isArray(fcs)?fcs:[fcs])){const v=getField(row,fc);if(v&&(v===val||v===String(val)))return row;}}return null;}

// ===== LINKING HELPERS (based on actual sheet column names) =====
// Ghost sheet cols: 'Mobile Base', 'Pillar', 'Body&Head', 'Arm', 'Deploy Kit'
// MB cols: 'L1 motor S/N', 'L2 motor S/N', 'PDB S/N'
// Pillar cols: 'L3 motor S/N', 'BRK S/N'
// H&B cols: 'GALINA S/N', 'IOB S/N'
// Arm cols: 'A1-A5 motor S/N', 'Gripper S/N', 'BAT S/N'
// Gripper cols: 'IOB S/N'
// Motors: 'MDB S/N' ‚Äî no parent col, parents reference them

function findGhostByCol(colName, subSN) {
  if (!DATA.ghosts || !subSN) return null;
  const up = subSN.toUpperCase();
  return DATA.ghosts.find(g => (g[colName]||'').toUpperCase() === up) || null;
}

function findByCol(list, colName, val) {
  if (!list || !val) return null;
  const up = val.toUpperCase();
  return list.find(r => (r[colName]||'').toUpperCase() === up) || null;
}

function findLMotorParent(motorSN) {
  const up = motorSN.toUpperCase();
  for (const mb of (DATA.mobileBases||[])) {
    if ((mb['L1 motor S/N']||'').toUpperCase()===up) return {row:mb,ghostCol:'Mobile Base',list:DATA.mobileBases,slot:'L1',via:'Mobile Base'};
    if ((mb['L2 motor S/N']||'').toUpperCase()===up) return {row:mb,ghostCol:'Mobile Base',list:DATA.mobileBases,slot:'L2',via:'Mobile Base'};
  }
  for (const pl of (DATA.pillars||[])) {
    if ((pl['L3 motor S/N']||'').toUpperCase()===up) return {row:pl,ghostCol:'Pillar',list:DATA.pillars,slot:'L3',via:'Pillar'};
  }
  return null;
}

function findArmByMotorSN(motorSN, cols) {
  const up = motorSN.toUpperCase();
  for (const arm of (DATA.arms||[])) {
    for (const col of cols) {
      if ((arm[col]||'').toUpperCase()===up) return {row:arm,slot:col.replace(' motor S/N','')};
    }
  }
  return null;
}

// ===== TRACE =====
function traceToGhost(input) {
  const parsed = parseInput(input); if (!parsed) return null;
  let ghost, path=[], matchedIn=parsed.label, matchedSN='';
  const D = DATA;
  const sn = (row,list) => getRowSN(row,list);
  const findItem = (list) => {
    if(!list) return null;
    let it = parsed.fullSN.match(/^GT/) ? findBySN(list,parsed.fullSN) : null;
    if(!it) it = findByNum(list,parsed.num);
    return it;
  };

  switch(parsed.type) {
    case 'ghost': {
      const g = findItem(D.ghosts);
      if(g) { ghost=g; path=['Ghost']; matchedSN=sn(g,D.ghosts); }
      break;
    }
    case 'mobileBase': {
      const mb = findItem(D.mobileBases);
      if(mb) { const s=sn(mb,D.mobileBases); ghost=findGhostByCol('Mobile Base',s); path=['Mobile Base','Ghost']; matchedSN=s; }
      break;
    }
    case 'pillar': {
      const pl = findItem(D.pillars);
      if(pl) { const s=sn(pl,D.pillars); ghost=findGhostByCol('Pillar',s); path=['Pillar','Ghost']; matchedSN=s; }
      break;
    }
    case 'headBody': {
      const hb = findItem(D.headBodies);
      if(hb) { const s=sn(hb,D.headBodies); ghost=findGhostByCol('Body&Head',s); path=['Head & Body','Ghost']; matchedSN=s; }
      break;
    }
    case 'arm': {
      const arm = findItem(D.arms);
      if(arm) { const s=sn(arm,D.arms); ghost=findGhostByCol('Arm',s); path=['Arm','Ghost']; matchedSN=s; }
      break;
    }
    case 'gripper': {
      const gr = findItem(D.grippers);
      if(gr) {
        const grS=sn(gr,D.grippers);
        const arm=findByCol(D.arms,'Gripper S/N',grS);
        if(arm) { const aS=sn(arm,D.arms); ghost=findGhostByCol('Arm',aS); }
        path=['Gripper','Arm','Ghost']; matchedSN=grS;
      }
      break;
    }
    case 'deployKit': {
      const dk = findItem(D.deployKits);
      if(dk) { const s=sn(dk,D.deployKits); ghost=findGhostByCol('Deploy Kit',s); path=['Deploy Kit','Ghost']; matchedSN=s; }
      break;
    }
    case 'lMotor': {
      const lm = findItem(D.lMotors);
      if(lm) {
        const lS=sn(lm,D.lMotors);
        const parent=findLMotorParent(lS);
        if(parent) { const pS=sn(parent.row,parent.list); ghost=findGhostByCol(parent.ghostCol,pS); path=[`L-Motor (${parent.slot})`,parent.via,'Ghost']; }
        else path=['L-Motor','?','Ghost'];
        matchedSN=lS;
      }
      break;
    }
    case 'a12Motor': {
      const m = findItem(D.a12Motors);
      if(m) {
        const mS=sn(m,D.a12Motors);
        const arm=findArmByMotorSN(mS,['A1 motor S/N','A2 motor S/N']);
        if(arm) { const aS=sn(arm.row,D.arms); ghost=findGhostByCol('Arm',aS); path=[`A12 (${arm.slot})`,'Arm','Ghost']; }
        else path=['A12','?','Ghost'];
        matchedSN=mS;
      }
      break;
    }
    case 'a35Motor': {
      const m = findItem(D.a35Motors);
      if(m) {
        const mS=sn(m,D.a35Motors);
        const arm=findArmByMotorSN(mS,['A3 motor S/N','A5 motor S/N']);
        if(arm) { const aS=sn(arm.row,D.arms); ghost=findGhostByCol('Arm',aS); path=[`A35 (${arm.slot})`,'Arm','Ghost']; }
        else path=['A35','?','Ghost'];
        matchedSN=mS;
      }
      break;
    }
    case 'a4Motor': {
      const m = findItem(D.a4Motors);
      if(m) {
        const mS=sn(m,D.a4Motors);
        const arm=findArmByMotorSN(mS,['A4 motor S/N']);
        if(arm) { const aS=sn(arm.row,D.arms); ghost=findGhostByCol('Arm',aS); path=['A4 Motor','Arm','Ghost']; }
        else path=['A4','?','Ghost'];
        matchedSN=mS;
      }
      break;
    }
    case 'galina': {
      const hb = findByCol(D.headBodies,'GALINA S/N',String(parsed.num));
      if(hb) { const s=sn(hb,D.headBodies); ghost=findGhostByCol('Body&Head',s); path=['GALINA','Head & Body','Ghost']; matchedSN=String(parsed.num); }
      break;
    }
    case 'pdb': {
      const val=`PDB-${parsed.num}`;
      const mb = findByCol(D.mobileBases,'PDB S/N',val) || findByCol(D.mobileBases,'PDB S/N',String(parsed.num));
      if(mb) { const s=sn(mb,D.mobileBases); ghost=findGhostByCol('Mobile Base',s); path=['PDB','Mobile Base','Ghost']; matchedSN=val; }
      break;
    }
    case 'iob': {
      const val=`IOB-${parsed.num}`;
      let hb = findByCol(D.headBodies,'IOB S/N',val) || findByCol(D.headBodies,'IOB S/N',String(parsed.num));
      if(hb) { const s=sn(hb,D.headBodies); ghost=findGhostByCol('Body&Head',s); path=['IOB','Head & Body','Ghost']; matchedSN=val; break; }
      let gr = findByCol(D.grippers,'IOB S/N',val) || findByCol(D.grippers,'IOB S/N',String(parsed.num));
      if(gr) {
        const grS=sn(gr,D.grippers); const arm=findByCol(D.arms,'Gripper S/N',grS);
        if(arm) { const aS=sn(arm,D.arms); ghost=findGhostByCol('Arm',aS); }
        path=['IOB','Gripper','Arm','Ghost']; matchedSN=val;
      }
      break;
    }
    case 'mdb': {
      const val=`MDB-${parsed.num}`;
      // Search L-motors
      let m=findByCol(D.lMotors,'MDB S/N',val)||findByCol(D.lMotors,'MDB S/N',String(parsed.num));
      if(m) { const mS=sn(m,D.lMotors); const p=findLMotorParent(mS); if(p){const pS=sn(p.row,p.list);ghost=findGhostByCol(p.ghostCol,pS);path=['MDB',`L-Motor (${p.slot})`,p.via,'Ghost'];} matchedSN=val; break; }
      // Search A12 motors
      m=findByCol(D.a12Motors,'MDB S/N',val)||findByCol(D.a12Motors,'MDB S/N',String(parsed.num));
      if(m){const mS=sn(m,D.a12Motors);const arm=findArmByMotorSN(mS,['A1 motor S/N','A2 motor S/N']);if(arm){const aS=sn(arm.row,D.arms);ghost=findGhostByCol('Arm',aS);path=['MDB',`A12 (${arm.slot})`,'Arm','Ghost'];}matchedSN=val;break;}
      // Search A35 motors
      m=findByCol(D.a35Motors,'MDB S/N',val)||findByCol(D.a35Motors,'MDB S/N',String(parsed.num));
      if(m){const mS=sn(m,D.a35Motors);const arm=findArmByMotorSN(mS,['A3 motor S/N','A5 motor S/N']);if(arm){const aS=sn(arm.row,D.arms);ghost=findGhostByCol('Arm',aS);path=['MDB',`A35 (${arm.slot})`,'Arm','Ghost'];}matchedSN=val;break;}
      // Search A4 motors
      m=findByCol(D.a4Motors,'MDB S/N',val)||findByCol(D.a4Motors,'MDB S/N',String(parsed.num));
      if(m){const mS=sn(m,D.a4Motors);const arm=findArmByMotorSN(mS,['A4 motor S/N']);if(arm){const aS=sn(arm.row,D.arms);ghost=findGhostByCol('Arm',aS);path=['MDB','A4 Motor','Arm','Ghost'];}matchedSN=val;break;}
      break;
    }
    case 'brk': {
      const val=`BRK-${parsed.num}`;
      const pl=findByCol(D.pillars,'BRK S/N',val)||findByCol(D.pillars,'BRK S/N',String(parsed.num));
      if(pl){const s=sn(pl,D.pillars);ghost=findGhostByCol('Pillar',s);path=['Brake','Pillar','Ghost'];matchedSN=val;}
      break;
    }
    case 'bat': {
      const val=`BAT-${parsed.num}`;
      const arm=findByCol(D.arms,'BAT S/N',val)||findByCol(D.arms,'BAT S/N',String(parsed.num));
      if(arm){const s=sn(arm,D.arms);ghost=findGhostByCol('Arm',s);path=['Battery','Arm','Ghost'];matchedSN=val;}
      break;
    }
  }
  if(!ghost) return null;
  return {ghost,path,matchedIn,matchedSN,parsed};
}

// ===== GHOST TREE (top-down using actual column names) =====
function getGhostTree(ghostRow) {
  if(!ghostRow) return null;
  const D = DATA;

  // Ghost ‚Üí sub-assemblies via Ghost sheet columns
  const mbSN  = ghostRow['Mobile Base'] || '';
  const plSN  = ghostRow['Pillar'] || '';
  const hbSN  = ghostRow['Body&Head'] || '';
  const armSN = ghostRow['Arm'] || '';
  const dkSN  = ghostRow['Deploy Kit'] || '';

  const mb  = mbSN  ? findBySN(D.mobileBases, mbSN)  : null;
  const pl  = plSN  ? findBySN(D.pillars, plSN)       : null;
  const hb  = hbSN  ? findBySN(D.headBodies, hbSN)    : null;
  const arm = armSN ? findBySN(D.arms, armSN)          : null;
  const dk  = dkSN  ? findBySN(D.deployKits, dkSN)    : null;

  // Gripper referenced from Arm sheet
  const grSN = arm ? (arm['Gripper S/N']||'') : '';
  const gr   = grSN ? findBySN(D.grippers, grSN) : null;

  // MB ‚Üí L1, L2 motors
  const mbMotors = [];
  if(mb) {
    ['L1 motor S/N','L2 motor S/N'].forEach(col => {
      const s=mb[col]||''; if(s){const m=findBySN(D.lMotors,s);if(m)mbMotors.push(m);}
    });
  }

  // Pillar ‚Üí L3 motor
  const plMotors = [];
  if(pl) {
    const s=pl['L3 motor S/N']||''; if(s){const m=findBySN(D.lMotors,s);if(m)plMotors.push(m);}
  }

  // Arm ‚Üí A1/A2 (A12-motors), A3/A5 (A35-motors), A4 (A4-motor)
  const armA12=[], armA35=[], armA4=[];
  if(arm) {
    ['A1 motor S/N','A2 motor S/N'].forEach(col => {
      const s=arm[col]||''; if(s){const m=findBySN(D.a12Motors,s);if(m)armA12.push(m);}
    });
    ['A3 motor S/N','A5 motor S/N'].forEach(col => {
      const s=arm[col]||''; if(s){const m=findBySN(D.a35Motors,s);if(m)armA35.push(m);}
    });
    const a4s=arm['A4 motor S/N']||'';
    if(a4s){const m=findBySN(D.a4Motors,a4s);if(m)armA4.push(m);}
  }

  return {ghost:ghostRow,mb,pl,hb,arm,gr,dk,mbMotors,plMotors,armA12,armA35,armA4};
}

// ===== APP STATE =====
const state={screen:'login',searchInput:'',parsedPreview:null,result:null,tree:null,expanded:new Set(),editing:null,editValue:'',toast:null,scanning:false,loadErrors:[],refreshing:false,showGuest:false};

const $=s=>document.querySelector(s);
const app=()=>document.getElementById('app');
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escAttr(s){return String(s).replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/\\/g,'\\\\');}

function render(){switch(state.screen){case'login':renderLogin();break;case'loading':renderLoading();break;case'search':renderSearch();break;case'result':renderResult();break;case'edit':renderEdit();break;}}

// ===== LOGIN (same flow as inventory app) =====
function renderLogin(){
  app().innerHTML=`<div class="login-screen"><div class="login-bg"></div>
    <div class="login-card" id="loginCard" ${state.showGuest?'style="display:none"':''}>
      <div class="login-logo">üëª</div>
      <h1 class="login-title">Ghost Tracker</h1>
      <p class="login-subtitle">Assembly tracking for Ghost robots.<br>Sign in to access production data.</p>
      <button class="login-btn" onclick="handleGoogleLogin()">
        <svg viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google</button>
      <div class="login-divider">or</div>
      <button class="login-guest-btn" onclick="showGuestInput()">Continue as Guest (read-only)</button>
      <div class="login-error" id="loginError"></div>
    </div>
    <div class="guest-section" id="guestSection" ${state.showGuest?'style="display:flex;flex-direction:column;align-items:center"':''}>
      <div class="login-logo" style="margin-bottom:16px">üëª</div>
      <p style="color:var(--text-dim);font-size:14px;margin-bottom:20px;text-align:center">Enter your name to continue as guest</p>
      <input class="guest-input" id="guestNameInput" placeholder="Your name..." autocomplete="off">
      <button class="guest-continue-btn" id="guestContinueBtn" onclick="handleGuestLogin()" disabled>Continue</button>
      <button class="guest-back" onclick="hideGuestInput()">‚Üê Back to login</button>
    </div></div>${renderToast()}`;
  const gi=$('#guestNameInput');
  if(gi){gi.addEventListener('input',e=>{$('#guestContinueBtn').disabled=!e.target.value.trim();});gi.addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim())handleGuestLogin();});}
}

function showGuestInput(){state.showGuest=true;render();setTimeout(()=>$('#guestNameInput')?.focus(),50);}
function hideGuestInput(){state.showGuest=false;render();}
function showLoginError(msg){const el=$('#loginError');if(el){el.textContent=msg;el.style.display='block';}}

function handleGoogleLogin(){
  if(!tokenClient){showLoginError('Google sign-in is loading... Please try again in a moment.');return;}
  tokenClient.requestAccessToken();
}

async function fetchUserInfo(){
  try{
    const resp=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{'Authorization':`Bearer ${accessToken}`}});
    if(!resp.ok)throw new Error('Failed');
    const info=await resp.json();const email=info.email||'';
    const approved=CONFIG.APPROVED_USERS[email];
    if(!approved){showLoginError(`Access denied.\n${email} is not approved.\nContact admin.`);accessToken=null;localStorage.removeItem('ghost_access_token');return;}
    currentUser={name:approved.name,email,team:approved.team,isAdmin:approved.isAdmin,isGuest:false};
    localStorage.setItem('ghost_user',JSON.stringify(currentUser));
    startApp();
  }catch(err){
    console.error(err);
    try{const tr=await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token='+accessToken);const ti=await tr.json();const email=ti.email||'';const approved=CONFIG.APPROVED_USERS[email];
      if(!approved){showLoginError(`Access denied.\n${email} is not approved.`);accessToken=null;localStorage.removeItem('ghost_access_token');return;}
      currentUser={name:approved.name,email,team:approved.team,isAdmin:approved.isAdmin,isGuest:false};localStorage.setItem('ghost_user',JSON.stringify(currentUser));startApp();
    }catch{showLoginError('Login failed. Please try again.');}
  }
}

function handleGuestLogin(){
  const name=$('#guestNameInput')?.value?.trim();if(!name)return;
  currentUser={name,email:'',isAdmin:false,isGuest:true,team:'guest'};
  localStorage.setItem('ghost_user',JSON.stringify(currentUser));
  // Guest still needs OAuth token to read sheets
  showLoginError('Guest access requires Google sign-in to read data.\nPlease sign in with Google.');
}

async function validateToken(){
  try{const r=await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token='+accessToken);if(r.ok){startApp();}else{clearSession();render();}}
  catch{clearSession();render();}
}

function clearSession(){localStorage.removeItem('ghost_access_token');localStorage.removeItem('ghost_user');accessToken=null;currentUser={name:'',email:'',isAdmin:false,isGuest:false,team:''};}

function handleLogout(){if(accessToken){try{google.accounts.oauth2.revoke(accessToken);}catch{}}clearSession();state.screen='login';render();}

async function startApp(){state.screen='loading';render();state.loadErrors=await loadAllData((l,t,c)=>{loadProgress={loaded:l,total:t,current:c};renderLoading();});state.screen='search';render();}

// ===== LOADING =====
let loadProgress={loaded:0,total:11,current:''};
function renderLoading(){const pct=loadProgress.total?Math.round((loadProgress.loaded/loadProgress.total)*100):0;app().innerHTML=`${renderUserBar()}<div class="loading-screen"><div class="loading-spinner">üëª</div><div class="loading-text">Loading assembly data...</div><div class="loading-progress"><div class="loading-bar" style="width:${pct}%"></div></div><div class="loading-detail">${loadProgress.current||'Connecting...'}</div></div>`;}

function renderUserBar(){if(!currentUser.name)return'';const badge=currentUser.isAdmin?'<span class="user-badge user-badge-admin">ADMIN</span>':currentUser.isGuest?'<span class="user-badge user-badge-guest">GUEST</span>':`<span class="user-badge user-badge-team">${escHtml((currentUser.team||'team').toUpperCase())}</span>`;return`<div class="user-bar"><span class="user-name">${escHtml(currentUser.name)}${badge}</span><button class="logout-btn" onclick="handleLogout()">Sign out</button></div>`;}

// ===== SEARCH =====
function renderSearch(){const preview=state.parsedPreview;const demoSNs=[];
  if(DATA.ghosts?.length){const f=getSNField(DATA.ghosts);DATA.ghosts.slice(0,2).forEach(r=>r[f]&&demoSNs.push(r[f]));}
  if(DATA.mobileBases?.length){const f=getSNField(DATA.mobileBases);DATA.mobileBases.slice(0,1).forEach(r=>r[f]&&demoSNs.push(r[f]));}
  if(DATA.arms?.length){const f=getSNField(DATA.arms);DATA.arms.slice(0,1).forEach(r=>r[f]&&demoSNs.push(r[f]));}
  if(DATA.headBodies?.length){const hb=DATA.headBodies[0];const iob=getField(hb,'iobSN','IOB S/N','IOB');if(iob)demoSNs.push(iob);const gal=getField(hb,'galinaSN','GALINA S/N','GALINA');if(gal)demoSNs.push(gal);}
  const totalRows=Object.values(DATA).reduce((s,a)=>s+(a?.length||0),0);
  app().innerHTML=`${renderUserBar()}<div class="search-screen"><div class="search-bg"></div><div class="search-content">
    <div class="search-logo">üëª</div><h1 class="search-title">Ghost Tracker</h1>
    <p class="search-subtitle">Scan QR or type any S/N to trace assembly data</p>
    <div style="margin-bottom:16px"><span class="data-status data-status-live"><span class="data-status-dot"></span>${totalRows} records</span></div>
    <div class="search-input-wrap"><input class="search-input" id="searchInput" value="${escHtml(state.searchInput)}" placeholder="GT418-GST-00001 or GR-1 or 240002..." autocomplete="off" autocapitalize="characters" spellcheck="false"></div>
    ${preview?`<div class="parse-preview"><span class="parse-tag">${preview.inputType==='qr'?'üì∑ QR':preview.inputType==='shorthand'?'‚å®Ô∏è Quick':'üî¢'}</span><span style="color:var(--text-secondary)">‚Üí</span><span style="color:var(--text-primary);font-weight:500">${escHtml(preview.label)}</span>${preview.sheet?`<span style="font-size:11px;color:var(--text-dim);margin-left:auto;font-family:var(--font-mono)">${escHtml(preview.sheet)}</span>`:''}</div>`:''}
    <div class="btn-row"><button class="btn btn-primary" onclick="handleSearch()">Search</button><button class="btn btn-secondary" onclick="handleDemoScan()">üì∑ Scan QR</button></div>
    <div class="formats-box"><div class="formats-title">ACCEPTED FORMATS</div>${[{fmt:'GT418-GST-00001',desc:'Full S/N (QR)',tag:'QR'},{fmt:'MB-1, ARM-10',desc:'Shorthand',tag:'Type'},{fmt:'PDB-4421, IOB-5567',desc:'Sub-component',tag:'Type'},{fmt:'240002',desc:'GALINA number',tag:'QR'}].map(f=>`<div class="format-row"><span class="format-tag format-tag-${f.tag.toLowerCase()}">${f.tag}</span><code class="format-code">${f.fmt}</code><span class="format-desc">${f.desc}</span></div>`).join('')}</div>
    ${demoSNs.length?`<div class="demo-section"><div class="demo-label">Try values from your sheet</div><div class="demo-chips">${demoSNs.map(sn=>`<button class="demo-chip" onclick="setSearch('${escHtml(sn)}')">${escHtml(sn)}</button>`).join('')}</div></div>`:''}
    ${state.loadErrors.length?`<div class="error-banner" style="margin-top:24px;max-width:400px">‚ö† Some sheets failed: ${state.loadErrors.map(e=>e.tab).join(', ')}<code>${escHtml(state.loadErrors[0].error)}</code></div>`:''}</div></div>${state.scanning?renderScanOverlay():''}${renderToast()}`;
  const inp=$('#searchInput');inp?.addEventListener('input',e=>{state.searchInput=e.target.value;state.parsedPreview=parseInput(e.target.value);render();});inp?.addEventListener('keydown',e=>{if(e.key==='Enter')handleSearch();});setTimeout(()=>$('#searchInput')?.focus(),50);
}

// ===== RESULT =====
function renderResult(){const{result,tree}=state;if(!result||!tree)return;const ghostSN=getRowSN(tree.ghost,DATA.ghosts);
  const allSections=[{key:'ghost',data:tree.ghost},{key:'mobileBase',data:tree.mb},{key:'mbMotors',data:tree.mbMotors},{key:'pillar',data:tree.pl},{key:'plMotors',data:tree.plMotors},{key:'headBody',data:tree.hb},{key:'arm',data:tree.arm},{key:'armA12',data:tree.armA12},{key:'armA35',data:tree.armA35},{key:'armA4',data:tree.armA4},{key:'gripper',data:tree.gr},{key:'deployKit',data:tree.dk}];
  const mi=(result.matchedIn||'').toLowerCase().replace(/[^a-z0-9]/g,'');const mp=(result.path||[]).map(p=>p.toLowerCase().replace(/[^a-z0-9]/g,''));
  const subMap={pdb:['mobilebase'],iob:['headbody','gripper'],mdb:['mbmotors','plmotors','arma12','arma35','arma4'],brk:['pillar'],bat:['arm'],galina:['headbody'],lmotor:['mbmotors','plmotors'],a12motor:['arma12'],a35motor:['arma35'],a4motor:['arma4']};
  const isM=(key)=>{const k=key.toLowerCase().replace(/[^a-z0-9]/g,'');if(mi.includes(k)||k.includes(mi))return true;for(const p of mp)if(p.includes(k)||k.includes(p))return true;for(const[sub,ts]of Object.entries(subMap))if(mi.includes(sub)&&ts.some(t=>k.includes(t)||t.includes(k)))return true;return false;};
  const isGM=mi==='ghost';const matched=allSections.filter(s=>isM(s.key));const rest=allSections.filter(s=>!isM(s.key));const seen=new Set();const sorted=isGM?allSections:[...matched,...rest];const final=sorted.filter(s=>{if(seen.has(s.key))return false;seen.add(s.key);return true;});
  let sH='';if(!isGM&&matched.length>0)sH+=`<div class="section-divider section-divider-match">‚ñ≤ MATCHED <span class="section-divider-hint">‚Äî shown first</span></div>`;
  final.forEach((s,i)=>{if(!isGM&&matched.length>0&&i===matched.length)sH+=`<div class="section-divider section-divider-other" style="margin-top:12px">‚ñº OTHER ASSEMBLIES</div>`;sH+=renderSectionCard(s.key,s.data,isM(s.key));});
  app().innerHTML=`${renderUserBar()}<div class="result-screen"><div class="result-header"><button class="back-btn" onclick="goBack()">‚Üê Back</button><div class="result-ghost-id">üëª ${escHtml(ghostSN)}</div><span class="live-badge">LIVE</span></div>
    <div class="trace-box"><div class="trace-title">TRACE PATH</div><div class="trace-steps">${result.path.map((step,i)=>`<span style="display:flex;align-items:center;gap:4px"><span class="trace-step ${i===0?'trace-step-first':'trace-step-rest'}">${escHtml(step)}</span>${i<result.path.length-1?'<span class="trace-arrow">‚Üí</span>':''}</span>`).join('')}</div><div class="trace-summary"><span class="hl">${escHtml(state.searchInput)}</span> ‚Üí ${escHtml(result.matchedIn)} ‚Üí <span class="hl2">${escHtml(ghostSN)}</span></div></div>
    <div class="val-legend"><div class="val-tag" style="background:rgba(91,110,234,0.1)"><span style="color:var(--accent)">‚ñæ</span><span class="val-tag-desc">List</span></div><div class="val-tag" style="background:rgba(251,191,36,0.1)"><span style="color:var(--yellow)">‚òê</span><span class="val-tag-desc">Check</span></div><div class="val-tag" style="background:rgba(56,189,248,0.1)"><span style="color:var(--blue)">üìÖ</span><span class="val-tag-desc">Date</span></div></div>
    <div class="sections-wrap">${sH}</div><button class="refresh-btn ${state.refreshing?'refresh-spinning':''}" onclick="refreshData()" title="Refresh">‚Üª</button></div>${renderToast()}`;
}

function renderSectionCard(sk,data,isMS){if(!data||(Array.isArray(data)&&data.length===0))return'';const cfg=SECTION_CONFIG[sk];if(!cfg)return'';const items=Array.isArray(data)?data:[data];if(!items.length)return'';const isO=state.expanded.has(sk);const lk={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'}[sk]||sk;const sf=getSNField(DATA[lk]||items);
  return`<div class="section-card"><div class="section-header" onclick="toggleSection('${sk}')" style="background:${cfg.bg};border-radius:${isO?'12px 12px 0 0':'12px'};border:1px solid ${cfg.color}${isMS?'55':'22'};border-left:${isMS?'4px solid '+cfg.color:'1px solid '+cfg.color+'22'}"><span class="section-icon">${cfg.icon}</span><div class="section-info"><div class="section-label" style="color:${cfg.color}">${cfg.label}</div><div class="section-sns">${items.map(i=>escHtml(i[sf]||'?')).join(' ¬∑ ')}</div></div>${isMS?`<span class="match-badge" style="background:${cfg.color}22;color:${cfg.color}">MATCH</span>`:''}<span class="section-chevron ${isO?'section-chevron-open':''}">‚ñº</span></div>${isO?items.map((item,idx)=>`<div class="field-group" style="background:var(--bg-card);border:1px solid ${cfg.color}15;border-top:none;border-radius:${idx===items.length-1?'0 0 12px 12px':'0'}">${items.length>1?`<div class="field-group-label" style="color:${cfg.color};border-bottom:1px solid ${cfg.color}10">${escHtml(getField(item,'slot','Slot')?getField(item,'slot','Slot')+' ‚Üí ':'')}${escHtml(item[sf]||'?')}</div>`:''}${Object.entries(item).map(([k,v])=>renderFieldRow(sk,item[sf]||'',k,v,lk)).join('')}</div>`).join(''):''}</div>`;}

function renderFieldRow(section,sn,field,value,lk){if(shouldSkipField(field))return'';const label=FIELD_LABELS[field]||field;const val=getValidation(section,field);const isSN=field===getSNField(DATA[lk]||[])||/sn$/i.test(field);const isC=val?.type==='checkbox';const isD=val?.type==='date';const isDr=val?.type==='dropdown';const isH=state.result?.matchedSN===value||(state.result?.matchedSN===sn&&field===getSNField(DATA[lk]||[]));
  let vH;if(isC){const p=value==='‚úì'||value==='TRUE'||value==='true'||value==='1'||value==='OK';vH=`<span class="check-display ${p?'check-pass':'check-fail'}">${p?'‚úì':'‚úó'}</span>`;}else{vH=`<span class="field-value ${isSN?'field-value-sn':''}">${escHtml(value||'‚Äî')}</span>`;}
  return`<div class="field-row ${isH?'field-row-highlight':''}" onclick="startEdit('${escAttr(section)}','${escAttr(sn)}','${escAttr(field)}','${escAttr(value||'')}')"><div class="field-left"><span class="field-label">${escHtml(label)}</span>${isDr?'<span class="inline-badge badge-list">‚ñæ</span>':''}${isC?'<span class="inline-badge badge-check">‚òê</span>':''}${isD?'<span class="inline-badge badge-date">üìÖ</span>':''}</div><div class="field-right">${vH}<span class="field-edit-icon">‚úé</span></div></div>`;}

// ===== EDIT =====
function renderEdit(){const{editing,editValue}=state;if(!editing)return;const label=FIELD_LABELS[editing.field]||editing.field;const cfg=SECTION_CONFIG[editing.section];const val=getValidation(editing.section,editing.field);const isDr=val?.type==='dropdown';const isC=val?.type==='checkbox';const isD=val?.type==='date';const isFT=!val;const changed=editValue!==editing.value&&editValue!=='';
  let iH='';
  if(isDr)iH=`<div class="edit-input-wrap"><div class="edit-input-label">SELECT VALUE</div><div class="dropdown-list">${val.options.map(opt=>{const sel=editValue===opt;const cur=editing.value===opt;return`<div class="dropdown-option ${sel?'dropdown-option-selected':''}" onclick="setEditValue('${escAttr(opt)}')"><div class="dropdown-option-inner"><div class="radio-circle ${sel?'radio-circle-selected':''}">${sel?'<div class="radio-dot"></div>':''}</div><span class="dropdown-option-text ${sel?'dropdown-option-text-selected':''}">${escHtml(opt)}</span></div>${cur?'<span class="current-tag">CURRENT</span>':''}</div>`;}).join('')}</div></div>`;
  else if(isC)iH=`<div class="edit-input-wrap"><div class="edit-input-label">TOGGLE</div><div class="check-options">${['‚úì','‚úó'].map(v=>{const sel=editValue===v;const isP=v==='‚úì';const col=isP?'var(--green)':'var(--red)';const bg=isP?'rgba(52,211,153,0.1)':'rgba(248,113,113,0.1)';return`<div class="check-option" onclick="setEditValue('${v}')" style="${sel?`border:2px solid ${col};background:${bg}`:''}"><div class="check-icon-wrap" style="${sel?`background:${col}22;border-color:${col};color:${col}`:''}">${v}</div><div class="check-option-label" style="${sel?`color:${col}`:''}">${isP?'Pass':'Fail'}</div></div>`;}).join('')}</div></div>`;
  else if(isD){const dv=(editValue||'').replace(/\//g,'-');iH=`<div class="edit-input-wrap"><div class="edit-input-label">DATE</div><input type="date" class="edit-date-input" id="editDateInput" value="${dv}"><div class="date-quick-btns"><button class="date-quick-btn" onclick="setDateToday()">Today</button><button class="date-quick-btn" onclick="setDateYesterday()">Yesterday</button></div></div>`;}
  else iH=`<div class="edit-input-wrap"><div class="edit-input-label">NEW VALUE</div><input type="text" class="edit-text-input" id="editTextInput" value="${escAttr(editValue)}"></div>`;
  app().innerHTML=`<div class="edit-screen"><div class="edit-header"><button class="cancel-btn" onclick="goBack()">Cancel</button><span style="font-size:14px;font-weight:600">Edit Field</span><button class="save-btn" onclick="saveEdit()">Save ‚úì</button></div><div class="edit-body"><div class="edit-context" style="background:${cfg?cfg.color+'10':'var(--bg-input)'};border:1px solid ${cfg?cfg.color+'22':'var(--border-base)'}"><span>${cfg?.icon||'üìã'}</span><span style="font-size:12px;color:${cfg?.color||'var(--text-dim)'};font-weight:600">${cfg?.label||editing.section}</span></div><div class="edit-sn">${escHtml(editing.sn)}</div><div class="edit-field-name"><span class="edit-field-label">${escHtml(label)}</span></div><div class="edit-old-value">${escHtml(editing.value||'empty')}</div>${iH}<button class="save-action-btn ${changed?'save-active':'save-inactive'}" onclick="saveEdit()">${changed?'Save to Sheet':'No changes'}</button><p class="edit-api-hint">Updates via Google Sheets API</p></div></div>${renderToast()}`;
  const ti=$('#editTextInput');if(ti){ti.addEventListener('input',e=>{state.editValue=e.target.value;});ti.addEventListener('keydown',e=>{if(e.key==='Enter')saveEdit();});setTimeout(()=>ti.focus(),50);}
  const di=$('#editDateInput');if(di)di.addEventListener('change',e=>{state.editValue=e.target.value.replace(/-/g,'/');});
}

function renderScanOverlay(){return`<div class="scan-overlay"><div class="scan-frame">${[['top','left'],['top','right'],['bottom','left'],['bottom','right']].map(([v,h])=>`<div style="position:absolute;width:28px;height:28px;${v}:-2px;${h}:-2px;border-${v}:3px solid var(--accent);border-${h}:3px solid var(--accent);border-radius:${v==='top'&&h==='left'?'8px 0 0 0':v==='top'?'0 8px 0 0':h==='left'?'0 0 0 8px':'0 0 8px 0'}"></div>`).join('')}<div class="scan-line"></div></div><p style="color:var(--text-dim);font-size:13px">Scanning...</p></div>`;}
function renderToast(){if(!state.toast)return'';return`<div class="toast toast-${state.toast.type}">${escHtml(state.toast.msg)}</div>`;}

// ===== ACTIONS =====
function handleSearch(){if(!state.searchInput.trim())return;const r=traceToGhost(state.searchInput);if(r){state.result=r;state.tree=getGhostTree(r.ghost);const ek=new Set(['ghost']);const mt=r.parsed?.type||'';const ts={ghost:['ghost'],mobileBase:['mobileBase'],pillar:['pillar'],headBody:['headBody'],arm:['arm'],gripper:['gripper'],deployKit:['deployKit'],lMotor:['mbMotors','plMotors'],a12Motor:['armA12'],a35Motor:['armA35'],a4Motor:['armA4'],pdb:['mobileBase'],iob:['headBody','gripper'],mdb:['mbMotors','plMotors','armA12','armA35','armA4'],brk:['pillar'],bat:['arm'],galina:['headBody']};(ts[mt]||[]).forEach(s=>ek.add(s));state.expanded=ek;state.screen='result';}else{showToast(`No match for "${state.searchInput}"`,'error');}render();}
function handleDemoScan(){state.scanning=true;render();let d='GT418-GST-00001';if(DATA.mobileBases?.length){const f=getSNField(DATA.mobileBases);d=DATA.mobileBases[0][f]||d;}setTimeout(()=>{state.searchInput=d;state.scanning=false;setTimeout(()=>handleSearch(),300);},1800);render();}
function setSearch(val){state.searchInput=val;state.parsedPreview=parseInput(val);render();}
function toggleSection(key){state.expanded.has(key)?state.expanded.delete(key):state.expanded.add(key);render();}
function startEdit(section,sn,field,value){state.editing={section,sn,field,value};state.editValue=value||'';state.screen='edit';render();}
function setEditValue(val){state.editValue=val;render();}
function setDateToday(){const d=new Date();state.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
function setDateYesterday(){const d=new Date();d.setDate(d.getDate()-1);state.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
async function saveEdit(){if(!state.editing||state.editValue===state.editing.value)return;showToast(`Saved ${FIELD_LABELS[state.editing.field]||state.editing.field}: ${state.editValue}`);state.screen='result';state.editing=null;render();}
function goBack(){if(state.screen==='edit'){state.screen='result';state.editing=null;}else{state.screen='search';state.searchInput='';state.result=null;state.tree=null;state.parsedPreview=null;}render();}
async function refreshData(){state.refreshing=true;render();state.loadErrors=await loadAllData((l,t,c)=>{loadProgress={loaded:l,total:t,current:c};});state.refreshing=false;showToast('Data refreshed');render();}
function showToast(msg,type='success'){state.toast={msg,type};render();setTimeout(()=>{state.toast=null;render();},3000);}

// ===== INIT (same pattern as inventory app) =====
window.onload = function() {
  // Always render login first
  render();

  // Google GIS may not be loaded yet (async defer)
  function initGoogleAuth() {
    if (typeof google === 'undefined' || !google.accounts) {
      // Retry until loaded (script is async defer)
      setTimeout(initGoogleAuth, 200);
      return;
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CONFIG.CLIENT_ID,
      scope: CONFIG.SCOPES,
      callback: (response) => {
        if (response.access_token) {
          accessToken = response.access_token;
          localStorage.setItem('ghost_access_token', accessToken);
          fetchUserInfo();
        }
      },
    });
    // Check stored session
    const storedUser = localStorage.getItem('ghost_user');
    const storedToken = localStorage.getItem('ghost_access_token');
    if (storedUser && storedToken) {
      currentUser = JSON.parse(storedUser);
      accessToken = storedToken;
      if (CONFIG.APPROVED_USERS[currentUser.email]) { validateToken(); }
      else { handleLogout(); }
    }
  }
  initGoogleAuth();
};
</script>
</body>
</html>
