<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ghost Assembly Tracker</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root{--bg:#0a0b12;--card:#0d0e18;--inp:#12131e;--bd:#1e2130;--bd2:#2a2d3e;--t1:#e2e4ed;--t2:#8b8fa7;--t3:#6b7094;--t4:#4d5070;--t5:#3d4060;--t6:#2d3050;--ac:#5b6eea;--ac2:#7c5cf6;--grn:#34d399;--red:#f87171;--yel:#fbbf24;--blu:#38bdf8;--org:#fb923c;--pur:#a78bfa;--fm:'Courier New',monospace;--fb:'Segoe UI',system-ui,sans-serif}
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%}
body{background:var(--bg);color:var(--t1);font-family:var(--fb);-webkit-font-smoothing:antialiased;overflow-x:hidden}
.login-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.login-bg{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 30%,rgba(91,110,234,.1) 0%,transparent 70%)}
.login-card{position:relative;z-index:1;width:100%;max-width:380px;text-align:center}
.logo{width:80px;height:80px;border-radius:24px;margin:0 auto 24px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:42px;box-shadow:0 12px 48px rgba(91,110,234,.3)}
.login-title{font-size:26px;font-weight:700;letter-spacing:-.5px;margin-bottom:8px}
.login-sub{color:var(--t3);font-size:14px;margin-bottom:32px;line-height:1.5}
.g-btn{width:100%;padding:16px 24px;border-radius:14px;border:none;background:#4285f4;color:#fff;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;font-family:var(--fb)}
.g-btn:hover{background:#3367d6}
.g-btn svg{width:20px;height:20px}
.divider{display:flex;align-items:center;margin:20px 0;color:var(--t5);font-size:12px}.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bd);margin:0 12px}
.login-err{margin-top:16px;padding:12px 16px;border-radius:10px;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:13px;line-height:1.5;display:none;white-space:pre-line}
.ubar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:1px solid #14152a}
.uname{color:var(--t2);font-size:13px}
.ubadge{font-size:10px;padding:2px 8px;border-radius:10px;margin-left:8px;font-weight:600}
.ubadge-a{background:rgba(91,110,234,.15);color:var(--ac)}.ubadge-t{background:rgba(167,139,250,.15);color:var(--pur)}
.logout{background:none;border:1px solid var(--bd);color:var(--t3);padding:5px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-family:var(--fb)}
.logout:hover{border-color:var(--red);color:var(--red)}
.ld-screen{min-height:80vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px}
.ld-spin{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:28px;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.8}}
.ld-bar-w{width:200px;height:3px;border-radius:2px;background:var(--bd);overflow:hidden}.ld-bar{height:100%;background:var(--ac);border-radius:2px;transition:width .3s}
.sch-screen{min-height:100vh;display:flex;flex-direction:column}
.sch-bg{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 20%,rgba(91,110,234,.06) 0%,transparent 70%)}
.sch-c{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;position:relative;z-index:1}
.sch-in{width:100%;padding:15px 18px;border-radius:14px;border:1px solid var(--bd);background:var(--inp);color:var(--t1);font-size:16px;font-family:var(--fm);outline:none;transition:all .2s}
.sch-in:focus{border-color:var(--ac);box-shadow:0 0 0 3px rgba(91,110,234,.12)}
.sch-in::placeholder{color:var(--t4)}
.pp{width:100%;max-width:400px;padding:8px 14px;border-radius:10px;background:rgba(91,110,234,.06);border:1px solid rgba(91,110,234,.12);margin-bottom:16px;display:flex;align-items:center;gap:8px;font-size:12px}
.br{display:flex;gap:10px;width:100%;max-width:400px}
.btn{flex:1;padding:14px;border-radius:12px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--fb)}
.btn1{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 20px rgba(91,110,234,.25)}
.btn2{border:1px solid var(--bd);background:var(--inp);color:var(--t1)}
.btn2:hover{border-color:var(--ac)}
.ds{padding:4px 10px;border-radius:8px;font-size:10px;font-weight:600;display:inline-flex;align-items:center;gap:6px;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);color:var(--grn)}
.ds-dot{width:6px;height:6px;border-radius:50%;background:var(--grn);animation:bl 2s ease-in-out infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.fbox{margin-top:32px;width:100%;max-width:400px;padding:16px;border-radius:12px;background:var(--card);border:1px solid #14152a}
.fbox-t{font-size:11px;color:var(--t5);font-weight:600;margin-bottom:10px;letter-spacing:1px}
.frow{display:flex;align-items:center;gap:10px;padding:6px 0}
.ftag{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}
.ftag-q{background:rgba(91,110,234,.12);color:var(--ac)}.ftag-t{background:rgba(251,191,36,.12);color:var(--yel)}
.fcode{font-size:12px;color:var(--t2);font-family:var(--fm)}.fdesc{font-size:11px;color:var(--t5);margin-left:auto}
.demo-s{margin-top:20px;text-align:center}.demo-l{font-size:11px;color:var(--t6);margin-bottom:8px}
.demo-chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:400px}
.demo-c{padding:5px 10px;border-radius:6px;border:1px solid #14152a;background:var(--card);color:var(--t3);font-size:11px;font-family:var(--fm);cursor:pointer}.demo-c:hover{border-color:var(--ac);color:var(--ac)}
.rh{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #14152a;background:var(--card);position:sticky;top:0;z-index:100}
.rbk{background:none;border:none;color:var(--ac);font-size:13px;cursor:pointer;padding:6px 10px;font-family:var(--fb)}
.rid{flex:1;text-align:center;font-size:14px;font-weight:700;font-family:var(--fm)}
.rlive{padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;background:rgba(52,211,153,.1);color:var(--grn)}
.tbox{margin:12px 16px 8px;padding:12px 14px;border-radius:10px;background:rgba(91,110,234,.04);border:1px solid rgba(91,110,234,.1)}
.tbox-t{font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px}
.tsteps{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.tstep{padding:3px 8px;border-radius:5px;font-size:12px}
.tstep0{background:rgba(91,110,234,.15);color:var(--ac);font-weight:600}
.tstepN{background:rgba(255,255,255,.03);color:var(--t3)}
.tarr{color:var(--t6);font-size:10px}
.tsum{font-size:11px;color:var(--t4);margin-top:8px}.thl{color:var(--ac);font-family:var(--fm)}.thl2{color:var(--t2);font-family:var(--fm)}
.sw{padding:4px 16px 100px}
.sc{margin-bottom:6px}
.sh{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
.si{font-size:22px;line-height:1}
.sinfo{flex:1;min-width:0}.slbl{font-size:14px;font-weight:600}.ssn{font-size:11px;color:var(--t3);margin-top:2px;font-family:var(--fm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mbdg{padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600}
.schv{font-size:11px;color:var(--t5);transition:transform .2s}.schvO{transform:rotate(180deg)}
.fg{padding-top:4px;padding-bottom:4px}
.fgl{padding:6px 16px;font-size:11px;font-weight:600;opacity:.7;font-family:var(--fm)}
.fr{display:flex;justify-content:space-between;align-items:center;padding:11px 16px;cursor:pointer;border-radius:8px;border-left:3px solid transparent;margin:0 4px}
.fr:hover{background:rgba(255,255,255,.03)}
.frH{background:rgba(91,110,234,.08);border-left-color:var(--ac)}
.fl{display:flex;align-items:center;gap:8px;min-width:0;flex:1}
.flbl{font-size:13px;color:var(--t3);flex-shrink:0}
.frt{display:flex;align-items:center;gap:8px}
.fv{font-size:13px;color:var(--t2);text-align:right;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fvsn{color:var(--t1);font-family:var(--fm);font-weight:600}
.fei{font-size:10px;color:var(--t5)}
.ib{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:600;flex-shrink:0}
.ib-l{background:rgba(91,110,234,.12);color:var(--ac)}.ib-c{background:rgba(251,191,36,.12);color:var(--yel)}.ib-d{background:rgba(56,189,248,.12);color:var(--blu)}
.ckd{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px}
.ckP{background:rgba(52,211,153,.15);border:1.5px solid var(--grn);color:var(--grn)}
.ckF{background:rgba(248,113,113,.1);border:1.5px solid rgba(248,113,113,.35);color:var(--red)}
.escreen{min-height:100vh;display:flex;flex-direction:column}
.eh{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #14152a;background:var(--card)}
.ecn{background:none;border:none;color:var(--red);font-size:13px;cursor:pointer;padding:6px 10px;font-family:var(--fb)}
.esv{background:none;border:none;color:var(--ac);font-size:13px;cursor:pointer;padding:6px 10px;font-weight:600;font-family:var(--fb)}
.ebody{flex:1;display:flex;flex-direction:column;align-items:center;padding:24px 24px 24px}
.eold{padding:8px 16px;border-radius:8px;margin-bottom:24px;background:rgba(248,113,113,.04);border:1px solid rgba(248,113,113,.1);font-family:var(--fm);font-size:13px;color:var(--red);text-decoration:line-through;opacity:.5;width:100%;max-width:380px;text-align:center}
.etin{width:100%;padding:16px 18px;border-radius:12px;border:2px solid var(--ac);background:var(--inp);color:var(--t1);font-size:18px;font-family:var(--fm);font-weight:600;outline:none;text-align:center;box-shadow:0 0 0 4px rgba(91,110,234,.1)}
.edin{width:100%;padding:16px 18px;border-radius:12px;border:2px solid var(--blu);background:var(--inp);color:var(--t1);font-size:18px;font-family:var(--fm);font-weight:600;outline:none;text-align:center;box-shadow:0 0 0 4px rgba(56,189,248,.1);color-scheme:dark}
.dqb{display:flex;gap:8px;margin-top:12px}.dqbb{flex:1;padding:10px;border-radius:8px;border:1px solid var(--bd);background:var(--inp);color:var(--blu);font-size:13px;cursor:pointer;font-family:var(--fb)}
.do{padding:12px 16px;border-radius:10px;cursor:pointer;border:1px solid var(--bd);background:var(--inp);display:flex;align-items:center;justify-content:space-between}.doS{border:2px solid var(--ac);background:rgba(91,110,234,.1)}
.doi{display:flex;align-items:center;gap:10px}
.dor{width:20px;height:20px;border-radius:10px;border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center}.dorS{border-color:var(--ac)}
.dorD{width:10px;height:10px;border-radius:5px;background:var(--ac)}
.dot{font-size:14px;font-family:var(--fm);font-weight:500;color:var(--t2)}.dotS{color:var(--t1)}
.doCur{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(251,191,36,.1);color:var(--yel);font-weight:600}
.savb{margin-top:28px;padding:14px 40px;border-radius:12px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--fb)}
.savA{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 20px rgba(91,110,234,.2)}
.savI{background:var(--bd);color:var(--t4);cursor:default}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.toast-s{background:#121e16;border:1px solid rgba(52,211,153,.2);color:var(--grn)}
.toast-e{background:#1e1214;border:1px solid rgba(248,113,113,.2);color:var(--red)}
.rfb{position:fixed;bottom:20px;right:20px;z-index:100;width:48px;height:48px;border-radius:14px;border:1px solid var(--bd);background:var(--card);color:var(--t3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.rfb:hover{border-color:var(--ac);color:var(--ac)}
.rfS{animation:spin 1s linear infinite}@keyframes spin{100%{transform:rotate(360deg)}}
.dbg{margin:12px 16px;padding:14px;border-radius:10px;background:var(--inp);border:1px solid var(--bd);font-size:11px;line-height:1.7;max-height:400px;overflow-y:auto;font-family:var(--fm);color:var(--t3)}
.dbg b{color:var(--yel)}.dbg code{color:var(--ac);background:rgba(91,110,234,.08);padding:1px 4px;border-radius:3px}
.dbgbtn{padding:6px 14px;border-radius:8px;border:1px solid var(--yel);background:transparent;color:var(--yel);font-size:11px;cursor:pointer;font-family:var(--fb);margin-left:8px}
.err-b{margin:16px;padding:16px;border-radius:12px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);color:var(--red);font-size:13px;line-height:1.5}
.err-b code{display:block;margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(248,113,113,.05);font-family:var(--fm);font-size:11px;word-break:break-all;color:var(--t2)}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ===== CONFIG =====
const CONFIG={
  CLIENT_ID:'1088099187141-ut0dn0scqt3h99htf3rg8gsrg2oo1ad8.apps.googleusercontent.com',
  SCOPES:'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
  SHEET_ID:'1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M',
  APPROVED_USERS:{
    'anikettelexistence@gmail.com':{name:'Aniket',team:'production',isAdmin:true},
    'igarashi@tx-inc.com':{name:'Igarashi',team:'production',isAdmin:false},
    'niidome@tx-inc.com':{name:'Niidome',team:'production',isAdmin:false},
  },
  TABS:{ghosts:'00_GHOST',lMotors:'01_L-motor',a12Motors:'02_A12-motor',a35Motors:'03_A35-motor',a4Motors:'04_A4-motor',mobileBases:'05_Mobile Base',pillars:'06_Pillar',headBodies:'07_Head & Body',grippers:'08_Gripper',arms:'09_Arm',deployKits:'10_Deploy Kit'},
};

// ===== AUTH =====
let accessToken=null,tokenClient=null,currentUser={name:'',email:'',isAdmin:false,isGuest:false,team:''};

// ===== PARSING =====
const ASSEMBLY_CODES={GST:{type:'ghost',label:'Ghost'},MBB:{type:'mobileBase',label:'Mobile Base'},PLR:{type:'pillar',label:'Pillar'},HBD:{type:'headBody',label:'Head & Body'},GPR:{type:'gripper',label:'Gripper'},ARM:{type:'arm',label:'Arm'},DPK:{type:'deployKit',label:'Deploy Kit'},LAC:{type:'lMotor',label:'L-Motor'},A12:{type:'a12Motor',label:'A12 Motor'},A35:{type:'a35Motor',label:'A35 Motor'},A4A:{type:'a4Motor',label:'A4 Motor'}};
const SHORTHAND_MAP={GH:'GST',GHOST:'GST',GST:'GST',MB:'MBB',MBB:'MBB',PL:'PLR',PLR:'PLR',PILLAR:'PLR',HB:'HBD',HBD:'HBD',HEAD:'HBD',GR:'GPR',GPR:'GPR',GRIP:'GPR',ARM:'ARM',DPK:'DPK',DK:'DPK',LM:'LAC',LAC:'LAC',A12:'A12',A35:'A35',A4:'A4A',A4A:'A4A',PDB:'PDB',IOB:'IOB',MDB:'MDB',BRK:'BRK',BAT:'BAT'};
function parseInput(raw){const i=raw.trim();if(!i)return null;const f=i.match(/^GT\d{3}-([A-Z0-9]{2,3})-(\d{3,5})$/i);if(f){const c=f[1].toUpperCase(),n=parseInt(f[2]),a=ASSEMBLY_CODES[c];if(a)return{...a,num:n,fullSN:i.toUpperCase(),inputType:'qr'};}if(/^\d{5,6}$/.test(i))return{type:'galina',label:'GALINA',num:parseInt(i),fullSN:i,inputType:'manual'};const s=i.match(/^([A-Z]{2,6})[- ]?(\d+)$/i);if(s){const p=s[1].toUpperCase(),n=parseInt(s[2]),c=SHORTHAND_MAP[p];if(c&&ASSEMBLY_CODES[c])return{...ASSEMBLY_CODES[c],num:n,fullSN:`${p}-${n}`,inputType:'shorthand'};if(['PDB','IOB','MDB','BRK','BAT'].includes(p))return{type:p.toLowerCase(),label:p,num:n,fullSN:`${p}-${n}`,inputType:'shorthand'};}return null;}

// ===== SECTION CONFIG =====
const SC={ghost:{icon:'üëª',label:'Ghost',color:'#5b6eea',bg:'#151728'},mobileBase:{icon:'üõû',label:'Mobile Base',color:'#34d399',bg:'#13201a'},mbMotors:{icon:'‚öôÔ∏è',label:'L-Motors (MB)',color:'#6ee7b7',bg:'#131d19'},pillar:{icon:'üèõÔ∏è',label:'Pillar',color:'#a78bfa',bg:'#1a1528'},plMotors:{icon:'‚öôÔ∏è',label:'L-Motor (Pillar)',color:'#6ee7b7',bg:'#131d19'},headBody:{icon:'üß†',label:'Head & Body',color:'#f87171',bg:'#201414'},arm:{icon:'ü¶æ',label:'Arm',color:'#fbbf24',bg:'#201c12'},armA12:{icon:'‚öôÔ∏è',label:'A12 Motors',color:'#6ee7b7',bg:'#131d19'},armA35:{icon:'‚öôÔ∏è',label:'A35 Motor',color:'#6ee7b7',bg:'#131d19'},armA4:{icon:'‚öôÔ∏è',label:'A4 Motor',color:'#6ee7b7',bg:'#131d19'},gripper:{icon:'ü§è',label:'Gripper',color:'#38bdf8',bg:'#121a20'},deployKit:{icon:'üì¶',label:'Deploy Kit',color:'#fb923c',bg:'#1e1812'}};
const FIELD_LABELS={'S/N':'S/N','SW':'SW','Endpoint':'Endpoint','SoraFW':'Sora FW','Sora FW':'Sora FW','FW':'FW','Sora Time zone':'Sora TZ','Mobile Base':'Mobile Base S/N','Pillar':'Pillar S/N','Body&Head':'Head & Body S/N','Arm':'Arm S/N','Deploy Kit':'Deploy Kit S/N','ÊâãÈ†ÜÊõ∏ ver.':'SOP Ver.','SOP ver.':'SOP Ver.','‰ΩøÁî®SOP ver.':'SOP Ver.','M-BOM ver.':'M-BOM Ver.','ÁµÑÁ´ã‰∫∫Âì°':'Assembler','ÊôÇÈñì':'Time','ÂÆå‰∫ÜÊó•':'Completed','ÂÇôËÄÉ':'Notes','L1 motor S/N':'L1 Motor','L2 motor S/N':'L2 Motor','L3 motor S/N':'L3 Motor','PDB S/N':'PDB S/N','PDB FW':'PDB FW','ECB Ver.':'ECB Ver.','L2 belt tension [N]':'L2 Belt (N)','L3 belt tension (N)':'L3 Belt (N)','BRK S/N':'Brake S/N','GALINA S/N':'GALINA S/N','AGX image':'AGX Image','IP':'IP Address','IOB S/N':'IOB S/N','IOB FW':'IOB FW','A1 motor S/N':'A1 Motor','A2 motor S/N':'A2 Motor','A3 motor S/N':'A3 Motor','A4 motor S/N':'A4 Motor','A5 motor S/N':'A5 Motor','Gripper S/N':'Gripper S/N','BAT S/N':'Battery S/N','A4 belt tension':'A4 Belt','MDB S/N':'MDB S/N','MDB FW':'MDB FW','enc':'Encoder','mod':'Mod','ÊäµÊäó cNÔΩ•m':'Resistance','GANTRYÈï∑„Åï':'Gantry Length','pick up config':'Pickup Config','fail status':'Fail Status','fail status/comment':'Fail Status','‰ΩøÁî®':'Usage','ÈÉ®ÂìÅÂá∫Â∫´Êó•':'Parts Issue','ÈÉ®ÂìÅ Âá∫Â∫´Êó•':'Parts Issue','ÁµÑÁ´ã ÊôÇÈñì':'Assy Time','ÁµÑÁ´ãÊôÇÈñì':'Assy Time','stator frame':'Stator Frame','rotor frame':'Rotor Frame','motor cap':'Motor Cap','Ê¢±ÂåÖÂÆå‰∫Ü':'Packing Done','ÂÆå‰∫Ü':'Done','setup':'Setup','token':'Token','ÈÖçÁΩÆ':'Placement','Âá∫Â∫´Êó•':'Issue Date','ÈÉ®ÁΩ≤':'Dept','ÁõÆÁöÑ':'Purpose','‰ΩøÁî®ÊâãÈ†ÜÊõ∏ ver.':'SOP Ver.'};
function shouldSkipField(f){if(f==='#'||f==='_rowIdx')return true;if(/^\d+$/.test(f))return true;if(/^(ÂÖ±ÈÄö|ÁâπÂÆö)$/.test(f))return true;if(f.includes('ECN')&&(f.includes('ÂØæÂøú')||f.includes('Ëá™ÂãïÂÖ•Âäõ')||f.includes('Áµ±Âêà')))return true;if(/^(GP-)?ECN-/.test(f)||f.startsWith('ecn-'))return true;if(/^\d+\.\d+\.\d+/.test(f))return true;if(f.startsWith('__'))return true;if(/^(ACT|ecn-)/.test(f))return true;
  // Row 1 group headers (from merged cells)
  if(/^(SWÈñ¢ÈÄ£|ÊßãÊàê|Âá∫Â∫´ÂÖà|„É≠„Éú„ÉÉ„ÉàÂá∫Ëç∑Ê∫ñÂÇô|ARM‰ª•Â§ñ)$/.test(f))return true;
  if(f==='ARM'&&f!=='Arm')return true; // skip uppercase-only ARM group header
  // ECN detail columns with specific patterns
  if(/^(i55|i61|i64|issue|RCM|„É™„ÉØ„Éº„ÇØ|„ÉÜ„Çπ„Éà|„ÉÜ„Éº„Éó|Ê§úÊüª|Ê≥®ÊÑè|425|MP2|ÊúÄÊñ∞)/.test(f))return true;
  if(/ÁÇπÊ§ú|‰øÆÊ≠£|Â§âÊõ¥|ËøΩÂä†|Ââä„Çã|ÂØæÁ≠ñ|Á∑©„Åø|Èò≤Ê∞¥|„Ç±„Éº„Éñ„É´|„Ç∞„É™„Çπ|„Å∞„Å≠|„ÅØ„Çì„Å†|„Éû„Éº„Ç≠„É≥„Ç∞|„Éî„É≥|ÂêàÊ†º|Bracket|Dummy|STOCK|ÊàêÂûã/.test(f))return true;
  return false;}

// ===== VALIDATION =====
const V={};
['ghost.SW','ghost.SoraFW','ghost.FW','ghost.Sora Time zone'].forEach(k=>{V[k]={type:'dropdown',options:['v3.0.0','v3.1.0','v3.2.0','v3.2.1','v3.3.0']};});
V['ghost.ÂÆå‰∫ÜÊó•']={type:'date'};
['mobileBase.PDB FW','headBody.IOB FW','gripper.IOB FW'].forEach(k=>{V[k]={type:'dropdown',options:['1.8.0.0','1.9.0.0','1.9.1.0','2.0.0.0','2.1.0.0']};});
['mobileBase.ÂÆå‰∫ÜÊó•','pillar.ÂÆå‰∫ÜÊó•','headBody.ÂÆå‰∫ÜÊó•','arm.ÂÆå‰∫ÜÊó•','gripper.ÂÆå‰∫ÜÊó•','deployKit.ÂÆå‰∫ÜÊó•'].forEach(k=>{V[k]={type:'date'};});
['mbMotors','plMotors','armA12','armA35','armA4'].forEach(s=>{V[`${s}.MDB FW`]={type:'dropdown',options:['1.9.0.0','1.9.2.0','2.0.0.0','2.1.0.0']};V[`${s}.enc`]={type:'checkbox'};V[`${s}.ÂÆå‰∫ÜÊó•`]={type:'date'};});
function getV(s,f){
  let v=V[`${s}.${f}`];if(v)return v;
  // Try partial match: "IOB FW 2.0.0.0" should match "IOB FW"
  for(const[k,val]of Object.entries(V)){
    const[ks,kf]=k.split('.',2);
    if(ks===s && f.startsWith(kf))return val;
  }
  // Motor groups
  if(f==='ÂÆå‰∫ÜÊó•'||f==='enc')return V[`mbMotors.${f}`]||null;
  if(f.toLowerCase().includes('ÂÆå‰∫Ü'))return{type:'date'};
  if(f==='enc')return{type:'checkbox'};
  // FW fields are typically dropdowns
  if(/FW\b/i.test(f)||/fw\b/.test(f))return{type:'dropdown',options:['1.8.0.0','1.9.0.0','1.9.1.0','2.0.0.0','2.1.0.0']};
  return null;
}

// ===== DATA =====
let DATA={},LOADING=false;
let SHEET_META={}; // {key: {headers:[], startRow:number, tabName:string}}

async function loadAllData(onP){LOADING=true;const E=Object.entries(CONFIG.TABS);const T=E.length;let L=0;const errs=[];

  function parseSheet(raw,key,tabName){
    if(raw.length<2)return[];
    let hdr=raw[0];let startRow=1;
    // Detect multi-row headers: if row 1 has many empty cells, combine with row 2
    const emptyCount=hdr.filter(h=>!h||!h.trim()).length;
    const totalCols=Math.max(hdr.length,raw.length>1?raw[1].length:0);
    if(totalCols>5 && emptyCount/totalCols>0.3 && raw.length>2){
      // Merge row 1 + row 2: prefer row 2 value, fall back to row 1
      const row2=raw[1]||[];
      const merged=[];
      for(let ci=0;ci<totalCols;ci++){
        const h1=(hdr[ci]||'').trim();
        const h2=(row2[ci]||'').trim();
        merged[ci]=h2||h1; // prefer row 2 (actual col names) over row 1 (group headers)
      }
      hdr=merged;startRow=2;
    }
    // Handle duplicate column names by appending _2, _3 etc
    const seen={};
    hdr=hdr.map(h=>{if(!h)return h;if(!seen[h]){seen[h]=1;return h;}seen[h]++;return`${h}_${seen[h]}`;});
    // Store metadata for write-back
    SHEET_META[key]={headers:[...hdr],startRow,tabName};
    return raw.slice(startRow).map((row,ri)=>{const o={_rowIdx:ri};let has=false;
      hdr.forEach((c,ci)=>{if(c){const v=row[ci]!=null?String(row[ci]):'';o[c]=v;if(v)has=true;}});
      return has?o:null;}).filter(Boolean);
  }

  try{const R=E.map(([,t])=>encodeURIComponent(t));const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values:batchGet?${R.map(r=>`ranges=${r}`).join('&')}`;onP?.(0,T,'Fetching...');
    const resp=await fetch(url,{headers:{'Authorization':`Bearer ${accessToken}`}});if(!resp.ok)throw new Error(`HTTP ${resp.status}`);const j=await resp.json();
    (j.valueRanges||[]).forEach((vr,i)=>{const[key]=E[i];const raw=vr.values||[];DATA[key]=parseSheet(raw,key,E[i][1]);L++;onP?.(L,T,E[i][1]);});
  }catch(e){console.warn('Batch failed:',e);for(const[key,tab]of E){try{onP?.(L,T,tab);const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(tab)}`,{headers:{'Authorization':`Bearer ${accessToken}`}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const j=await r.json();const raw=j.values||[];DATA[key]=parseSheet(raw,key,tab);L++;}catch(er){errs.push({tab,error:er.message});DATA[key]=[];L++;}}}
  LOADING=false;onP?.(T,T,'Done');buildDebugInfo();return errs;}

// ===== FLEXIBLE COLUMN MATCHING =====
function getSNField(rows){if(!rows||!rows.length)return'S/N';const K=Object.keys(rows[0]);const k=K.find(k=>/^S\/?N$/i.test(k.trim()));if(k)return k;for(const k2 of K){if(rows.some(r=>/^GT\d{3}-[A-Z0-9]{2,3}-\d{3,5}$/i.test(r[k2]||'')))return k2;}return K.find(k=>!shouldSkipField(k))||K[0];}
function getRowSN(row,list){return(row[getSNField(list||[row])]||'').trim();}

// getCol: flexibly find a value from a row using multiple possible column name keywords
function getCol(row,...keywords){if(!row)return'';const K=Object.keys(row);
  for(const kw of keywords){if(row[kw]!==undefined&&row[kw]!=='')return row[kw];}
  for(const kw of keywords){const kwN=kw.toLowerCase().replace(/[\s_\-\/&]/g,'');for(const k of K){const kN=k.toLowerCase().replace(/[\s_\-\/&]/g,'');if(kN===kwN&&row[k]!=='')return row[k];}}
  for(const kw of keywords){const kwL=kw.toLowerCase();for(const k of K){if(k.toLowerCase().includes(kwL)&&row[k]!=='')return row[k];}}
  return'';}

function findRowBySN(list,snVal){if(!list||!snVal)return null;const up=snVal.toUpperCase().trim();if(!up)return null;const sf=getSNField(list);let r=list.find(r=>(r[sf]||'').toUpperCase().trim()===up);if(r)return r;
  const K=Object.keys(list[0]||{});const snK=K.filter(k=>/s[\s\/]?n/i.test(k));for(const k of snK){r=list.find(r=>(r[k]||'').toUpperCase().trim()===up);if(r)return r;}return null;}

function findRowByCol(list,colKWs,val){if(!list||!val)return null;const up=val.toUpperCase().trim();for(const row of list){const v=getCol(row,...colKWs);if(v&&v.toUpperCase().trim()===up)return row;}return null;}

function findByNum(col,num){if(!col)return null;const f=getSNField(col);return col.find(i=>{const m=(i[f]||'').match(/(\d+)$/);return m&&parseInt(m[1])===num;});}

// ===== TRACE =====
function findGhost(colKWs,subSN){if(!DATA.ghosts||!subSN)return null;const up=subSN.toUpperCase().trim();
  for(const g of DATA.ghosts){const v=getCol(g,...colKWs);if(v&&v.toUpperCase().trim()===up)return g;}
  for(const g of DATA.ghosts){if(Object.values(g).some(v=>v&&v.toUpperCase().trim()===up))return g;}
  return null;}

function traceToGhost(input){const P=parseInput(input);if(!P)return null;let ghost,path=[],matchedIn=P.label,matchedSN='';const D=DATA;
  const sn=(r,l)=>getRowSN(r,l);
  const findItem=(list)=>{if(!list)return null;let it=P.fullSN.match(/^GT/)?findRowBySN(list,P.fullSN):null;if(!it)it=findByNum(list,P.num);return it;};

  switch(P.type){
    case'ghost':{const g=findItem(D.ghosts);if(g){ghost=g;path=['Ghost'];matchedSN=sn(g,D.ghosts);}break;}
    case'mobileBase':{const mb=findItem(D.mobileBases);if(mb){const s=sn(mb,D.mobileBases);ghost=findGhost(['Mobile Base'],s);path=['Mobile Base','Ghost'];matchedSN=s;}break;}
    case'pillar':{const pl=findItem(D.pillars);if(pl){const s=sn(pl,D.pillars);ghost=findGhost(['Pillar'],s);path=['Pillar','Ghost'];matchedSN=s;}break;}
    case'headBody':{const hb=findItem(D.headBodies);if(hb){const s=sn(hb,D.headBodies);ghost=findGhost(['Body&Head','Head & Body','Body'],s);path=['Head & Body','Ghost'];matchedSN=s;}break;}
    case'arm':{const a=findItem(D.arms);if(a){const s=sn(a,D.arms);ghost=findGhost(['Arm'],s);path=['Arm','Ghost'];matchedSN=s;}break;}
    case'gripper':{const gr=findItem(D.grippers);if(gr){const gs=sn(gr,D.grippers);const a=findRowByCol(D.arms,['Gripper S/N','gripper'],gs);if(a){ghost=findGhost(['Arm'],sn(a,D.arms));}path=['Gripper','Arm','Ghost'];matchedSN=gs;}break;}
    case'deployKit':{const dk=findItem(D.deployKits);if(dk){const s=sn(dk,D.deployKits);ghost=findGhost(['Deploy Kit','DeployKit'],s);path=['Deploy Kit','Ghost'];matchedSN=s;}break;}
    case'lMotor':{const lm=findItem(D.lMotors);if(lm){const ls=sn(lm,D.lMotors);
      let found=false;for(const mb of(D.mobileBases||[])){for(const c of['L1 motor S/N','L2 motor S/N']){const v=getCol(mb,c);if(v&&v.toUpperCase().trim()===ls.toUpperCase().trim()){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=[`L-Motor (${c.substring(0,2)})`,'Mobile Base','Ghost'];found=true;break;}}if(found)break;}
      if(!found){for(const pl of(D.pillars||[])){const v=getCol(pl,'L3 motor S/N');if(v&&v.toUpperCase().trim()===ls.toUpperCase().trim()){ghost=findGhost(['Pillar'],sn(pl,D.pillars));path=['L-Motor (L3)','Pillar','Ghost'];found=true;break;}}}
      matchedSN=ls;}break;}
    case'a12Motor':case'a35Motor':case'a4Motor':{const lk=P.type==='a12Motor'?'a12Motors':P.type==='a35Motor'?'a35Motors':'a4Motors';const m=findItem(D[lk]);if(m){const ms=sn(m,D[lk]);const cols=P.type==='a12Motor'?['A1 motor S/N','A2 motor S/N']:P.type==='a35Motor'?['A3 motor S/N','A5 motor S/N']:['A4 motor S/N'];
      for(const a of(D.arms||[])){for(const c of cols){const v=getCol(a,c);if(v&&v.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Arm'],sn(a,D.arms));path=[`${P.label} (${c.substring(0,2)})`,'Arm','Ghost'];break;}}if(ghost)break;}
      matchedSN=ms;}break;}
    case'galina':{const hb=findRowByCol(D.headBodies,['GALINA S/N','GALINA'],String(P.num));if(hb){ghost=findGhost(['Body&Head','Head & Body'],sn(hb,D.headBodies));path=['GALINA','Head & Body','Ghost'];matchedSN=String(P.num);}break;}
    case'pdb':{const v=`PDB-${P.num}`;const mb=findRowByCol(D.mobileBases,['PDB S/N','PDB'],v)||findRowByCol(D.mobileBases,['PDB S/N'],String(P.num));if(mb){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=['PDB','Mobile Base','Ghost'];matchedSN=v;}break;}
    case'iob':{const v=`IOB-${P.num}`;let hb=findRowByCol(D.headBodies,['IOB S/N','IOB'],v)||findRowByCol(D.headBodies,['IOB S/N'],String(P.num));if(hb){ghost=findGhost(['Body&Head','Head & Body'],sn(hb,D.headBodies));path=['IOB','Head & Body','Ghost'];matchedSN=v;break;}
      let gr=findRowByCol(D.grippers,['IOB S/N','IOB'],v);if(gr){const gs=sn(gr,D.grippers);const a=findRowByCol(D.arms,['Gripper S/N'],gs);if(a)ghost=findGhost(['Arm'],sn(a,D.arms));path=['IOB','Gripper','Arm','Ghost'];matchedSN=v;}break;}
    case'mdb':{const v=`MDB-${P.num}`;for(const lk of['lMotors','a12Motors','a35Motors','a4Motors']){const m=findRowByCol(D[lk],['MDB S/N','MDB'],v);if(m){const ms=sn(m,D[lk]);/* trace up */for(const a of(D.arms||[])){for(const c of['A1 motor S/N','A2 motor S/N','A3 motor S/N','A4 motor S/N','A5 motor S/N']){const cv=getCol(a,c);if(cv&&cv.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Arm'],sn(a,D.arms));path=['MDB',`Motor (${c.substring(0,2)})`,'Arm','Ghost'];break;}}if(ghost)break;}
      if(!ghost){for(const mb of(D.mobileBases||[])){for(const c of['L1 motor S/N','L2 motor S/N']){const cv=getCol(mb,c);if(cv&&cv.toUpperCase().trim()===ms.toUpperCase().trim()){ghost=findGhost(['Mobile Base'],sn(mb,D.mobileBases));path=['MDB',`L-Motor (${c.substring(0,2)})`,'Mobile Base','Ghost'];break;}}if(ghost)break;}}
      matchedSN=v;break;}}break;}
    case'brk':{const v=`BRK-${P.num}`;const pl=findRowByCol(D.pillars,['BRK S/N','BRK'],v)||findRowByCol(D.pillars,['BRK S/N'],String(P.num));if(pl){ghost=findGhost(['Pillar'],sn(pl,D.pillars));path=['Brake','Pillar','Ghost'];matchedSN=v;}break;}
    case'bat':{const v=`BAT-${P.num}`;const a=findRowByCol(D.arms,['BAT S/N','BAT'],v)||findRowByCol(D.arms,['BAT S/N'],String(P.num));if(a){ghost=findGhost(['Arm'],sn(a,D.arms));path=['Battery','Arm','Ghost'];matchedSN=v;}break;}
  }
  if(!ghost)return null;return{ghost,path,matchedIn,matchedSN,parsed:P};}

// ===== GHOST TREE =====
function getGhostTree(ghostRow){if(!ghostRow)return null;const D=DATA;
  const mbSN=getCol(ghostRow,'Mobile Base'),plSN=getCol(ghostRow,'Pillar'),hbSN=getCol(ghostRow,'Body&Head','Head & Body','Body'),armSN=getCol(ghostRow,'Arm'),dkSN=getCol(ghostRow,'Deploy Kit','DeployKit');
  console.log('[Tree] Ghost keys:',Object.keys(ghostRow).join(', '));
  console.log('[Tree] MB:',mbSN,'PL:',plSN,'HB:',hbSN,'ARM:',armSN,'DK:',dkSN);
  const mb=findRowBySN(D.mobileBases,mbSN),pl=findRowBySN(D.pillars,plSN),hb=findRowBySN(D.headBodies,hbSN),arm=findRowBySN(D.arms,armSN),dk=findRowBySN(D.deployKits,dkSN);
  const grSN=arm?getCol(arm,'Gripper S/N','gripper','Gripper'):'';const gr=findRowBySN(D.grippers,grSN);
  const mbMotors=[];if(mb){['L1 motor S/N','L2 motor S/N'].forEach(c=>{const s=getCol(mb,c);if(s){const m=findRowBySN(D.lMotors,s);if(m)mbMotors.push(m);}});}
  const plMotors=[];if(pl){const s=getCol(pl,'L3 motor S/N');if(s){const m=findRowBySN(D.lMotors,s);if(m)plMotors.push(m);}}
  const armA12=[],armA35=[],armA4=[];
  if(arm){['A1 motor S/N','A2 motor S/N'].forEach(c=>{const s=getCol(arm,c);if(s){const m=findRowBySN(D.a12Motors,s);if(m)armA12.push(m);}});['A3 motor S/N','A5 motor S/N'].forEach(c=>{const s=getCol(arm,c);if(s){const m=findRowBySN(D.a35Motors,s);if(m)armA35.push(m);}});const a4s=getCol(arm,'A4 motor S/N');if(a4s){const m=findRowBySN(D.a4Motors,a4s);if(m)armA4.push(m);}}
  console.log('[Tree] Found:','MB=',!!mb,'PL=',!!pl,'HB=',!!hb,'ARM=',!!arm,'GR=',!!gr,'DK=',!!dk,'mbM=',mbMotors.length,'plM=',plMotors.length,'a12=',armA12.length,'a35=',armA35.length,'a4=',armA4.length);
  return{ghost:ghostRow,mb,pl,hb,arm,gr,dk,mbMotors,plMotors,armA12,armA35,armA4};}

// ===== DEBUG =====
let debugInfo='';
function buildDebugInfo(){const L=[];
  // Show each dataset
  for(const[k,rows]of Object.entries(DATA)){if(rows&&rows.length){const cols=Object.keys(rows[0]);const sf=getSNField(rows);L.push(`<b>${k}</b> (${rows.length} rows) S/N col: <code>${sf}</code> first: <code>${(rows[0][sf]||'').substring(0,25)}</code>`);L.push(`Columns: ${cols.slice(0,15).map(c=>'<code>'+c.replace(/</g,'&lt;').substring(0,20)+'</code>').join(', ')}${cols.length>15?' ...'+(cols.length-15)+' more':''}`);
  }else L.push(`<b>${k}</b>: empty`);}
  // Show Ghost row #1 ALL columns & values
  if(DATA.ghosts&&DATA.ghosts[0]){const g=DATA.ghosts[0];
    L.push('<hr><b style="color:#5b6eea">GHOST ROW #1 ‚Äî ALL KEY COLUMNS:</b>');
    const linkCols=['Mobile Base','Pillar','Body&Head','Head & Body','Body','Arm','Deploy Kit','DeployKit','S/N'];
    linkCols.forEach(c=>{const v=g[c];L.push(`  <code>${c}</code> = <code style="color:${v?'#34d399':'#f87171'}">${v||'(empty/missing)'}</code>`);});
    L.push('<br><b style="color:#fbbf24">ALL Ghost row #1 columns:</b>');
    Object.entries(g).forEach(([k,v])=>{if(v)L.push(`  <code>${k.substring(0,30)}</code> = <code>${String(v).substring(0,40)}</code>`);});
  }
  // Show sub-assembly first rows
  const checks=[['mobileBases','ghosts link',"Mobile Base"],['pillars','ghosts link',"Pillar"],['headBodies','ghosts link',"Body&Head"],['arms','ghosts link',"Arm"],['deployKits','ghosts link',"Deploy Kit"]];
  checks.forEach(([dk,lbl,ghostCol])=>{
    if(DATA[dk]&&DATA[dk][0]){const r=DATA[dk][0];const rsn=getRowSN(r,DATA[dk]);const gRow=DATA.ghosts?DATA.ghosts[0]:null;const gVal=gRow?getCol(gRow,ghostCol):'';
      L.push(`<br><b>${dk}[0]</b> SN=<code>${rsn}</code> Ghost col "<code>${ghostCol}</code>"=<code style="color:${gVal===rsn?'#34d399':'#f87171'}">${gVal||'empty'}</code> ${gVal===rsn?'‚úÖ MATCH':'‚ùå NO MATCH'}`);}});
  debugInfo=L.join('<br>');}

// ===== STATE =====
const S={screen:'login',searchInput:'',parsedPreview:null,result:null,tree:null,expanded:new Set(),editing:null,editValue:'',toast:null,scanning:false,loadErrors:[],refreshing:false,showDebug:false};
const $=s=>document.querySelector(s);const app=()=>document.getElementById('app');
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escA(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// Edit registry - avoids putting arbitrary strings in onclick handlers
let editRegistry=[];
function regEdit(sec,sn,field,value){const id=editRegistry.length;editRegistry.push({sec,sn,field,value});return id;}
function doEdit(id){const e=editRegistry[id];if(e)startEdit(e.sec,e.sn,e.field,e.value);}

function render(){editRegistry=[];switch(S.screen){case'login':rLogin();break;case'loading':rLoad();break;case'search':rSearch();break;case'result':rResult();break;case'edit':rEdit();break;}}

// ===== LOGIN =====
function rLogin(){app().innerHTML=`<div class="login-screen"><div class="login-bg"></div><div class="login-card"><div class="logo">üëª</div><h1 class="login-title">Ghost Tracker</h1><p class="login-sub">Assembly tracking for Ghost robots.<br>Sign in to access production data.</p><button class="g-btn" onclick="doLogin()"><svg viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Sign in with Google</button><div class="login-err" id="loginErr"></div></div></div>${rToast()}`;}
function doLogin(){if(!tokenClient){$('#loginErr').textContent='Google loading... try again.';$('#loginErr').style.display='block';return;}tokenClient.requestAccessToken();}
async function fetchUser(){try{const r=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{'Authorization':`Bearer ${accessToken}`}});if(!r.ok)throw 0;const i=await r.json();const a=CONFIG.APPROVED_USERS[i.email||''];if(!a){const el=$('#loginErr');el.textContent=`Access denied.\n${i.email} not approved.`;el.style.display='block';accessToken=null;localStorage.removeItem('gat');return;}currentUser={name:a.name,email:i.email,team:a.team,isAdmin:a.isAdmin,isGuest:false};localStorage.setItem('gau',JSON.stringify(currentUser));startApp();}catch{const el=$('#loginErr');if(el){el.textContent='Login failed.';el.style.display='block';}}}
function doLogout(){if(accessToken)try{google.accounts.oauth2.revoke(accessToken);}catch{}localStorage.removeItem('gat');localStorage.removeItem('gau');accessToken=null;currentUser={name:'',email:'',isAdmin:false,isGuest:false,team:''};S.screen='login';render();}
async function startApp(){S.screen='loading';render();S.loadErrors=await loadAllData((l,t,c)=>{LP={l,t,c};rLoad();});S.screen='search';render();}
async function valToken(){try{const r=await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token='+accessToken);if(r.ok)startApp();else{localStorage.removeItem('gat');localStorage.removeItem('gau');accessToken=null;render();}}catch{localStorage.removeItem('gat');accessToken=null;render();}}

// ===== LOADING =====
let LP={l:0,t:11,c:''};
function rLoad(){const p=LP.t?Math.round(LP.l/LP.t*100):0;app().innerHTML=`${rUBar()}<div class="ld-screen"><div class="ld-spin">üëª</div><div style="color:var(--t3);font-size:14px">Loading assembly data...</div><div class="ld-bar-w"><div class="ld-bar" style="width:${p}%"></div></div><div style="color:var(--t5);font-size:12px;font-family:var(--fm)">${LP.c||'Connecting...'}</div></div>`;}
function rUBar(){if(!currentUser.name)return'';const b=currentUser.isAdmin?'<span class="ubadge ubadge-a">ADMIN</span>':`<span class="ubadge ubadge-t">${esc((currentUser.team||'team').toUpperCase())}</span>`;return`<div class="ubar"><span class="uname">${esc(currentUser.name)}${b}</span><button class="logout" onclick="doLogout()">Sign out</button></div>`;}

// ===== SEARCH =====
function rSearch(){const pv=S.parsedPreview;const ds=[];
  if(DATA.ghosts?.length){const f=getSNField(DATA.ghosts);DATA.ghosts.slice(0,2).forEach(r=>r[f]&&ds.push(r[f]));}
  if(DATA.mobileBases?.length){const f=getSNField(DATA.mobileBases);DATA.mobileBases.slice(0,1).forEach(r=>r[f]&&ds.push(r[f]));}
  if(DATA.arms?.length){const f=getSNField(DATA.arms);DATA.arms.slice(0,1).forEach(r=>r[f]&&ds.push(r[f]));}
  const tot=Object.values(DATA).reduce((s,a)=>s+(a?.length||0),0);
  app().innerHTML=`${rUBar()}<div class="sch-screen"><div class="sch-bg"></div><div class="sch-c">
    <div class="logo" style="width:72px;height:72px;border-radius:20px;font-size:36px;margin-bottom:20px">üëª</div>
    <h1 style="font-size:24px;font-weight:700;letter-spacing:-.5px;margin-bottom:6px">Ghost Tracker</h1>
    <p style="color:var(--t3);font-size:14px;margin-bottom:32px;text-align:center;max-width:340px;line-height:1.5">Scan QR or type any S/N to trace assembly data</p>
    <div style="margin-bottom:16px"><span class="ds"><span class="ds-dot"></span>${tot} records</span></div>
    <div style="width:100%;max-width:400px;margin-bottom:12px"><input class="sch-in" id="si" value="${esc(S.searchInput)}" placeholder="GT418-GST-00001 or GR-1 or 240002..." autocomplete="off" spellcheck="false"></div>
    ${pv?`<div class="pp"><span style="font-size:11px;color:var(--ac);font-weight:600">${pv.inputType==='qr'?'üì∑ QR':'‚å®Ô∏è'}</span><span style="color:var(--t2)">‚Üí</span><span style="color:var(--t1);font-weight:500">${esc(pv.label)}</span></div>`:''}
    <div class="br"><button class="btn btn1" onclick="doSearch()">Search</button><button class="btn btn2" onclick="demoScan()">üì∑ Scan QR</button></div>
    <div class="fbox"><div class="fbox-t">ACCEPTED FORMATS</div>${[{f:'GT418-GST-00001',d:'Full S/N (QR)',t:'q'},{f:'MB-1, ARM-10',d:'Shorthand',t:'t'},{f:'PDB-4421, IOB-5567',d:'Sub-component',t:'t'},{f:'240002',d:'GALINA number',t:'q'}].map(x=>`<div class="frow"><span class="ftag ftag-${x.t}">${x.t==='q'?'QR':'Type'}</span><code class="fcode">${x.f}</code><span class="fdesc">${x.d}</span></div>`).join('')}</div>
    ${ds.length?`<div class="demo-s"><div class="demo-l">Try values from your sheet</div><div class="demo-chips">${ds.map(s=>`<button class="demo-c" onclick="setSI('${esc(s)}')">${esc(s)}</button>`).join('')}</div></div>`:''}
    ${S.loadErrors.length?`<div class="err-b" style="margin-top:24px;max-width:400px">‚ö† ${S.loadErrors.map(e=>e.tab).join(', ')}<code>${esc(S.loadErrors[0].error)}</code></div>`:''}
  </div></div>${rToast()}`;
  const inp=$('#si');inp?.addEventListener('input',e=>{S.searchInput=e.target.value;S.parsedPreview=parseInput(e.target.value);render();});inp?.addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});setTimeout(()=>$('#si')?.focus(),50);}

// ===== RESULT =====
function rResult(){const{result:R,tree:T}=S;if(!R||!T)return;const gSN=getRowSN(T.ghost,DATA.ghosts);
  const all=[{k:'ghost',d:T.ghost},{k:'mobileBase',d:T.mb},{k:'mbMotors',d:T.mbMotors},{k:'pillar',d:T.pl},{k:'plMotors',d:T.plMotors},{k:'headBody',d:T.hb},{k:'arm',d:T.arm},{k:'armA12',d:T.armA12},{k:'armA35',d:T.armA35},{k:'armA4',d:T.armA4},{k:'gripper',d:T.gr},{k:'deployKit',d:T.dk}];
  const mi=(R.matchedIn||'').toLowerCase().replace(/[^a-z0-9]/g,'');const mp=(R.path||[]).map(p=>p.toLowerCase().replace(/[^a-z0-9]/g,''));
  const sm={pdb:['mobilebase'],iob:['headbody','gripper'],mdb:['mbmotors','plmotors','arma12','arma35','arma4'],brk:['pillar'],bat:['arm'],galina:['headbody'],lmotor:['mbmotors','plmotors'],a12motor:['arma12'],a35motor:['arma35'],a4motor:['arma4']};
  const isM=k=>{const kl=k.toLowerCase();if(mi.includes(kl)||kl.includes(mi))return true;for(const p of mp)if(p.includes(kl)||kl.includes(p))return true;for(const[s,ts]of Object.entries(sm))if(mi.includes(s)&&ts.some(t=>kl.includes(t)))return true;return false;};
  const isGM=mi==='ghost';const matched=all.filter(s=>isM(s.k));const rest=all.filter(s=>!isM(s.k));const seen=new Set();const sorted=isGM?all:[...matched,...rest];const fin=sorted.filter(s=>{if(seen.has(s.k))return false;seen.add(s.k);return true;});
  let h='';if(!isGM&&matched.length)h+=`<div style="padding:6px 12px;margin:0 0 8px;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:10px;font-weight:700;letter-spacing:1px;background:rgba(91,110,234,.06);border:1px solid rgba(91,110,234,.1);color:var(--ac)">‚ñ≤ MATCHED</div>`;
  fin.forEach((s,i)=>{if(!isGM&&matched.length&&i===matched.length)h+=`<div style="padding:6px 12px;margin:12px 0 8px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:1px;background:rgba(255,255,255,.02);border:1px solid #14152a;color:var(--t5)">‚ñº OTHER ASSEMBLIES</div>`;h+=rSC(s.k,s.d,isM(s.k));});
  app().innerHTML=`${rUBar()}<div style="min-height:100vh"><div class="rh"><button class="rbk" onclick="goBack()">‚Üê Back</button><div class="rid">üëª ${esc(gSN)}</div><span class="rlive">LIVE</span></div>
    <div class="tbox"><div class="tbox-t">TRACE PATH</div><div class="tsteps">${R.path.map((s,i)=>`<span style="display:flex;align-items:center;gap:4px"><span class="tstep ${i===0?'tstep0':'tstepN'}">${esc(s)}</span>${i<R.path.length-1?'<span class="tarr">‚Üí</span>':''}</span>`).join('')}</div><div class="tsum"><span class="thl">${esc(S.searchInput)}</span> ‚Üí ${esc(R.matchedIn)} ‚Üí <span class="thl2">${esc(gSN)}</span></div></div>
    <div style="margin:4px 16px 4px;display:flex;gap:8px;align-items:center"><button class="dbgbtn" onclick="toggleDebug()">üîç Debug</button></div>
    ${S.showDebug?`<div class="dbg">${debugInfo}</div>`:''}
    <div class="sw">${h}</div>
    <button class="rfb ${S.refreshing?'rfS':''}" onclick="doRefresh()" title="Refresh">‚Üª</button></div>${rToast()}`;
}

function rSC(sk,data,isMS){if(!data||(Array.isArray(data)&&!data.length))return'';const c=SC[sk];if(!c)return'';const items=Array.isArray(data)?data:[data];if(!items.length)return'';const isO=S.expanded.has(sk);const lk={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'}[sk]||sk;const sf=getSNField(DATA[lk]||items);
  return`<div class="sc"><div class="sh" onclick="togSec('${sk}')" style="background:${c.bg};border-radius:${isO?'12px 12px 0 0':'12px'};border:1px solid ${c.color}${isMS?'55':'22'};border-left:${isMS?'4px solid '+c.color:'1px solid '+c.color+'22'}"><span class="si">${c.icon}</span><div class="sinfo"><div class="slbl" style="color:${c.color}">${c.label}</div><div class="ssn">${items.map(i=>esc(i[sf]||'?')).join(' ¬∑ ')}</div></div>${isMS?`<span class="mbdg" style="background:${c.color}22;color:${c.color}">MATCH</span>`:''}<span class="schv ${isO?'schvO':''}">‚ñº</span></div>${isO?items.map((item,idx)=>`<div class="fg" style="background:var(--card);border:1px solid ${c.color}15;border-top:none;border-radius:${idx===items.length-1?'0 0 12px 12px':'0'}">${items.length>1?`<div class="fgl" style="color:${c.color}">${esc(item[sf]||'?')}</div>`:''}${Object.entries(item).map(([k,v])=>rFR(sk,item[sf]||'',k,v,lk)).join('')}</div>`).join(''):''}</div>`;}

function rFR(sec,sn,field,value,lk){if(shouldSkipField(field))return'';const label=FIELD_LABELS[field]||field;const val=getV(sec,field);const isSN=field===getSNField(DATA[lk]||[])||/S\/N$/i.test(field);const isC=val?.type==='checkbox';const isD=val?.type==='date';const isDr=val?.type==='dropdown';const isH=S.result?.matchedSN===value||(S.result?.matchedSN===sn&&field===getSNField(DATA[lk]||[]));
  const eid=regEdit(sec,sn,field,value||'');
  let vH;if(isC){const p=value==='‚úì'||/^(TRUE|true|1|OK)$/.test(value);vH=`<span class="ckd ${p?'ckP':'ckF'}">${p?'‚úì':'‚úó'}</span>`;}else{vH=`<span class="fv ${isSN?'fvsn':''}">${esc(value||'‚Äî')}</span>`;}
  return`<div class="fr ${isH?'frH':''}" onclick="doEdit(${eid})"><div class="fl"><span class="flbl">${esc(label)}</span>${isDr?'<span class="ib ib-l">‚ñæ</span>':''}${isC?'<span class="ib ib-c">‚òê</span>':''}${isD?'<span class="ib ib-d">üìÖ</span>':''}</div><div class="frt">${vH}<span class="fei">‚úé</span></div></div>`;}

// ===== EDIT =====
function rEdit(){const{editing:E,editValue:ev}=S;if(!E)return;const label=FIELD_LABELS[E.field]||E.field;const c=SC[E.section];const val=getV(E.section,E.field);const isDr=val?.type==='dropdown';const isC=val?.type==='checkbox';const isD=val?.type==='date';const ch=ev!==E.value&&ev!=='';
  let iH='';
  if(isDr)iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">SELECT VALUE</div><div style="display:flex;flex-direction:column;gap:4px">${val.options.map(o=>{const s=ev===o,cu=E.value===o;return`<div class="do ${s?'doS':''}" onclick="setEV('${escA(o)}')"><div class="doi"><div class="dor ${s?'dorS':''}">${s?'<div class="dorD"></div>':''}</div><span class="dot ${s?'dotS':''}">${esc(o)}</span></div>${cu?'<span class="doCur">CURRENT</span>':''}</div>`;}).join('')}</div></div>`;
  else if(isC)iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:12px">TOGGLE</div><div style="display:flex;gap:12px">${['‚úì','‚úó'].map(v=>{const s=ev===v,p=v==='‚úì',col=p?'var(--grn)':'var(--red)',bg=p?'rgba(52,211,153,.1)':'rgba(248,113,113,.1)';return`<div style="flex:1;padding:24px 16px;border-radius:14px;cursor:pointer;text-align:center;border:${s?'2px solid '+col:'1px solid var(--bd)'};background:${s?bg:'var(--inp)'}" onclick="setEV('${v}')"><div style="width:56px;height:56px;border-radius:16px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:${s?col+'22':'rgba(255,255,255,.03)'};border:2px solid ${s?col:'var(--bd2)'};color:${s?col:'var(--t5)'}">${v}</div><div style="font-size:14px;font-weight:600;color:${s?col:'var(--t4)'}">${p?'Pass':'Fail'}</div></div>`;}).join('')}</div></div>`;
  else if(isD){const dv=(ev||'').replace(/\//g,'-');iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">DATE</div><input type="date" class="edin" id="edi" value="${dv}"><div class="dqb"><button class="dqbb" onclick="setToday()">Today</button><button class="dqbb" onclick="setYest()">Yesterday</button></div></div>`;}
  else iH=`<div style="width:100%;max-width:380px"><div style="font-size:10px;color:var(--t5);font-weight:600;letter-spacing:1px;margin-bottom:8px">NEW VALUE</div><input type="text" class="etin" id="eti" value="${escA(ev)}"></div>`;
  app().innerHTML=`<div class="escreen"><div class="eh"><button class="ecn" onclick="goBack()">Cancel</button><span style="font-size:14px;font-weight:600">Edit Field</span><button class="esv" onclick="saveEdit()">Save ‚úì</button></div><div class="ebody"><div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:${c?c.color+'10':'var(--inp)'};border:1px solid ${c?c.color+'22':'var(--bd)'}"><span>${c?.icon||'üìã'}</span><span style="font-size:12px;color:${c?.color||'var(--t3)'};font-weight:600">${c?.label||E.section}</span></div><div style="font-size:11px;color:var(--t5);font-family:var(--fm);margin:6px 0 20px">${esc(E.sn)}</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:16px"><span style="font-size:15px;color:#b0b4cc;font-weight:500">${esc(label)}</span></div><div class="eold">${esc(E.value||'empty')}</div>${iH}<button class="savb ${ch?'savA':'savI'}" onclick="saveEdit()">${ch?'Save to Sheet':'No changes'}</button><p style="margin-top:14px;font-size:11px;color:var(--t6);text-align:center">Updates via Google Sheets API</p></div></div>${rToast()}`;
  const ti=$('#eti');if(ti){ti.addEventListener('input',e=>{S.editValue=e.target.value;});ti.addEventListener('keydown',e=>{if(e.key==='Enter')saveEdit();});setTimeout(()=>ti.focus(),50);}
  const di=$('#edi');if(di)di.addEventListener('change',e=>{S.editValue=e.target.value.replace(/-/g,'/');});}

function rToast(){if(!S.toast)return'';return`<div class="toast toast-${S.toast.type}">${esc(S.toast.msg)}</div>`;}

// ===== ACTIONS =====
function doSearch(){if(!S.searchInput.trim())return;const r=traceToGhost(S.searchInput);if(r){S.result=r;S.tree=getGhostTree(r.ghost);const ek=new Set(['ghost']);const mt=r.parsed?.type||'';const ts={ghost:['ghost'],mobileBase:['mobileBase'],pillar:['pillar'],headBody:['headBody'],arm:['arm'],gripper:['gripper'],deployKit:['deployKit'],lMotor:['mbMotors','plMotors'],a12Motor:['armA12'],a35Motor:['armA35'],a4Motor:['armA4'],pdb:['mobileBase'],iob:['headBody','gripper'],mdb:['mbMotors','plMotors','armA12','armA35','armA4'],brk:['pillar'],bat:['arm'],galina:['headBody']};(ts[mt]||[]).forEach(s=>ek.add(s));S.expanded=ek;S.screen='result';}else{showToast(`No match for "${S.searchInput}"`,'error');}render();}
function demoScan(){S.scanning=true;render();let d='GT418-GST-00001';if(DATA.ghosts?.length){const f=getSNField(DATA.ghosts);d=DATA.ghosts[0][f]||d;}setTimeout(()=>{S.searchInput=d;S.scanning=false;setTimeout(()=>doSearch(),300);},1800);}
function setSI(v){S.searchInput=v;S.parsedPreview=parseInput(v);render();}
function togSec(k){S.expanded.has(k)?S.expanded.delete(k):S.expanded.add(k);render();}
function toggleDebug(){S.showDebug=!S.showDebug;render();}
function startEdit(sec,sn,field,value){S.editing={section:sec,sn,field,value};S.editValue=value||'';S.screen='edit';render();}
function setEV(v){S.editValue=v;render();}
function setToday(){const d=new Date();S.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
function setYest(){const d=new Date();d.setDate(d.getDate()-1);S.editValue=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;render();}
async function saveEdit(){
  if(!S.editing||S.editValue===S.editing.value)return;
  const{section,sn,field}=S.editing;
  const newVal=S.editValue;
  const label=FIELD_LABELS[field]||field;

  // Map section to DATA key
  const secToKey={ghost:'ghosts',mobileBase:'mobileBases',pillar:'pillars',headBody:'headBodies',arm:'arms',gripper:'grippers',deployKit:'deployKits',mbMotors:'lMotors',plMotors:'lMotors',armA12:'a12Motors',armA35:'a35Motors',armA4:'a4Motors'};
  const dataKey=secToKey[section];
  if(!dataKey||!SHEET_META[dataKey]){showToast('Cannot find sheet metadata','error');return;}

  const meta=SHEET_META[dataKey];
  const rows=DATA[dataKey];
  if(!rows){showToast('No data loaded','error');return;}

  // Find the row by matching S/N
  const sf=getSNField(rows);
  const row=rows.find(r=>(r[sf]||'').toUpperCase().trim()===sn.toUpperCase().trim());
  if(!row){showToast('Row not found','error');return;}

  // Find column index from headers
  const colIdx=meta.headers.indexOf(field);
  if(colIdx===-1){showToast('Column not found','error');return;}

  // Calculate sheet cell reference using stored original row index
  // Sheet row = startRow (header rows) + 1 (1-indexed) + _rowIdx
  const sheetRow=meta.startRow+1+row._rowIdx;
  // Column letter (A=0, B=1, ..., Z=25, AA=26, ...)
  function colLetter(n){let s='';while(n>=0){s=String.fromCharCode(65+(n%26))+s;n=Math.floor(n/26)-1;}return s;}
  const colL=colLetter(colIdx);
  const cellRef=`${meta.tabName}!${colL}${sheetRow}`;

  // Show saving state
  showToast(`Saving ${label}...`);

  try{
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(cellRef)}?valueInputOption=USER_ENTERED`;
    const resp=await fetch(url,{
      method:'PUT',
      headers:{'Authorization':`Bearer ${accessToken}`,'Content-Type':'application/json'},
      body:JSON.stringify({range:cellRef,majorDimension:'ROWS',values:[[newVal]]})
    });
    if(!resp.ok){const e=await resp.text().catch(()=>'');let msg=`HTTP ${resp.status}`;try{msg=JSON.parse(e).error?.message||msg;}catch{}throw new Error(msg);}

    // Update local data
    row[field]=newVal;
    showToast(`‚úì ${label}: ${newVal}`);
    S.screen='result';S.editing=null;
    // Rebuild tree with updated data
    if(S.result?.ghost){S.tree=getGhostTree(S.result.ghost);}
    render();
  }catch(err){
    console.error('Save failed:',err);
    showToast(`Save failed: ${err.message}`,'error');
  }
}
function goBack(){if(S.screen==='edit'){S.screen='result';S.editing=null;}else{S.screen='search';S.searchInput='';S.result=null;S.tree=null;S.parsedPreview=null;S.showDebug=false;}render();}
async function doRefresh(){S.refreshing=true;render();S.loadErrors=await loadAllData((l,t,c)=>{LP={l,t,c};});S.refreshing=false;showToast('Data refreshed');render();}
function showToast(msg,type='success'){S.toast={msg,type};render();setTimeout(()=>{S.toast=null;render();},3000);}

// ===== INIT =====
window.onload=function(){render();
  function initGA(){if(typeof google==='undefined'||!google.accounts){setTimeout(initGA,200);return;}
    tokenClient=google.accounts.oauth2.initTokenClient({client_id:CONFIG.CLIENT_ID,scope:CONFIG.SCOPES,callback:r=>{if(r.access_token){accessToken=r.access_token;localStorage.setItem('gat',accessToken);fetchUser();}}});
    const su=localStorage.getItem('gau'),st=localStorage.getItem('gat');
    if(su&&st){currentUser=JSON.parse(su);accessToken=st;if(CONFIG.APPROVED_USERS[currentUser.email])valToken();else doLogout();}
  }initGA();};
</script>
</body>
</html>
